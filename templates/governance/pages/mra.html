{% extends "governance/base.html" %}
{% load i18n %}
{% load static %}
{% block title %}Risk Assessment{% endblock %}

{% block extra_head %}
<style>
        /* Custom styles for gradients and complex components that Tailwind doesn't support natively */
        




        /* Section visibility control (used by JavaScript) */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .tools-section {
            display: none;
        }
        .tools-section.active {
            display: block;
        }
        #tools-sections-container {
            display: none;
        }
        #tools-sections-container:has(.tools-section.active) {
            display: block;
        }
        #test-panel-container {
            display: none;
        }
        #test-panel-container.active {
            display: block;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }


        /* Severity dots for Gravity and Probability */
        .severity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .severity-dot.critical {
            background: #B91C1C;
        }
        .severity-dot.major {
            background: #DC2626;
        }
        .severity-dot.important {
            background: #F97316;
        }
        .severity-dot.moderate {
            background: #FBBF24;
        }
        .severity-dot.acceptable {
            background: #22C55E;
        }

        /* Chart point styles */
        .chart-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #1a1a2e;
            border: 2px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .chart-point-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #1a1a2e;
            white-space: nowrap;
            margin-top: 4px;
        }

        /* Gravity and Probability cell styles */
        .gravity-cell,
        .probability-cell {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Legend styles */
        .legend-section {
            margin-bottom: 1.75rem;
        }

        .legend-section:last-child {
            margin-bottom: 0;
        }

        .legend-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 0.75rem;
        }
    </style>
{% endblock %}

{% block dashboard_content %}
<div class="flex flex-col gap-6 min-h-full">
        <!-- Breadcrumb Navigation -->
        <div class="flex items-center gap-3 pb-2">
            <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center"
                onclick="history.back()">
                <img src="{% static 'governance/img/arrow-left.svg' %}" alt="Back" class="w-3.5 h-3.5">
            </button>
            <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center"
                onclick="history.forward()">
                <img src="{% static 'governance/img/arrow-right-gray.svg' %}" alt="Forward" class="w-3.5 h-3.5">
            </button>
            <span class="text-sm font-semibold text-[#F13D30]">Risk Assessment</span>
        </div>

        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-semibold text-[#1a1a2e] mb-2">Risk Assessment Tools & APIs</h1>
            <p class="text-base text-[#565F6C]">Automated tools and integrations for AI risk assessment</p>
        </div>

        <!-- Stats Bar -->
        <div class="flex gap-8 justify-center mb-8 p-4 bg-white rounded-xl border border-[rgba(181,188,196,0.5)]">
            <div class="text-center">
                <div class="text-4xl font-bold text-[#F13D30]">75</div>
                <div class="text-sm text-[#565F6C]">Total Tools</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-bold text-[#F13D30]">24</div>
                <div class="text-sm text-[#565F6C]">APIs</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-bold text-[#F13D30]">20</div>
                <div class="text-sm text-[#565F6C]">Libraries</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-bold text-[#F13D30]">11</div>
                <div class="text-sm text-[#565F6C]">Categories</div>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="flex gap-2 flex-wrap justify-center mb-8" id="main-tabs-mra">
            <div class="px-4 py-2 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg cursor-pointer transition-all text-sm tab active hover:border-[#F13D30]" onclick="showSectionMRA('overview')" data-section="overview">üìä Overview</div>
        </div>

        <!-- Overview Section (Risk Registry Content) -->
        <div id="overview-section" class="content-section active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-[#1a1a2e]">Risks Registry</h2>
                <button class="flex items-center gap-2 px-4 py-2 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg text-sm font-medium cursor-pointer transition-all hover:bg-[#f9fafb]">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Export
                </button>
            </div>

            <!-- Overview Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_1.5fr] gap-6 mb-6">
                <!-- Overview Card -->
                <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-base font-semibold text-[#1a1a2e]">Overview</span>
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF3C7] text-[#92400E] border border-[#FDE68A]">
                            <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>
                            Important
                        </span>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-[#565F6C]">Model risks</span>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                    <div class="h-full rounded-[4px] w-[90%]" style="background: linear-gradient(90deg, #B91C1C 0%, #DC2626 100%);"></div>
                                </div>
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEE2E2] text-[#991B1B] border border-[#FECACA]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#991B1B]"></span>
                                    Major
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-[#565F6C]">Industry risks</span>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                    <div class="h-full rounded-[4px] w-[70%]" style="background: linear-gradient(90deg, #DC2626 0%, #F97316 100%);"></div>
                                </div>
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF3C7] text-[#92400E] border border-[#FDE68A]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>
                                    Important
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-[#565F6C]">Function risks</span>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                    <div class="h-full rounded-[4px] w-[50%]" style="background: linear-gradient(90deg, #F97316 0%, #FBBF24 100%);"></div>
                                </div>
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF9C3] text-[#854D0E] border border-[#FEF08A]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#854D0E]"></span>
                                    Moderate
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-[#565F6C]">System type risks</span>
                            <div class="flex items-center gap-3">
                                <div class="w-24 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                    <div class="h-full rounded-[4px] w-[35%]" style="background: linear-gradient(90deg, #FBBF24 0%, #FCD34D 100%);"></div>
                                </div>
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#DCFCE7] text-[#166534] border border-[#BBF7D0]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#166534]"></span>
                                    Acceptable
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend Card -->
                <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-base font-semibold text-[#1a1a2e]">Legend</span>
                    </div>

                    <div class="mb-7 last:mb-0">
                        <div class="text-sm font-semibold text-[#1a1a2e] mb-3">Gravity</div>
                        <div class="flex gap-5 flex-wrap items-center">
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEF9C3] text-[#854D0E]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#854D0E]"></span>1
                                </span>
                                Negligible
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEF3C7] text-[#92400E]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>2
                                </span>
                                Significant
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FFEDD5] text-[#9A3412]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#9A3412]"></span>3
                                </span>
                                Serious
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEE2E2] text-[#991B1B]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#991B1B]"></span>4
                                </span>
                                Major
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEE2E2] text-[#7F1D1D]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#7F1D1D]"></span>5
                                </span>
                                Unacceptable
                            </div>
                        </div>
                    </div>

                    <div class="mb-7 last:mb-0">
                        <div class="text-sm font-semibold text-[#1a1a2e] mb-3">Probability</div>
                        <div class="flex gap-5 flex-wrap items-center">
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEF9C3] text-[#854D0E]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#854D0E]"></span>1
                                </span>
                                Unlikely
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEF3C7] text-[#92400E]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>2
                                </span>
                                Rare
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FFEDD5] text-[#9A3412]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#9A3412]"></span>3
                                </span>
                                Likely
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEE2E2] text-[#991B1B]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#991B1B]"></span>4
                                </span>
                                Frequent
                            </div>
                            <div class="flex items-center gap-2 text-sm text-[#565F6C]">
                                <span class="inline-flex items-center justify-center gap-1 px-2 py-0.5 rounded text-sm font-medium bg-[#FEE2E2] text-[#7F1D1D]">
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#7F1D1D]"></span>5
                                </span>
                                Always
                            </div>
                        </div>
                    </div>

                    <div class="mb-7 last:mb-0">
                        <div class="text-sm font-semibold text-[#1a1a2e] mb-3">Impact/Risk</div>
                        <div class="flex h-4 rounded overflow-hidden my-3 mb-2">
                            <div class="flex-1" style="background: linear-gradient(90deg, #D9D58E 0%, #E5C76D 100%);"></div>
                            <div class="flex-1" style="background: linear-gradient(90deg, #E5C76D 0%, #E8A94D 100%);"></div>
                            <div class="flex-1" style="background: linear-gradient(90deg, #E8A94D 0%, #D15B3E 100%);"></div>
                            <div class="flex-1" style="background: linear-gradient(90deg, #D15B3E 0%, #A31919 100%);"></div>
                            <div class="flex-1" style="background: linear-gradient(90deg, #A31919 0%, #7F1D1D 100%);"></div>
                        </div>
                        <div class="flex justify-between text-xs text-[#565F6C]">
                            <span class="flex-1 text-left">Acceptable</span>
                            <span class="flex-1 text-center">Moderate</span>
                            <span class="flex-1 text-center">Important</span>
                            <span class="flex-1 text-center">Major</span>
                            <span class="flex-1 text-right">High risks</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Tabs -->
            <div class="flex bg-[#f3f4f6] rounded-lg p-1 mb-6">
                <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm bg-white text-[#1a1a2e] border-none rounded-md cursor-pointer transition-all shadow-sm category-tab active" data-tab="model">
                    <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18" />
                        <path d="M9 21V9" />
                    </svg>
                    Model
                </button>
                <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm text-[#565F6C] bg-transparent border-none rounded-md cursor-pointer transition-all hover:text-[#1a1a2e] category-tab" data-tab="industry">
                    <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18" />
                        <path d="M9 21V8a3 3 0 0 1 3-3h0a3 3 0 0 1 3 3v13" />
                        <path d="M4 21V11a2 2 0 0 1 2-2h1" />
                        <path d="M20 21V11a2 2 0 0 0-2-2h-1" />
                    </svg>
                    Industry
                </button>
                <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm text-[#565F6C] bg-transparent border-none rounded-md cursor-pointer transition-all hover:text-[#1a1a2e] category-tab" data-tab="function">
                    <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    Function
                </button>
                <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm text-[#565F6C] bg-transparent border-none rounded-md cursor-pointer transition-all hover:text-[#1a1a2e] category-tab" data-tab="system">
                    <svg class="w-[18px] h-[18px]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                        <line x1="8" y1="21" x2="16" y2="21" />
                        <line x1="12" y1="17" x2="12" y2="21" />
                    </svg>
                    System Type
                </button>
            </div>

            <!-- Model Risks Table -->
            <div id="tab-model" class="tab-content active">
                <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-base font-semibold text-[#1a1a2e]">Model Risks</span>
                        <span class="cursor-pointer text-[#565F6C]">‚ãÆ</span>
                    </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4 text-xs font-medium text-[#565F6C] border-b border-[rgba(181,188,196,0.5)]">Category</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-[#565F6C] border-b border-[rgba(181,188,196,0.5)]">Gravity</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-[#565F6C] border-b border-[rgba(181,188,196,0.5)]">Probability</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-[#565F6C] border-b border-[rgba(181,188,196,0.5)]">Risk Level</th>
                                <th class="text-left py-3 px-4 text-xs font-medium text-[#565F6C] border-b border-[rgba(181,188,196,0.5)]"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">Cyber</td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="gravity-cell">
                                        <span class="severity-dot major"></span> 4
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="probability-cell">
                                        <span class="severity-dot important"></span> 3
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 85%; background: linear-gradient(90deg, #DC2626 0%, #F97316 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF3C7] text-[#92400E] border border-[#FDE68A]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>
                                        Important
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">Env & Social</td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="gravity-cell">
                                        <span class="severity-dot major"></span> 4
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="probability-cell">
                                        <span class="severity-dot major"></span> 4
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 100%; background: linear-gradient(90deg, #DC2626 0%, #F97316 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEE2E2] text-[#991B1B] border border-[#FECACA]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#991B1B]"></span>
                                        Major
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">Health Safety</td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="gravity-cell">
                                        <span class="severity-dot important"></span> 3
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="probability-cell">
                                        <span class="severity-dot major"></span> 4
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 85%; background: linear-gradient(90deg, #DC2626 0%, #F97316 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF3C7] text-[#92400E] border border-[#FDE68A]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#92400E]"></span>
                                        Important
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">Technical</td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="gravity-cell">
                                        <span class="severity-dot moderate"></span> 2
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="probability-cell">
                                        <span class="severity-dot acceptable"></span> 1
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 35%; background: linear-gradient(90deg, #FBBF24 0%, #22C55E 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#FEF9C3] text-[#854D0E] border border-[#FEF08A]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#854D0E]"></span>
                                        Moderate
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">Fundamental Rights</td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="gravity-cell">
                                        <span class="severity-dot moderate"></span> 2
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="probability-cell">
                                        <span class="severity-dot moderate"></span> 2
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 35%; background: linear-gradient(90deg, #FBBF24 0%, #22C55E 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm border-b border-[rgba(181,188,196,0.5)]">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#DCFCE7] text-[#166534] border border-[#BBF7D0]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#166534]"></span>
                                        Acceptable
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4 text-sm">Legal</td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="gravity-cell">
                                        <span class="severity-dot moderate"></span> 2
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="probability-cell">
                                        <span class="severity-dot moderate"></span> 2
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <div class="w-20 h-2 bg-[#f3f4f6] rounded overflow-hidden">
                                        <div class="h-full rounded-[4px]" style="width: 35%; background: linear-gradient(90deg, #FBBF24 0%, #22C55E 100%);"></div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-[#DCFCE7] text-[#166534] border border-[#BBF7D0]">
                                        <span class="w-1.5 h-1.5 rounded-full bg-[#166534]"></span>
                                        Acceptable
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cartography of Risks -->
            <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6 mt-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-base font-semibold text-[#1a1a2e]">Cartography of Risks</span>
                    <span class="cursor-pointer text-[#565F6C]">‚ãÆ</span>
                </div>
                <div class="flex gap-4 py-4">
                    <div class="flex items-center gap-2">
                        <div class="text-xs text-[#565F6C] font-medium" style="writing-mode: vertical-lr; transform: rotate(180deg);">
                            <span>Probability</span>
                        </div>
                        <div class="flex flex-col justify-between h-[300px] text-xs text-[#565F6C] py-2.5">
                            <span>5</span>
                            <span>4</span>
                            <span>3</span>
                            <span>2</span>
                            <span>1</span>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="flex-1 h-[300px] rounded-lg relative" style="background: linear-gradient(90deg, #22C55E 0%, #FBBF24 25%, #F97316 50%, #DC2626 100%);">
                            <div class="absolute w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2" style="left: 50%; top: 8%;"></div>
                            <div class="absolute w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2" style="left: 82%; top: 8%;"></div>
                            <div class="absolute w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2" style="left: 82%; top: 35%;"></div>
                            <div class="absolute -translate-x-1/2 -translate-y-1/2" style="left: 35%; top: 60%;">
                                <div class="w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2"></div>
                                <span class="absolute top-full left-1/2 -translate-x-1/2 text-[0.65rem] text-[#1a1a2e] whitespace-nowrap mt-1">Reputation</span>
                            </div>
                            <div class="absolute w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2" style="left: 12%; top: 88%;"></div>
                            <div class="absolute w-3 h-3 bg-[#1a1a2e] border-2 border-white rounded-full -translate-x-1/2 -translate-y-1/2" style="left: 42%; top: 88%;"></div>
                        </div>
                        <div class="flex justify-between text-xs text-[#565F6C] pt-2 px-2.5">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                        </div>
                        <div class="text-center text-xs text-[#565F6C] font-medium mt-2">Gravity</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Sections Container -->
        <div id="tools-sections-container"></div>

        <!-- API Test Panel -->
        <div id="test-panel-container" class="tools-section">
            <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6 mt-8">
                <h3 class="mb-4 flex items-center gap-2">üß™ Live API Test Console</h3>
                <p class="text-[#565F6C] text-sm mb-4">
                    üî¥ Real APIs connected - Results are live data | üü¢ Local = instant analysis
                </p>
                <div class="flex gap-4 mb-4">
                    <select id="api-category" onchange="filterAPIs()" class="flex-1 px-3 py-3 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg text-[#1a1a2e] font-['Montserrat',sans-serif]">
                        <option value="all">All Categories</option>
                        <!-- Dynamically populated from risk_tools.json -->
                    </select>
                    <select id="test-api" onchange="updatePlaceholder()" class="flex-1 px-3 py-3 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg text-[#1a1a2e] font-['Montserrat',sans-serif]">
                        <!-- Dynamically populated from risk_tools.json -->
                    </select>
                </div>
                <div class="mb-4">
                    <textarea id="test-input" placeholder="Enter text to analyze..." class="w-full min-h-20 px-3 py-3 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg text-[#1a1a2e] font-['Montserrat',sans-serif] resize-y">password123</textarea>
                </div>
                <div class="flex gap-2 mb-4">
                    <button class="px-6 py-3 bg-[#F31C30] text-white border-none rounded-lg cursor-pointer font-semibold font-['Montserrat',sans-serif] transition-all hover:bg-[#DC804A]" onclick="runTest()">‚ñ∂Ô∏è Run Analysis</button>
                    <button class="px-6 py-3 bg-white border border-[#F31C30] text-[#F31C30] rounded-lg cursor-pointer font-semibold font-['Montserrat',sans-serif] transition-all hover:bg-[#f9fafb]" onclick="clearResult()">üóëÔ∏è Clear</button>
                </div>
                <div class="bg-[#F1F5F9] border border-[rgba(181,188,196,0.5)] rounded-lg p-4 mt-4 min-h-[100px]">
                    <div id="test-result" class="text-[#565F6C]">Select an API and click "Run Analysis"...</div>
                </div>
            </div>
        </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        // Initialize tabs and tools when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            // Set active nav item for risk-assessment
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-nav') === 'risk-assessment') {
                    link.classList.add('active');
                }
            });

            // Initialize category tabs
            initTabs();

            // Load tools data
            loadTools();

            // Ensure Overview tab is active by default
            showSectionMRA('overview');
        });

        // Tab functionality
        function initTabs() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    document.querySelectorAll('.category-tab').forEach(t => {
                        t.classList.remove('active', 'bg-white', 'text-[#1a1a2e]', 'shadow-sm');
                        t.classList.add('bg-transparent', 'text-[#565F6C]');
                    });
                    tab.classList.add('active', 'bg-white', 'text-[#1a1a2e]', 'shadow-sm');
                    tab.classList.remove('bg-transparent', 'text-[#565F6C]');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });
                    const targetContent = document.getElementById(`tab-${targetTab}`);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        // Section switching
        function showSectionMRA(sectionId) {
            // Update tab active states - ensure consistent styling (MRA page only)
            document.querySelectorAll('#main-tabs-mra .tab').forEach(t => {
                t.classList.remove('active', 'bg-[#F13D30]', 'border-[#F13D30]', 'text-white');
                t.classList.add('bg-white', 'text-[#4B5563]', 'border-[rgba(181,188,196,0.5)]');
            });
            const activeTab = document.querySelector(`#main-tabs-mra [data-section="${sectionId}"]`);
            if (activeTab) {
                activeTab.classList.add('active', 'bg-[#F13D30]', 'border-[#F13D30]', 'text-white');
                activeTab.classList.remove('bg-white', 'text-[#4B5563]', 'border-[rgba(181,188,196,0.5)]');
            }

            // Hide all sections first
            const overviewSection = document.getElementById('overview-section');
            const toolsSectionsContainer = document.getElementById('tools-sections-container');
            const testPanel = document.getElementById('test-panel-container');
            
            // Hide overview section
            if (overviewSection) {
                overviewSection.classList.remove('active');
                overviewSection.style.display = 'none';
            }
            
            // Hide all tools sections
            document.querySelectorAll('.tools-section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            
            // Hide tools sections container and test panel initially
            if (toolsSectionsContainer) {
                toolsSectionsContainer.style.display = 'none';
            }
            if (testPanel) {
                testPanel.classList.remove('active');
                testPanel.style.display = 'none';
            }

            // Show the selected section
            if (sectionId === 'overview') {
                // Overview: Show everything - overview section, tools sections container, and test panel
                if (overviewSection) {
                    overviewSection.classList.add('active');
                    overviewSection.style.display = 'block';
                }
                // Show tools sections container (all tools visible)
                if (toolsSectionsContainer) {
                    toolsSectionsContainer.style.display = 'block';
                    // Show all tools sections
                    document.querySelectorAll('.tools-section').forEach(s => {
                        s.classList.add('active');
                        s.style.display = 'block';
                    });
                }
                // Show API test panel
                if (testPanel) {
                    testPanel.classList.add('active');
                    testPanel.style.display = 'block';
                }
            } else {
                // Non-overview tabs: Show only Tools Sections Container and API Test Panel
                // Hide overview section completely
                if (overviewSection) {
                    overviewSection.style.display = 'none';
                }
                
                // Show tools section in Tools Sections Container
                const toolsSection = document.getElementById(`section-${sectionId}`);
                if (toolsSection && toolsSectionsContainer) {
                    toolsSectionsContainer.style.display = 'block';
                    toolsSection.classList.add('active');
                    toolsSection.style.display = 'block';
                    // Scroll to tools section if needed
                    toolsSectionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Show API test panel
                if (testPanel) {
                    testPanel.classList.add('active');
                    testPanel.style.display = 'block';
                }
            }
        }

        // Load tools from JSON
        let toolsData = null;
        async function loadTools() {
            try {
                const response = await fetch("{% static 'governance/data/risk_tools.json' %}");
                toolsData = await response.json();
                renderMainTabs();
                renderToolsSections();
                renderAPIDropdowns();
            } catch (error) {
                console.error('Failed to load tools:', error);
            }
        }

        function renderAPIDropdowns() {
            if (!toolsData) return;

            // Special ID mappings for live APIs
            const apiIdMappings = {
                'URLhaus Malware URLs': 'urlhaus',
                'AbuseIPDB': 'abuseipdb',
                'OpenAI Moderation API': 'moderation',
                'Moderation API': 'moderation',
                'VirusTotal API': 'virustotal',
                'VirusTotal': 'virustotal',
                'HaveIBeenPwned API': 'pwned',
                'NVD CVE Lookup': 'cve',
                'SSL Labs API': 'ssl'
            };

            // Populate category dropdown
            const categorySelect = document.getElementById('api-category');
            if (categorySelect) {
                const categories = Object.entries(toolsData.categories);
                categories.forEach(([id, cat]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
            }

            // Populate API dropdown with all tools grouped by category
            const apiSelect = document.getElementById('test-api');
            if (apiSelect) {
                const categories = Object.entries(toolsData.categories);
                categories.forEach(([id, cat]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `${cat.icon} ${cat.name} (${cat.tools.length})`;

                    cat.tools.forEach(tool => {
                        const option = document.createElement('option');
                        option.value = apiIdMappings[tool.name] || tool.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                        option.setAttribute('data-cat', id);
                        option.textContent = tool.name;
                        optgroup.appendChild(option);
                    });

                    apiSelect.appendChild(optgroup);
                });
            }
        }

        function renderMainTabs() {
            const tabs = document.getElementById('main-tabs-mra');
            if (!tabs || !toolsData) return;
            const categories = Object.entries(toolsData.categories);
            const toolTabs = categories.map(([id, cat]) => `
                <div class="px-4 py-2 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg cursor-pointer transition-all text-sm tab hover:border-[#F13D30]" onclick="showSectionMRA('${id}')" data-section="${id}">
                    ${cat.icon} ${cat.name}
                </div>
            `).join('');
            tabs.innerHTML = `
                <div class="px-4 py-2 bg-white border border-[rgba(181,188,196,0.5)] rounded-lg cursor-pointer transition-all text-sm tab active hover:border-[#F13D30]" onclick="showSectionMRA('overview')" data-section="overview">üìä Overview</div>
                ${toolTabs}
            `;
            // Ensure Overview tab is active after rendering
            showSectionMRA('overview');
        }

        function renderToolsSections() {
            const container = document.getElementById('tools-sections-container');
            if (!container || !toolsData) return;
            const categories = Object.entries(toolsData.categories);
            container.innerHTML = categories.map(([id, cat]) => `
                <div class="tools-section" id="section-${id}">
                    <div class="flex items-center gap-4 mb-6 pb-4 border-b border-[rgba(181,188,196,0.5)]">
                        <span class="text-4xl">${cat.icon}</span>
                        <span class="text-2xl font-semibold">${cat.name}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${cat.tools.map(tool => renderToolCard(tool)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderToolCard(tool) {
            return `
                <div class="bg-white border border-[rgba(181,188,196,0.5)] rounded-xl p-6 transition-all hover:border-[#F13D30] hover:-translate-y-0.5 hover:shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div class="font-semibold">${tool.name}</div>
                        <span class="text-[0.7rem] px-2 py-1 bg-[#F31C30] text-white rounded uppercase">${tool.type}</span>
                    </div>
                    <p class="text-[#565F6C] text-sm mb-4">${tool.description}</p>
                    <div class="text-xs text-[#F13D30] mb-4">Provider: ${tool.provider}</div>
                    <div class="flex flex-wrap gap-2">
                        ${tool.capabilities.map(cap => `<span class="text-xs px-2 py-1 bg-[rgba(59,130,246,0.2)] rounded text-[#F13D30]">${cap}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        // API Test Functions
        function updatePlaceholder() {
            const api = document.getElementById('test-api').value;
            const input = document.getElementById('test-input');
            const placeholders = {
                pwned: 'password123', ip: '8.8.8.8', cve: 'CVE-2024-3094',
                pii: 'John Smith (john@email.com) SSN: 123-45-6789',
                gdpr: 'We process health records and biometric data.',
                toxicity: 'Sample text to analyze.', sentiment: 'I love this product! It works great.'
            };
            input.value = placeholders[api] ?? '';
        }

        function filterAPIs() {
            const category = document.getElementById('api-category').value;
            const select = document.getElementById('test-api');
            Array.from(select.options).forEach(opt => {
                const cat = opt.getAttribute('data-cat');
                opt.style.display = (category === 'all' || cat === category) ? '' : 'none';
            });
        }

        function clearResult() {
            document.getElementById('test-result').innerHTML = '<span style="color: #565F6C">Cleared.</span>';
        }

        // Simple API implementations
        function mask(v) { return v.length <= 4 ? '****' : v.slice(0, 2) + '*'.repeat(v.length - 4) + v.slice(-2); }

        function detectPII(text) {
            const patterns = { EMAIL: /[\w.+-]+@[\w.-]+\.\w+/g, SSN: /\d{3}-?\d{2}-?\d{4}/g, PHONE: /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g, NAME: /[A-Z][a-z]+\s[A-Z][a-z]+/g };
            const findings = [];
            for (const [type, p] of Object.entries(patterns)) {
                (text.match(p) || []).forEach(m => findings.push({ type, value: m, masked: mask(m) }));
            }
            return { status: "success", api: "üü¢ PII Detection", pii_count: findings.length, findings, risk_level: findings.length > 2 ? "HIGH" : findings.length > 0 ? "MEDIUM" : "LOW" };
        }

        async function checkPasswordBreach(password) {
            const hash = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-1', new TextEncoder().encode(password)))).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
            const resp = await fetch(`https://api.pwnedpasswords.com/range/${hash.slice(0, 5)}`);
            const count = (await resp.text()).split('\n').find(l => l.startsWith(hash.slice(5)))?.split(':')[1] || 0;
            return { status: "success", api: "üîµ HaveIBeenPwned", breached: +count > 0, breach_count: +count, risk_level: +count > 1000 ? "CRITICAL" : +count > 0 ? "HIGH" : "LOW" };
        }

        async function checkIPGeolocation(ip) {
            const data = await (await fetch(`http://ip-api.com/json/${ip}?fields=status,country,city,isp,proxy,hosting`)).json();
            if (data.status === 'fail') return { status: "error", message: "Invalid IP" };
            const risks = []; if (data.proxy) risks.push("Proxy"); if (data.hosting) risks.push("Datacenter");
            return { status: "success", api: "üîµ IP-API", location: `${data.city}, ${data.country}`, isp: data.isp, risks, risk_level: risks.length > 0 ? "MEDIUM" : "LOW" };
        }

        async function lookupCVE(cve) {
            if (!/^CVE-\d{4}-\d+$/i.test(cve)) return { status: "error", message: "Format: CVE-YYYY-NNNNN" };
            const data = await (await fetch(`https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=${cve.toUpperCase()}`)).json();
            if (!data.vulnerabilities?.length) return { status: "not_found", api: "üîµ NVD" };
            const v = data.vulnerabilities[0].cve, m = v.metrics?.cvssMetricV31?.[0]?.cvssData;
            return { status: "success", api: "üîµ NVD/NIST", cve_id: v.id, cvss_score: m?.baseScore, severity: m?.baseSeverity, risk_level: m?.baseSeverity || "UNKNOWN" };
        }

        function checkGDPR(text) {
            const sensitive = /health|biometric|genetic|racial|ethnic|political|religious|sexual/gi;
            const matches = text.match(sensitive) || [];
            return { status: "success", api: "üü¢ GDPR Check", sensitive_data: matches, dpia_required: matches.length > 0, risk_level: matches.length > 2 ? "HIGH" : matches.length > 0 ? "MEDIUM" : "LOW" };
        }

        function detectToxicity(text) {
            const patterns = { hate: /hate|racist/gi, violence: /kill|harm|threat/gi, harassment: /stupid|idiot/gi };
            let score = 0;
            for (const p of Object.values(patterns)) score += (text.match(p) || []).length;
            return { status: "success", api: "üü¢ Toxicity", score: Math.min(score * 0.2, 1), risk_level: score > 3 ? "HIGH" : score > 0 ? "MEDIUM" : "LOW" };
        }

        function analyzeSentiment(text) {
            const positive = ['love', 'great', 'excellent', 'amazing', 'wonderful', 'good', 'happy', 'best'];
            const negative = ['hate', 'terrible', 'awful', 'bad', 'worst', 'horrible', 'disappointing'];
            const posCount = positive.filter(w => text.toLowerCase().includes(w)).length;
            const negCount = negative.filter(w => text.toLowerCase().includes(w)).length;
            const sentiment = posCount > negCount ? "Positive" : negCount > posCount ? "Negative" : "Neutral";
            return { status: "success", api: "üü¢ Sentiment Analysis", positive_words: posCount, negative_words: negCount, sentiment, risk_level: sentiment === "Negative" ? "MEDIUM" : "LOW" };
        }

        // ===== API KEYS CONFIGURATION =====
        // WARNING: API keys should be configured via environment variables or secure configuration
        // DO NOT commit actual API keys to the repository
        // For production, these should be injected server-side via Django template variables
        const API_KEYS = {
            urlhaus: '', // Configure via URLHAUS_API_KEY environment variable
            abuseipdb: '', // Configure via ABUSEIPDB_API_KEY environment variable
            openai: '', // Configure via OPENAI_API_KEY environment variable
            virustotal: '' // Configure via VIRUSTOTAL_API_KEY environment variable
        };

        // CORS Proxy helper
        const CORS_PROXY = 'https://corsproxy.io/?';

        // ===== LIVE API: URLhaus Malware URL Check =====
        async function checkURLhaus(url) {
            try {
                const apiUrl = `https://urlhaus-api.abuse.ch/v1/url/`;
                const response = await fetch(CORS_PROXY + encodeURIComponent(apiUrl), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `url=${encodeURIComponent(url)}`
                });

                // Check if response is successful
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();
                if (data.query_status === 'no_results') {
                    return { status: "success", api: "üîµ URLhaus (Live)", url, threat: "Not found in database", risk_level: "LOW" };
                }
                return { status: "success", api: "üîµ URLhaus (Live)", url, threat: data.threat || "malware", url_status: data.url_status, risk_level: "CRITICAL" };
            } catch (e) {
                // Fallback to pattern-based detection
                const bad = ['.exe', '.dll', '.bat', '.cmd', '.scr', '.js', 'malware', 'phish', 'virus', 'trojan'].filter(p => url.toLowerCase().includes(p));
                return { status: "success", api: "üü° URLhaus (Pattern Detection)", url, note: "Using local pattern analysis", suspicious_patterns: bad, risk_level: bad.length > 1 ? "HIGH" : bad.length > 0 ? "MEDIUM" : "LOW" };
            }
        }

        // ===== LIVE API: AbuseIPDB IP Reputation Check =====
        async function checkAbuseIPDB(ip) {
            try {
                const apiUrl = `https://api.abuseipdb.com/api/v2/check?ipAddress=${ip}&maxAgeInDays=90`;
                const response = await fetch(CORS_PROXY + encodeURIComponent(apiUrl), {
                    headers: { 'Key': API_KEYS.abuseipdb, 'Accept': 'application/json' }
                });
                const data = await response.json();
                if (data.errors) return { status: "error", api: "üîµ AbuseIPDB", message: data.errors[0].detail };
                const d = data.data;
                return { status: "success", api: "üîµ AbuseIPDB (Live)", ip: d.ipAddress, abuse_confidence: d.abuseConfidenceScore + "%", country: d.countryCode, isp: d.isp, is_tor: d.isTor, total_reports: d.totalReports, risk_level: d.abuseConfidenceScore > 50 ? "HIGH" : "LOW" };
            } catch (e) {
                // Fallback to basic IP validation
                const isValidIP = /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
                const isPrivate = /^(10\.|172\.(1[6-9]|2\d|3[01])\.|192\.168\.)/.test(ip);
                return { status: "success", api: "üü° AbuseIPDB (Fallback)", ip, note: "Using basic validation", valid_format: isValidIP, is_private: isPrivate, risk_level: !isValidIP ? "HIGH" : isPrivate ? "LOW" : "MEDIUM" };
            }
        }

        // ===== LIVE API: OpenAI Content Moderation =====
        async function checkOpenAIModeration(text) {
            try {
                const response = await fetch('https://api.openai.com/v1/moderations', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEYS.openai}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: text })
                });
                const data = await response.json();
                if (data.error) return { status: "error", api: "üîµ OpenAI Moderation", message: data.error.message };
                const result = data.results[0];
                const categories = Object.entries(result.categories).filter(([k, v]) => v).map(([k]) => k);
                return { status: "success", api: "üîµ OpenAI Moderation (Live)", flagged: result.flagged, flagged_categories: categories, risk_level: result.flagged ? "HIGH" : "LOW" };
            } catch (e) { return { status: "error", api: "üîµ OpenAI Moderation", message: e.message }; }
        }

        // ===== LIVE API: VirusTotal Domain/URL Check =====
        async function checkVirusTotal(input) {
            try {
                const endpoint = input.startsWith('http')
                    ? `https://www.virustotal.com/api/v3/urls/${btoa(input).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '')}`
                    : `https://www.virustotal.com/api/v3/domains/${input}`;
                const response = await fetch(endpoint, { headers: { 'x-apikey': API_KEYS.virustotal } });
                const data = await response.json();
                if (data.error) return { status: "error", api: "üîµ VirusTotal", message: data.error.message };
                const stats = data.data?.attributes?.last_analysis_stats;
                const malicious = stats?.malicious || 0;
                return { status: "success", api: "üîµ VirusTotal (Live)", target: input, malicious: malicious + " detections", risk_level: malicious > 0 ? "HIGH" : "LOW" };
            } catch (e) { return { status: "error", api: "üîµ VirusTotal", message: e.message }; }
        }

        async function runTest() {
            const api = document.getElementById('test-api').value;
            const input = document.getElementById('test-input').value.trim();
            const result = document.getElementById('test-result');
            if (!input) { result.innerHTML = '‚ùå Enter input'; return; }
            result.innerHTML = '‚è≥ Processing...';
            try {
                const handlers = {
                    pwned: checkPasswordBreach, ip: checkIPGeolocation, cve: lookupCVE,
                    pii: () => detectPII(input), gdpr: () => checkGDPR(input),
                    toxicity: () => detectToxicity(input), sentiment: () => analyzeSentiment(input),
                    // Live APIs with API Keys
                    urlhaus: checkURLhaus, abuseipdb: checkAbuseIPDB,
                    moderation: checkOpenAIModeration, virustotal: checkVirusTotal
                };
                const fn = handlers[api];
                if (!fn) { result.innerHTML = `<pre style="color:#F59E0B">API "${api}" not implemented yet</pre>`; return; }
                const output = fn.constructor.name === 'AsyncFunction' ? await fn(input) : fn(input);
                const color = output.risk_level === 'CRITICAL' ? '#EF4444' : output.risk_level === 'HIGH' ? '#F59E0B' : output.status === 'error' ? '#EF4444' : '#10B981';
                result.innerHTML = `<pre style="color:${color};white-space:pre-wrap">${JSON.stringify(output, null, 2)}</pre>`;
            } catch (e) { result.innerHTML = `<pre style="color:#EF4444">Error: ${e.message}</pre>`; }
        }
    </script>
{% endblock %}
