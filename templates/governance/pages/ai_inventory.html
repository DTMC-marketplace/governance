{% extends "governance/base.html" %}
{% load static %}

{% block title %}AI Inventory{% endblock %}

{% block dashboard_content %}
<div class="flex flex-col gap-5">
    <!-- Breadcrumb Navigation -->
    <div class="flex items-center gap-3">
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.back()">
            <img src="{% static 'governance/img/arrow-left.svg' %}" alt="Back" class="w-3.5 h-3.5">
        </button>
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.forward()">
            <img src="{% static 'governance/img/arrow-right-gray.svg' %}" alt="Forward" class="w-3.5 h-3.5">
        </button>
        <span class="text-sm font-semibold text-[#F13D30]">AI Inventory</span>
    </div>

    <!-- Page Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-[#22262A] mb-1">AI Systems</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openImportModal()" class="flex items-center gap-1 px-4 py-2 border border-[#F13D30] bg-white rounded-lg text-sm font-semibold text-[#F13D30] cursor-pointer transition-all duration-200 hover:bg-[#FEF5F4]">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Import</span>
            </button>
            <button onclick="openExportModal()" class="flex items-center gap-1 px-4 py-2 border border-[#F13D30] bg-white rounded-lg text-sm font-semibold text-[#F13D30] cursor-pointer transition-all duration-200 hover:bg-[#FEF5F4]">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Alert Banner -->
    {% if systems_need_attention > 0 %}
    <div class="flex items-start gap-3 p-4 bg-[#FEF2F2] border-l-4 border-[#F13D30] rounded-lg">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#F13D30]">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 16v-4M12 8h.01" />
        </svg>
        <div class="flex-1">
            <p class="text-sm font-semibold text-[#111827] mb-1">{{ systems_need_attention }} systems need attention</p>
            <p class="text-sm text-[#6B7280]">Complete the compliance assessment for systems with "Not started" or "In progress" status</p>
        </div>
    </div>
    {% endif %}

    <!-- Action Controls & Search -->
    <div class="flex items-center justify-between gap-4">
        <!-- Left: Add New Button -->
        <div class="flex items-center">
            <button onclick="openAddSystemModal()" class="flex items-center gap-2 px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Add New</span>
            </button>
        </div>
        <!-- Right: Search, Filter, Sort -->
        <div class="flex items-center gap-3">
            <div class="relative flex-1 max-w-md">
                <input type="text" id="search-input" placeholder="Search AI systems..." 
                    class="w-full px-4 py-2 pl-10 border border-[#D1D5DB] rounded-lg text-sm text-[#374151] bg-white focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#9CA3AF]">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
            </div>
            <button onclick="openFilterModal()" class="flex items-center gap-2 px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#374151]">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                <span>Filter</span>
            </button>
            <button onclick="openSortModal()" class="flex items-center gap-2 px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#374151]">
                    <path d="M3 6h18M7 12h10M11 18h2"></path>
                </svg>
                <span>Sort</span>
            </button>
        </div>
    </div>

    <!-- Tip Banner -->
    <div class="flex items-start gap-3 p-4 bg-[#EFF6FF] border-l-4 border-[#3B82F6] rounded-lg">
        <span class="text-sm font-semibold text-[#3B82F6]">> Tip:</span>
        <p class="text-sm text-[#6B7280]">Click on any row to view details and update information</p>
    </div>

    <!-- AI Systems Table -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-[#F9FAFB] border-b border-[#E5E7EB]">
                <tr>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">AI SYSTEM NAME</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">OWNER</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">STATUS</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">ROLE</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">RISK CLASSIFICATION</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">COMPLIANCE STATUS</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">LAST UPDATED</th>
                    <th class="px-4 py-4 text-left text-xs font-semibold text-[#6B7280] uppercase tracking-wider">PROVIDER TYPE</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-[#E5E7EB]">
                {% for system in ai_systems %}
                <tr class="hover:bg-[#F9FAFB] cursor-pointer system-row" data-agent-id="{{ system.id }}">
                    <td class="px-4 py-5">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-[#111827]">{{ system.name }}</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#9CA3AF]">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </td>
                    <td class="px-4 py-5 text-sm text-[#374151]">{{ system.owner|default:"â€”" }}</td>
                    <td class="px-4 py-5">
                        <span class="px-2 py-1 text-xs font-medium rounded-full {{ system.status_badge_class }}">
                            {{ system.status }}
                        </span>
                    </td>
                    <td class="px-4 py-5 text-sm text-[#374151]">{{ system.role }}</td>
                    <td class="px-4 py-5">
                        <span class="px-2 py-1 text-xs font-medium rounded-full {{ system.risk_badge_class }}">
                            {{ system.risk_classification }}
                        </span>
                    </td>
                    <td class="px-4 py-5">
                        <span class="px-2 py-1 text-xs font-medium rounded-full {{ system.compliance_badge_class }}">
                            {{ system.compliance_status }}
                        </span>
                    </td>
                    <td class="px-4 py-5 text-sm text-[#374151]">{{ system.last_updated }}</td>
                    <td class="px-4 py-5 text-sm text-[#374151]">{{ system.provider_type }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-4 py-8 text-center text-sm text-[#6B7280]">No AI systems found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between">
        <p class="text-sm text-[#6B7280]">Showing {{ ai_systems|length }} AI systems</p>
        <div class="flex items-center gap-2">
            <button class="px-3 py-1.5 text-sm font-medium text-[#374151] border border-[#D1D5DB] rounded-lg hover:bg-[#F9FAFB] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
            <button class="px-3 py-1.5 text-sm font-medium text-white bg-[#F13D30] rounded-lg">1</button>
            <button class="px-3 py-1.5 text-sm font-medium text-[#374151] border border-[#D1D5DB] rounded-lg hover:bg-[#F9FAFB] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next</button>
        </div>
    </div>
</div>

<!-- Import AI Systems Modal -->
<div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Import AI Systems</h2>
            <button onclick="closeImportModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Need a template? Section -->
            <div class="bg-[#EFF6FF] rounded-lg p-4 border border-[#BFDBFE]">
                <div class="flex items-start gap-3">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-6 h-6 text-[#3B82F6] flex-shrink-0 mt-0.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm text-[#1E40AF] mb-3">Need a template? Download our CSV template to ensure your data is formatted correctly.</p>
                        <button onclick="downloadTemplate()" class="flex items-center gap-2 px-4 py-2 bg-[#3B82F6] text-white text-sm font-medium rounded-lg hover:bg-[#2563EB] transition-colors">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Download Template</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upload CSV File Section -->
            <div>
                <h3 class="text-base font-semibold text-[#22262A] mb-3">Upload CSV File</h3>
                <div id="csv-drop-zone" class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-12 text-center transition-colors">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-12 h-12 text-[#9CA3AF] mx-auto mb-4">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p class="text-sm font-medium text-[#374151] mb-1">Drag and drop your CSV file here</p>
                    <p class="text-sm text-[#6B7280] mb-4">or</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('csv-file-input').click()" class="flex items-center gap-2 px-4 py-2 bg-white border border-[#D1D5DB] text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors mx-auto">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Browse Files</span>
                    </button>
                </div>
                <p class="text-xs text-[#6B7280] mt-3 text-center">Supported format: CSV (max 10MB)</p>
                <div id="csv-file-info" class="hidden mt-3 p-3 bg-[#F9FAFB] rounded-lg border border-[#E5E7EB]">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#3B82F6]">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span id="csv-file-name" class="text-sm font-medium text-[#111827]"></span>
                            <span id="csv-file-size" class="text-xs text-[#6B7280]"></span>
                        </div>
                        <button onclick="removeCsvFile()" class="text-[#6B7280] hover:text-[#111827] transition-colors">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-[#E5E7EB]">
            <button onclick="closeImportModal()" class="px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                Cancel
            </button>
            <button onclick="importCsvFile()" id="import-btn" disabled class="px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Import
            </button>
        </div>
    </div>
</div>

<!-- Export AI Systems Modal -->
<div id="export-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Export AI Systems</h2>
            <button onclick="closeExportModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <!-- Icon and Heading -->
            <div class="text-center mb-6">
                <div class="flex justify-center mb-4">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#F13D30" stroke-width="2" class="w-16 h-16">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-[#22262A] mb-2">Download AI System List</h3>
                <p class="text-sm text-[#6B7280]">Export all AI systems with the information displayed on this page as a CSV file.</p>
            </div>

            <!-- Export Details -->
            <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between py-2 border-b border-[#E5E7EB]">
                    <span class="text-sm text-[#6B7280]">Total systems:</span>
                    <span class="text-sm font-semibold text-[#111827]" id="export-total-systems">{{ ai_systems|length }}</span>
                </div>
                <div class="flex items-center justify-between py-2 border-b border-[#E5E7EB]">
                    <span class="text-sm text-[#6B7280]">Format:</span>
                    <span class="text-sm font-semibold text-[#111827]">CSV</span>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-[#6B7280]">Includes:</span>
                    <span class="text-sm font-semibold text-[#111827]">All columns</span>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-[#E5E7EB]">
            <button onclick="closeExportModal()" class="px-4 py-2 border border-[#F13D30] bg-white text-[#F13D30] text-sm font-medium rounded-lg hover:bg-[#FEF5F4] transition-colors">
                Cancel
            </button>
            <button onclick="downloadExport()" class="flex items-center gap-2 px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Download</span>
            </button>
        </div>
    </div>
</div>

<!-- Filter AI Systems Modal -->
<div id="filter-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Filter AI Systems</h2>
            <button onclick="closeFilterModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <!-- Filters Selected Count -->
            <div class="flex items-center justify-between mb-6">
                <span class="text-sm text-[#6B7280]">
                    <span id="filter-count">0</span> filters selected
                </span>
                <button onclick="clearAllFilters()" class="text-sm text-[#F13D30] hover:text-[#d63529] transition-colors">
                    Clear all
                </button>
            </div>

            <!-- Filter Categories -->
            <div class="space-y-6">
                <!-- Status Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Status</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="status" value="planned">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Planned</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="status" value="in_production">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">In production</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="status" value="testing">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Testing</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="status" value="retired">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Retired</span>
                        </label>
                    </div>
                </div>

                <!-- Role Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Role</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="role" value="provider">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Provider</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="role" value="distributor">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Distributor</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="role" value="deployer">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Deployer</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="role" value="importer">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Importer</span>
                        </label>
                    </div>
                </div>

                <!-- Risk Classification Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Risk Classification</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="prohibited">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Prohibited</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="limited_transparency">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Limited transparency</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="not_assessed">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Not assessed</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="high_risk">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">High-risk</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="minimal">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Minimal</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="risk" value="not_in_scope">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Not in scope</span>
                        </label>
                    </div>
                </div>

                <!-- Compliance Status Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Compliance Status</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="compliance" value="not_started">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Not started</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="compliance" value="compliant">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Compliant</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="compliance" value="not_in_scope">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Not in scope</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="compliance" value="in_progress">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">In progress</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="compliance" value="non_compliant">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Non-compliant</span>
                        </label>
                    </div>
                </div>

                <!-- Provider Type Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Provider Type</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="provider" value="in_house">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">In-house</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="provider" value="mixed">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Mixed</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="provider" value="external">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">External</span>
                        </label>
                        <label class="filter-option flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                            <input type="checkbox" class="filter-checkbox hidden" data-category="provider" value="unknown">
                            <div class="filter-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center flex-shrink-0">
                                <svg class="hidden check-icon w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <span class="text-sm text-[#374151]">Unknown</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-[#E5E7EB]">
            <button onclick="closeFilterModal()" class="px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                Cancel
            </button>
            <button onclick="applyFilters()" class="px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors">
                Apply Filters
            </button>
        </div>
    </div>
</div>

<!-- Sort AI Systems Modal -->
<div id="sort-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Sort AI Systems</h2>
            <button onclick="closeSortModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Sort by Section -->
            <div>
                <h3 class="text-sm font-semibold text-[#111827] mb-3">Sort by</h3>
                <div class="space-y-2">
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="name" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">AI System Name</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="owner" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Owner</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="status" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Status</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="role" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Role</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="risk" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Risk Classification</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="compliance" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Compliance Status</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#F13D30] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors sort-option-selected">
                        <input type="radio" name="sort-by" value="last_updated" checked class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#3B82F6] rounded-full flex items-center justify-center flex-shrink-0 bg-white">
                            <div class="radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Last Updated</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-3 py-2.5 border border-[#D1D5DB] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="provider" class="sort-radio hidden">
                        <div class="sort-radio-display w-5 h-5 border-2 border-[#111827] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#3B82F6] rounded-full"></div>
                        </div>
                        <span class="text-sm text-[#374151]">Provider Type</span>
                    </label>
                </div>
            </div>

            <!-- Order Section -->
            <div>
                <h3 class="text-sm font-semibold text-[#111827] mb-3">Order</h3>
                <div class="flex gap-3">
                    <button onclick="setSortOrder('asc')" id="sort-asc-btn" class="flex items-center gap-2 px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                        <span>Ascending</span>
                    </button>
                    <button onclick="setSortOrder('desc')" id="sort-desc-btn" class="flex items-center gap-2 px-4 py-2 border border-[#F13D30] bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] hover:text-black transition-colors">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        <span>Descending</span>
                    </button>
                </div>
            </div>

            <!-- Preview -->
            <div class="pt-4 border-t border-[#E5E7EB]">
                <p class="text-sm text-[#6B7280]">
                    Preview: Sorting by <span id="preview-sort-by" class="font-semibold text-[#111827]">Last Updated</span> in <span id="preview-order" class="font-semibold text-[#111827]">descending</span> order.
                </p>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-[#E5E7EB]">
            <button onclick="closeSortModal()" class="px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                Cancel
            </button>
            <button onclick="applySort()" class="px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors">
                Apply Sort
            </button>
        </div>
    </div>
</div>

<!-- Add New AI System Modal -->
<div id="add-system-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Add New AI System</h2>
            <button onclick="closeAddSystemModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Tip Box -->
            <div class="bg-[#EFF6FF] rounded-lg p-4 border border-[#BFDBFE]">
                <p class="text-sm text-[#1E40AF]">
                    <span class="font-semibold">Tip:</span> Only AI system name is mandatory to create the record. Other questions are for the assessment, which could be provided later.
                </p>
            </div>

            <!-- Optional Document Upload -->
            <div>
                <label class="block text-sm font-medium text-[#374151] mb-2">(Optional) Upload Document for AI Auto-fill</label>
                <div class="flex items-center gap-3">
                    <div class="flex-1 relative">
                        <input type="file" id="add-system-file-input" accept=".pdf,.doc,.docx,.txt" class="hidden">
                        <button onclick="document.getElementById('add-system-file-input').click()" class="w-full flex items-center justify-between px-4 py-2.5 border border-[#D1D5DB] rounded-lg bg-white text-[#6B7280] text-sm hover:bg-[#F9FAFB] transition-colors">
                            <div class="flex items-center gap-2">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF]">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <span id="add-system-file-name">Choose file...</span>
                            </div>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF]">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                    <button onclick="aiReadAndAutoFill()" class="flex items-center gap-2 px-4 py-2.5 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors whitespace-nowrap">
                        <img src="{% static 'governance/img/sparkle.svg' %}" alt="Sparkle" class="w-4 h-4" style="filter: brightness(0) invert(1);">
                        <span>AI Read & Auto-fill</span>
                    </button>
                </div>
                <p class="text-xs text-[#6B7280] mt-2">Supported formats: PDF, DOC, DOCX, TXT</p>
            </div>

            <!-- Form Fields -->
            <form id="add-system-form" class="space-y-4">
                <!-- AI System Name (Mandatory) -->
                <div>
                    <label class="block text-sm font-medium text-[#374151] mb-1">
                        AI System Name <span class="text-[#F13D30]">*</span>
                    </label>
                    <input type="text" name="system_name" required placeholder="Enter AI system name" 
                        class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                </div>

                <!-- Owner and Status -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">Owner (Person / Team)</label>
                        <input type="text" name="owner" placeholder="Enter owner" 
                            class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">Status</label>
                        <div class="styled-select-wrapper">
                            <select name="status" class="styled-select">
                                <option value="planned" selected>Planned</option>
                                <option value="in_production">In production</option>
                                <option value="testing">Testing</option>
                                <option value="retired">Retired</option>
                            </select>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Role and Provider Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">Role</label>
                        <div class="styled-select-wrapper">
                            <select name="role" class="styled-select">
                                <option value="provider">Provider</option>
                                <option value="distributor">Distributor</option>
                                <option value="deployer" selected>Deployer</option>
                                <option value="importer">Importer</option>
                            </select>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">Provider Type</label>
                        <div class="styled-select-wrapper">
                            <select name="provider_type" class="styled-select">
                                <option value="in_house">In-house</option>
                                <option value="mixed">Mixed</option>
                                <option value="external">External</option>
                                <option value="unknown" selected>Unknown</option>
                            </select>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Deployment Context and EU / EEA Relevance -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">Deployment Context</label>
                        <div class="styled-select-wrapper">
                            <select name="deployment_context" class="styled-select">
                                <option value="workplace" selected>Workplace</option>
                                <option value="educational">Educational institution</option>
                                <option value="healthcare">Healthcare setting</option>
                                <option value="law_enforcement">Law enforcement / public security</option>
                                <option value="public_admin">Public administration / government service</option>
                                <option value="general_public">General public / consumer-facing</option>
                                <option value="other">Other</option>
                            </select>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-[#374151] mb-1">EU / EEA Relevance</label>
                        <div class="styled-select-wrapper">
                            <select name="eu_eea_relevance" class="styled-select">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="unknown" selected>Unknown</option>
                            </select>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-[#E5E7EB]">
            <button onclick="closeAddSystemModal()" class="px-4 py-2 border border-[#D1D5DB] bg-white text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                Cancel
            </button>
            <button onclick="createAISystem()" class="px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors">
                Create
            </button>
        </div>
    </div>
</div>

<style>
.styled-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: #fff;
    border: 1px solid #D1D5DB;
    border-radius: 0.75rem;
    padding: 0.5rem 3rem 0.5rem 0.75rem;
    width: 100%;
    color: #374151;
    font-size: 0.875rem;
    line-height: 1.4;
}
.styled-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(241, 61, 48, 0.15);
    border-color: #F13D30;
}
.styled-select-wrapper {
    position: relative;
}
.styled-select-wrapper svg {
    pointer-events: none;
}
</style>

<script>
let selectedCsvFile = null;

// Import Modal Functions
function openImportModal() {
    document.getElementById('import-modal').classList.remove('hidden');
}

function closeImportModal() {
    document.getElementById('import-modal').classList.add('hidden');
    resetImportModal();
}

function resetImportModal() {
    selectedCsvFile = null;
    document.getElementById('csv-file-input').value = '';
    document.getElementById('csv-file-info').classList.add('hidden');
    document.getElementById('import-btn').disabled = true;
    const dropZone = document.getElementById('csv-drop-zone');
    dropZone.classList.remove('border-[#F13D30]', 'bg-[#FFF5F4]');
}

function downloadTemplate() {
    // Create CSV template
    const headers = ['AI System Name', 'Owner', 'Status', 'Role', 'Risk Classification', 'Compliance Status', 'Provider Type'];
    const csvContent = headers.join(',') + '\n';
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'ai_systems_template.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function handleFileSelect(file) {
    if (!file) return;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a CSV file');
        return;
    }
    
    // Validate file size (10MB max)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        alert('File size exceeds 10MB limit');
        return;
    }
    
    selectedCsvFile = file;
    document.getElementById('csv-file-name').textContent = file.name;
    document.getElementById('csv-file-size').textContent = `(${formatFileSize(file.size)})`;
    document.getElementById('csv-file-info').classList.remove('hidden');
    document.getElementById('import-btn').disabled = false;
}

function removeCsvFile() {
    selectedCsvFile = null;
    document.getElementById('csv-file-input').value = '';
    document.getElementById('csv-file-info').classList.add('hidden');
    document.getElementById('import-btn').disabled = true;
}

function importCsvFile() {
    if (!selectedCsvFile) {
        alert('Please select a CSV file first');
        return;
    }
    
    // TODO: Implement actual import logic
    const formData = new FormData();
    formData.append('csv_file', selectedCsvFile);
    
    // Example: Send to backend
    fetch('/api/ai-inventory/import/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('AI Systems imported successfully!');
            closeImportModal();
            location.reload(); // Reload page to show new data
        } else {
            alert('Error importing: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error importing CSV file');
    });
}

// File input change handler
document.getElementById('csv-file-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    handleFileSelect(file);
});

// Drag and drop handlers
const csvDropZone = document.getElementById('csv-drop-zone');
if (csvDropZone) {
    ['dragenter', 'dragover'].forEach(evt => {
        csvDropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            csvDropZone.classList.add('border-[#F13D30]', 'bg-[#FFF5F4]');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        csvDropZone.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            csvDropZone.classList.remove('border-[#F13D30]', 'bg-[#FFF5F4]');
        });
    });

    csvDropZone.addEventListener('drop', (e) => {
        const file = e.dataTransfer?.files[0];
        handleFileSelect(file);
    });
}

// Close modal when clicking outside
document.getElementById('import-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeImportModal();
    }
});

// Export Modal Functions
function openExportModal() {
    document.getElementById('export-modal').classList.remove('hidden');
}

function closeExportModal() {
    document.getElementById('export-modal').classList.add('hidden');
}

function downloadExport() {
    // Get all AI systems data from the table
    const systems = [];
    const rows = document.querySelectorAll('tbody tr.system-row');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
            systems.push({
                name: cells[0].textContent.trim(),
                owner: cells[1].textContent.trim(),
                status: cells[2].textContent.trim(),
                role: cells[3].textContent.trim(),
                riskClassification: cells[4].textContent.trim(),
                complianceStatus: cells[5].textContent.trim(),
                lastUpdated: cells[6].textContent.trim(),
                providerType: cells[7].textContent.trim()
            });
        }
    });
    
    // Create CSV content
    const headers = ['AI System Name', 'Owner', 'Status', 'Role', 'Risk Classification', 'Compliance Status', 'Last Updated', 'Provider Type'];
    let csvContent = headers.join(',') + '\n';
    
    systems.forEach(system => {
        const row = [
            `"${system.name}"`,
            `"${system.owner}"`,
            `"${system.status}"`,
            `"${system.role}"`,
            `"${system.riskClassification}"`,
            `"${system.complianceStatus}"`,
            `"${system.lastUpdated}"`,
            `"${system.providerType}"`
        ];
        csvContent += row.join(',') + '\n';
    });
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `ai_systems_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Close modal after download
    closeExportModal();
}

// Close export modal when clicking outside
document.getElementById('export-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeExportModal();
    }
});

// Filter Modal Functions
let activeFilters = {
    status: [],
    role: [],
    risk: [],
    compliance: [],
    provider: []
};

function openFilterModal() {
    document.getElementById('filter-modal').classList.remove('hidden');
    updateFilterCount();
}

function closeFilterModal() {
    document.getElementById('filter-modal').classList.add('hidden');
}

function updateFilterCount() {
    const total = Object.values(activeFilters).flat().length;
    document.getElementById('filter-count').textContent = total;
}

function toggleFilter(checkbox) {
    const category = checkbox.dataset.category;
    const value = checkbox.value;
    
    if (checkbox.checked) {
        if (!activeFilters[category].includes(value)) {
            activeFilters[category].push(value);
        }
    } else {
        activeFilters[category] = activeFilters[category].filter(v => v !== value);
    }
    
    // Update visual state
    const display = checkbox.nextElementSibling;
    const checkIcon = display.querySelector('.check-icon');
    
    if (checkbox.checked) {
        display.classList.remove('border-[#111827]');
        display.classList.add('border-[#F13D30]', 'bg-[#F13D30]');
        checkIcon.classList.remove('hidden');
    } else {
        display.classList.remove('border-[#F13D30]', 'bg-[#F13D30]');
        display.classList.add('border-[#111827]');
        checkIcon.classList.add('hidden');
    }
    
    updateFilterCount();
}

function clearAllFilters() {
    // Reset active filters
    activeFilters = {
        status: [],
        role: [],
        risk: [],
        compliance: [],
        provider: []
    };
    
    // Uncheck all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        const display = checkbox.nextElementSibling;
        const checkIcon = display.querySelector('.check-icon');
        display.classList.remove('border-[#F13D30]', 'bg-[#F13D30]');
        display.classList.add('border-[#111827]');
        checkIcon.classList.add('hidden');
    });
    
    updateFilterCount();
}

function applyFilters() {
    const rows = document.querySelectorAll('tbody tr.system-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 8) {
            row.style.display = 'none';
            return;
        }
        
        // Get row data
        const statusText = cells[2].textContent.trim().toLowerCase();
        const roleText = cells[3].textContent.trim().toLowerCase();
        const riskText = cells[4].textContent.trim().toLowerCase();
        const complianceText = cells[5].textContent.trim().toLowerCase();
        const providerText = cells[7].textContent.trim().toLowerCase();
        
        // Normalize values for matching
        const statusMap = {
            'planned': 'planned',
            'in production': 'in_production',
            'testing': 'testing',
            'retired': 'retired'
        };
        
        const roleMap = {
            'provider': 'provider',
            'distributor': 'distributor',
            'deployer': 'deployer',
            'importer': 'importer'
        };
        
        const riskMap = {
            'prohibited': 'prohibited',
            'limited transparency': 'limited_transparency',
            'not assessed': 'not_assessed',
            'high-risk': 'high_risk',
            'minimal': 'minimal',
            'not in scope': 'not_in_scope'
        };
        
        const complianceMap = {
            'not started': 'not_started',
            'compliant': 'compliant',
            'not in scope': 'not_in_scope',
            'in progress': 'in_progress',
            'non-compliant': 'non_compliant'
        };
        
        const providerMap = {
            'in-house': 'in_house',
            'mixed': 'mixed',
            'external': 'external',
            'unknown': 'unknown'
        };
        
        // Check if row matches filters
        let matches = true;
        
        if (activeFilters.status.length > 0) {
            const rowStatus = statusMap[statusText] || statusText.replace(/\s+/g, '_');
            matches = matches && activeFilters.status.includes(rowStatus);
        }
        
        if (activeFilters.role.length > 0 && matches) {
            const rowRole = roleMap[roleText] || roleText;
            matches = matches && activeFilters.role.includes(rowRole);
        }
        
        if (activeFilters.risk.length > 0 && matches) {
            const rowRisk = riskMap[riskText] || riskText.replace(/\s+/g, '_');
            matches = matches && activeFilters.risk.includes(rowRisk);
        }
        
        if (activeFilters.compliance.length > 0 && matches) {
            const rowCompliance = complianceMap[complianceText] || complianceText.replace(/\s+/g, '_');
            matches = matches && activeFilters.compliance.includes(rowCompliance);
        }
        
        if (activeFilters.provider.length > 0 && matches) {
            const rowProvider = providerMap[providerText] || providerText;
            matches = matches && activeFilters.provider.includes(rowProvider);
        }
        
        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update pagination text
    const paginationText = document.querySelector('.flex.items-center.justify-between p');
    if (paginationText) {
        paginationText.textContent = `Showing ${visibleCount} AI systems`;
    }
    
    closeFilterModal();
}

// Initialize filter checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleFilter(this);
        });
        
        // Also handle click on label
        const label = checkbox.closest('label');
        if (label) {
            label.addEventListener('click', function(e) {
                if (e.target !== checkbox && e.target !== checkbox.nextElementSibling) {
                    checkbox.click();
                }
            });
        }
    });
});

// Close filter modal when clicking outside
document.getElementById('filter-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeFilterModal();
    }
});

// Sort Modal Functions
let currentSortBy = 'last_updated';
let currentSortOrder = 'desc';

function openSortModal() {
    document.getElementById('sort-modal').classList.remove('hidden');
    updateSortPreview();
}

function closeSortModal() {
    document.getElementById('sort-modal').classList.add('hidden');
}

function setSortOrder(order) {
    currentSortOrder = order;
    const ascBtn = document.getElementById('sort-asc-btn');
    const descBtn = document.getElementById('sort-desc-btn');
    
    // Remove existing hover listeners
    ascBtn.onmouseenter = null;
    ascBtn.onmouseleave = null;
    descBtn.onmouseenter = null;
    descBtn.onmouseleave = null;
    
    if (order === 'asc') {
        // Active button: red background, white text, red border
        ascBtn.classList.remove('border-[#D1D5DB]', 'bg-white', 'text-[#374151]', 'hover:bg-[#F9FAFB]');
        ascBtn.classList.add('border-[#F13D30]', 'bg-[#F13D30]', 'text-white');
        // Add hover listeners for active button
        ascBtn.onmouseenter = () => {
            ascBtn.style.color = '#111827';
            ascBtn.querySelector('svg').style.color = '#111827';
        };
        ascBtn.onmouseleave = () => {
            ascBtn.style.color = '';
            ascBtn.querySelector('svg').style.color = '';
        };
        
        // Inactive button: white background, grey text, grey border
        descBtn.classList.remove('border-[#F13D30]', 'bg-[#F13D30]', 'text-white');
        descBtn.classList.add('border-[#D1D5DB]', 'bg-white', 'text-[#374151]', 'hover:bg-[#F9FAFB]');
        descBtn.style.color = '';
        descBtn.querySelector('svg').style.color = '';
    } else {
        // Active button: red background, white text, red border
        descBtn.classList.remove('border-[#D1D5DB]', 'bg-white', 'text-[#374151]', 'hover:bg-[#F9FAFB]');
        descBtn.classList.add('border-[#F13D30]', 'bg-[#F13D30]', 'text-white');
        // Add hover listeners for active button
        descBtn.onmouseenter = () => {
            descBtn.style.color = '#111827';
            descBtn.querySelector('svg').style.color = '#111827';
        };
        descBtn.onmouseleave = () => {
            descBtn.style.color = '';
            descBtn.querySelector('svg').style.color = '';
        };
        
        // Inactive button: white background, grey text, grey border
        ascBtn.classList.remove('border-[#F13D30]', 'bg-[#F13D30]', 'text-white');
        ascBtn.classList.add('border-[#D1D5DB]', 'bg-white', 'text-[#374151]', 'hover:bg-[#F9FAFB]');
        ascBtn.style.color = '';
        ascBtn.querySelector('svg').style.color = '';
    }
    
    updateSortPreview();
}

function updateSortPreview() {
    const sortByLabels = {
        'name': 'AI System Name',
        'owner': 'Owner',
        'status': 'Status',
        'role': 'Role',
        'risk': 'Risk Classification',
        'compliance': 'Compliance Status',
        'last_updated': 'Last Updated',
        'provider': 'Provider Type'
    };
    
    const orderLabels = {
        'asc': 'ascending',
        'desc': 'descending'
    };
    
    document.getElementById('preview-sort-by').textContent = sortByLabels[currentSortBy] || currentSortBy;
    document.getElementById('preview-order').textContent = orderLabels[currentSortOrder] || currentSortOrder;
}

function toggleSortOption(radio) {
    currentSortBy = radio.value;
    
    // Update visual state for all options
    document.querySelectorAll('.sort-option').forEach(option => {
        const optionRadio = option.querySelector('.sort-radio');
        const radioDisplay = option.querySelector('.sort-radio-display');
        const radioDot = radioDisplay.querySelector('.radio-dot');
        
        if (optionRadio.checked) {
            option.classList.add('sort-option-selected');
            option.classList.remove('border-[#D1D5DB]');
            option.classList.add('border-[#F13D30]');
            radioDisplay.classList.remove('border-[#111827]');
            radioDisplay.classList.add('border-[#3B82F6]');
            radioDot.classList.remove('hidden');
        } else {
            option.classList.remove('sort-option-selected');
            option.classList.remove('border-[#F13D30]');
            option.classList.add('border-[#D1D5DB]');
            radioDisplay.classList.remove('border-[#3B82F6]');
            radioDisplay.classList.add('border-[#111827]');
            radioDot.classList.add('hidden');
        }
    });
    
    updateSortPreview();
}

function applySort() {
    const tbody = document.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr.system-row'));
    
    rows.sort((a, b) => {
        const aCells = a.querySelectorAll('td');
        const bCells = b.querySelectorAll('td');
        
        if (aCells.length < 8 || bCells.length < 8) return 0;
        
        let aValue, bValue;
        
        switch(currentSortBy) {
            case 'name':
                aValue = aCells[0].textContent.trim();
                bValue = bCells[0].textContent.trim();
                break;
            case 'owner':
                aValue = aCells[1].textContent.trim();
                bValue = bCells[1].textContent.trim();
                break;
            case 'status':
                aValue = aCells[2].textContent.trim();
                bValue = bCells[2].textContent.trim();
                break;
            case 'role':
                aValue = aCells[3].textContent.trim();
                bValue = bCells[3].textContent.trim();
                break;
            case 'risk':
                aValue = aCells[4].textContent.trim();
                bValue = bCells[4].textContent.trim();
                break;
            case 'compliance':
                aValue = aCells[5].textContent.trim();
                bValue = bCells[5].textContent.trim();
                break;
            case 'last_updated':
                aValue = aCells[6].textContent.trim();
                bValue = bCells[6].textContent.trim();
                // Try to parse as date if possible
                const aDate = new Date(aValue);
                const bDate = new Date(bValue);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                    return currentSortOrder === 'asc' ? aDate - bDate : bDate - aDate;
                }
                break;
            case 'provider':
                aValue = aCells[7].textContent.trim();
                bValue = bCells[7].textContent.trim();
                break;
            default:
                return 0;
        }
        
        // String comparison
        if (aValue < bValue) {
            return currentSortOrder === 'asc' ? -1 : 1;
        }
        if (aValue > bValue) {
            return currentSortOrder === 'asc' ? 1 : -1;
        }
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    closeSortModal();
}

// Initialize sort radio buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sort-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            toggleSortOption(this);
        });
        
        // Also handle click on label
        const label = radio.closest('label');
        if (label) {
            label.addEventListener('click', function(e) {
                if (e.target !== radio && !radio.checked) {
                    radio.click();
                }
            });
        }
    });
    
    // Set initial state for "Last Updated" option
    const lastUpdatedRadio = document.querySelector('input[value="last_updated"]');
    if (lastUpdatedRadio) {
        toggleSortOption(lastUpdatedRadio);
    }
    
    // Initialize hover listeners for default selected button (Descending)
    setSortOrder('desc');
});

// Close sort modal when clicking outside
document.getElementById('sort-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeSortModal();
    }
});

// Other existing functions
// Add New AI System Modal Functions
function openAddSystemModal() {
    document.getElementById('add-system-modal').classList.remove('hidden');
}

function closeAddSystemModal() {
    document.getElementById('add-system-modal').classList.add('hidden');
    // Reset form
    document.getElementById('add-system-form').reset();
    document.getElementById('add-system-file-input').value = '';
    document.getElementById('add-system-file-name').textContent = 'Choose file...';
}

function aiReadAndAutoFill() {
    const fileInput = document.getElementById('add-system-file-input');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file first');
        return;
    }
    
    // TODO: Implement AI read and auto-fill logic
    alert('AI Read & Auto-fill functionality coming soon');
}

function createAISystem() {
    const form = document.getElementById('add-system-form');
    const formData = new FormData(form);
    
    // Validate required field
    const systemName = formData.get('system_name');
    if (!systemName || !systemName.trim()) {
        alert('AI System Name is required');
        return;
    }
    
    // Get file if selected
    const fileInput = document.getElementById('add-system-file-input');
    if (fileInput.files[0]) {
        formData.append('document', fileInput.files[0]);
    }
    
    // TODO: Send to backend API
    fetch('/api/ai-inventory/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('AI System created successfully!');
            closeAddSystemModal();
            location.reload(); // Reload page to show new system
        } else {
            alert('Error creating AI System: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating AI System');
    });
}

// File input change handler for Add System modal
document.getElementById('add-system-file-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('add-system-file-name').textContent = file.name;
    } else {
        document.getElementById('add-system-file-name').textContent = 'Choose file...';
    }
});

// Close add system modal when clicking outside
document.getElementById('add-system-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddSystemModal();
    }
});

function viewSystemDetails(agentId) {
    window.location.href = '{% url "ai_system_detail" 0 %}'.replace('0', agentId);
}

// Row click handler
document.querySelectorAll('.system-row').forEach(row => {
    row.addEventListener('click', function() {
        const agentId = this.getAttribute('data-agent-id');
        if (agentId) {
            viewSystemDetails(agentId);
        }
    });
});

// Search functionality
document.getElementById('search-input')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}
