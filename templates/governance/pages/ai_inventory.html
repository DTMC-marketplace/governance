{% extends "governance/base.html" %}
{% load static %}

{% block title %}AI Inventory{% endblock %}

{% block dashboard_content %}
<div class="flex flex-col gap-5">
    <!-- Breadcrumb Navigation -->
    <div class="flex items-center gap-3">
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.back()">
            <img src="{% static 'governance/img/arrow-left.svg' %}" alt="Back" class="w-3.5 h-3.5">
        </button>
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.forward()">
            <img src="{% static 'governance/img/arrow-right-gray.svg' %}" alt="Forward" class="w-3.5 h-3.5">
        </button>
        <span class="text-sm font-semibold text-[#F13D30]">AI Inventory</span>
    </div>

    <!-- Page Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-[#22262A] mb-1">AI Systems</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openImportModal()" class="px-4 py-2 bg-white border border-[#DC180A] text-[#F13D30] rounded-full font-semibold text-sm hover:bg-[#FEEDEC] transition-colors flex items-center gap-2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Import</span>
            </button>
            <button onclick="openExportModal()" class="px-4 py-2 bg-white border border-[#DC180A] text-[#F13D30] rounded-full font-semibold text-sm hover:bg-[#FEEDEC] transition-colors flex items-center gap-2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Alert Banner -->
    {% if systems_need_attention > 0 %}
    <div class="bg-[#FEEDEC] border-l-4 border-[#F13D30] rounded-lg p-4 mb-6">
        <div class="flex items-start gap-3">
            <div class="w-5 h-5 rounded-full bg-[#F13D30] flex items-center justify-center shrink-0 mt-0.5">
                <span class="text-white text-xs font-bold">!</span>
            </div>
            <div>
                <p class="font-semibold text-sm text-[#22262A]">
                    {{ systems_need_attention }} systems need attention
                </p>
                <p class="font-normal text-sm text-[#464E58] mt-1">
                    Complete the compliance assessment for systems with "Not started" or "In progress" status
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Bar -->
    <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm p-4 mb-6">
        <div class="flex items-center justify-between gap-4">
            <!-- Left: Add New Button -->
            <button onclick="openAddSystemModal()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-bold text-sm hover:bg-[#DC180A] transition-colors flex items-center gap-2 shadow-md">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Add New</span>
            </button>

            <!-- Right Actions -->
            <div class="flex items-center gap-3">
                <!-- Search -->
                <div class="relative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-[#B5BCC4]">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="search-input" placeholder="Search AI systems..." 
                        class="w-64 pl-10 pr-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] bg-white focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                </div>

                <button onclick="openFilterModal()" class="px-4 py-2 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors flex items-center gap-2">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    <span>Filter</span>
                </button>
                <button onclick="openSortModal()" class="px-4 py-2 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors flex items-center gap-2">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <path d="M3 6h18M7 12h10M11 18h2"></path>
                    </svg>
                    <span>Sort</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Click Reminder -->
    <div class="bg-[#EFF6FF] border border-[#BFDBFE] rounded-lg p-3 mb-4 flex items-center gap-2">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#3B82F6]">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
        <p class="font-normal text-sm text-[#1E40AF]">
            <span class="font-semibold">Tip:</span> Click on any row to view details and update information
        </p>
    </div>

    <!-- AI Systems Table -->
    <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-[#F9FAFB] border-b border-[#F0F1F2]">
                    <tr>
                        <th class="px-6 py-4 w-12">
                            <input type="checkbox" id="select-all-checkbox" 
                                class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]"
                                onclick="event.stopPropagation()">
                        </th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">AI System Name</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Owner</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Status</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Role</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Risk Classification</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Compliance Status</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Last Updated</th>
                        <th class="px-6 py-4 text-left font-semibold text-xs text-[#565F6C] uppercase tracking-wider">Provider Type</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[#F0F1F2]">
                    {% for system in ai_systems %}
                    <tr class="hover:bg-[#FEEDEC] cursor-pointer system-row group" data-agent-id="{{ system.id }}">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="system-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]" 
                                data-system-id="{{ system.id }}"
                                onclick="event.stopPropagation()">
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-sm text-[#22262A]">
                                    {{ system.name }}
                                </span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#B5BCC4] group-hover:text-[#F13D30] transition-colors">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-normal text-sm text-[#464E58]">
                                {{ system.owner|default:"—" }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2.5 py-1 rounded-full font-medium text-xs {{ system.status_badge_class }}">
                                {{ system.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap gap-1">
                                {% if system.roles %}
                                    {% for role in system.roles %}
                                        <span class="inline-flex px-2 py-0.5 rounded font-medium text-xs bg-[#E5E7EB] text-[#464E58]">
                                            {{ role }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="font-normal text-sm text-[#464E58]">
                                        {{ system.role|default:"—" }}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2.5 py-1 rounded-full font-medium text-xs {{ system.risk_badge_class }}">
                                {{ system.risk_classification }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2.5 py-1 rounded-full font-medium text-xs {{ system.compliance_badge_class }}">
                                {{ system.compliance_status }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-normal text-sm text-[#464E58]">
                                {{ system.last_updated }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-normal text-sm text-[#464E58]">
                                {{ system.provider_type }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center">
                            <p class="font-medium text-base text-[#565F6C]">No AI systems found</p>
                            <p class="font-normal text-sm text-[#B5BCC4] mt-2">Click "Add New AI System" to get started</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer Summary -->
    <div class="mt-6 flex items-center justify-between">
        <p class="font-normal text-sm text-[#565F6C]">
            Showing <span id="systems-count">{{ ai_systems|length }}</span> AI system{{ ai_systems|length|pluralize:"s" }}
            <span id="selected-count-display" class="hidden ml-2 text-[#F13D30] font-medium">
                (<span id="selected-count">0</span> selected)
            </span>
        </p>
        <div class="flex gap-2 items-center">
            <button id="delete-selected-btn" onclick="deleteSelectedSystems()" class="hidden px-4 py-2 rounded-lg border border-[#DC180A] text-[#F13D30] font-medium bg-white flex items-center gap-2 hover:bg-[#FEE2E2] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span>Delete selected</span>
            </button>
            <button id="pagination-prev" onclick="changePage(-1)" class="px-4 py-2 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
            <div id="pagination-numbers" class="flex items-center gap-2">
                <button class="px-4 py-2 bg-[#F13D30] text-white border border-[#F13D30] rounded-lg font-semibold text-sm">1</button>
            </div>
            <button id="pagination-next" onclick="changePage(1)" class="px-4 py-2 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next</button>
        </div>
    </div>
</div>

<!-- Import AI Systems Modal -->
<div id="import-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Import AI Systems</h2>
            <button onclick="closeImportModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Need a template? Section -->
            <div class="bg-[#EFF6FF] border border-[#BFDBFE] rounded-lg p-4">
                <div class="flex items-start gap-3">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#3B82F6] shrink-0 mt-0.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-[#1E40AF] mb-2">Need a template?</p>
                        <p class="font-normal text-sm text-[#1E40AF] mb-3">Download our CSV template to ensure your data is formatted correctly.</p>
                        <button onclick="downloadTemplate()" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-[#3B82F6] text-[#3B82F6] rounded-lg font-semibold text-sm hover:bg-[#EFF6FF] transition-colors">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Download Template</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upload CSV File Section -->
            <div>
                <label class="block font-semibold text-sm text-[#22262A] mb-2">Upload CSV File</label>
                <div id="csv-drop-zone" class="border-2 border-dashed rounded-lg p-8 text-center transition-colors border-[#B5BCC4] bg-[#F9FAFB]">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-12 h-12 mx-auto mb-4 text-[#B5BCC4]">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <div id="csv-drop-content">
                        <p class="font-semibold text-sm text-[#22262A] mb-2">Drag and drop your CSV file here</p>
                        <p class="font-normal text-sm text-[#565F6C] mb-4">or</p>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        <label for="csv-file-input" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors cursor-pointer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>Browse Files</span>
                        </label>
                    </div>
                    <div id="csv-file-info" class="hidden space-y-2">
                        <p class="font-semibold text-sm text-[#22262A]"></p>
                        <p class="font-normal text-xs text-[#565F6C]"></p>
                        <button onclick="removeCsvFile()" class="text-[#F13D30] font-semibold text-sm hover:underline">
                            Remove file
                        </button>
                    </div>
                </div>
                <p class="font-normal text-xs text-[#565F6C] mt-2">Supported format: CSV (max 10MB)</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4 p-6">
            <button onclick="closeImportModal()" class="flex-1 px-4 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                Cancel
            </button>
            <button onclick="importCsvFile()" id="import-btn" disabled class="flex-1 px-4 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Import
            </button>
        </div>
    </div>
</div>

<!-- Export AI Systems Modal -->
<div id="export-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Export AI Systems</h2>
            <button onclick="closeExportModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Icon and Message -->
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-[#FEEDEC] rounded-full flex items-center justify-center mb-4">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#F13D30" stroke-width="2" class="w-8 h-8">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <h3 class="font-semibold text-lg text-[#22262A] mb-2">Download AI System List</h3>
                <p class="font-normal text-sm text-[#565F6C]">Export all AI systems with the information displayed on this page as a CSV file.</p>
            </div>

            <!-- Details -->
            <div class="bg-[#F9FAFB] border border-[#F0F1F2] rounded-lg p-4">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-normal text-sm text-[#565F6C]">Total systems:</span>
                        <span class="font-semibold text-sm text-[#22262A]" id="export-total-systems">{{ ai_systems|length }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-normal text-sm text-[#565F6C]">Format:</span>
                        <span class="font-semibold text-sm text-[#22262A]">CSV</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-normal text-sm text-[#565F6C]">Includes:</span>
                        <span class="font-semibold text-sm text-[#22262A]">All columns</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 p-6">
            <button onclick="closeExportModal()" class="flex-1 px-4 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                Cancel
            </button>
            <button onclick="downloadExport()" class="flex-1 px-4 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors flex items-center justify-center gap-2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Download</span>
            </button>
        </div>
    </div>
</div>

<!-- Filter AI Systems Modal -->
<div id="filter-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Filter AI Systems</h2>
            <button onclick="closeFilterModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6">
            <!-- Filters Selected Count -->
            <div class="flex items-center justify-between">
                <p class="font-normal text-sm text-[#565F6C]">
                    <span id="filter-count">0</span> filter<span id="filter-count-plural">s</span> selected
                </p>
                <button onclick="clearAllFilters()" class="font-semibold text-sm text-[#F13D30] hover:underline">
                    Clear all
                </button>
            </div>

            <!-- Filter Categories -->
            <div class="space-y-6">
                <!-- Status Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Status</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="status" value="planned">
                            <span class="font-normal text-sm text-[#22262A]">Planned</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="status" value="in_production">
                            <span class="font-normal text-sm text-[#22262A]">In production</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="status" value="testing">
                            <span class="font-normal text-sm text-[#22262A]">Testing</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="status" value="retired">
                            <span class="font-normal text-sm text-[#22262A]">Retired</span>
                        </label>
                    </div>
                </div>

                <!-- Role Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Role</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="role" value="provider">
                            <span class="font-normal text-sm text-[#22262A]">Provider</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="role" value="distributor">
                            <span class="font-normal text-sm text-[#22262A]">Distributor</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="role" value="deployer">
                            <span class="font-normal text-sm text-[#22262A]">Deployer</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="role" value="importer">
                            <span class="font-normal text-sm text-[#22262A]">Importer</span>
                        </label>
                    </div>
                </div>

                <!-- Risk Classification Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Risk Classification</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="prohibited">
                            <span class="font-normal text-sm text-[#22262A]">Prohibited</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="limited_transparency">
                            <span class="font-normal text-sm text-[#22262A]">Limited transparency</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="not_assessed">
                            <span class="font-normal text-sm text-[#22262A]">Not assessed</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="high_risk">
                            <span class="font-normal text-sm text-[#22262A]">High-risk</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="minimal">
                            <span class="font-normal text-sm text-[#22262A]">Minimal</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="risk" value="not_in_scope">
                            <span class="font-normal text-sm text-[#22262A]">Not in scope</span>
                        </label>
                    </div>
                </div>

                <!-- Compliance Status Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Compliance Status</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="compliance" value="not_started">
                            <span class="font-normal text-sm text-[#22262A]">Not started</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="compliance" value="compliant">
                            <span class="font-normal text-sm text-[#22262A]">Compliant</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="compliance" value="not_in_scope">
                            <span class="font-normal text-sm text-[#22262A]">Not in scope</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="compliance" value="in_progress">
                            <span class="font-normal text-sm text-[#22262A]">In progress</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="compliance" value="non_compliant">
                            <span class="font-normal text-sm text-[#22262A]">Non-compliant</span>
                        </label>
                    </div>
                </div>

                <!-- Provider Type Filter -->
                <div>
                    <h3 class="text-sm font-semibold text-[#111827] mb-3">Provider Type</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="provider" value="in_house">
                            <span class="font-normal text-sm text-[#22262A]">In-house</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="provider" value="mixed">
                            <span class="font-normal text-sm text-[#22262A]">Mixed</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="provider" value="external">
                            <span class="font-normal text-sm text-[#22262A]">External</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 border border-[#F0F1F2] rounded-lg hover:bg-[#F9FAFB] cursor-pointer transition-colors">
                            <input type="checkbox" class="filter-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] focus:ring-2" data-category="provider" value="unknown">
                            <span class="font-normal text-sm text-[#22262A]">Unknown</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4 p-6 border-t border-[#F0F1F2]">
            <button onclick="closeFilterModal()" class="flex-1 px-4 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                Cancel
            </button>
            <button onclick="applyFilters()" class="flex-1 px-4 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                Apply Filters
            </button>
        </div>
    </div>
</div>

<!-- Sort AI Systems Modal -->
<div id="sort-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Sort AI Systems</h2>
            <button onclick="closeSortModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Sort by Section -->
            <div>
                <h3 class="text-sm font-semibold text-[#22262A] mb-3">Sort by</h3>
                <div class="space-y-2">
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="name" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">AI System Name</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="owner" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Owner</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="status" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Status</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="role" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Role</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="risk" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Risk Classification</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="compliance" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Compliance Status</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F13D30] rounded-lg cursor-pointer bg-[#FEEDEC] transition-colors sort-option-selected">
                        <input type="radio" name="sort-by" value="last_updated" checked class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#F13D30] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Last Updated</span>
                    </label>
                    <label class="sort-option flex items-center gap-3 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer hover:bg-[#F9FAFB] transition-colors">
                        <input type="radio" name="sort-by" value="provider" class="sort-radio hidden">
                        <div class="sort-radio-display w-4 h-4 border-2 border-[#B5BCC4] rounded-full flex items-center justify-center flex-shrink-0">
                            <div class="hidden radio-dot w-2.5 h-2.5 bg-[#F13D30] rounded-full"></div>
                        </div>
                        <span class="font-normal text-sm text-[#22262A]">Provider Type</span>
                    </label>
                </div>
            </div>

            <!-- Order Section -->
            <div>
                <h3 class="text-sm font-semibold text-[#22262A] mb-3">Order</h3>
                <div class="flex gap-3">
                    <button onclick="setSortOrder('asc')" id="sort-asc-btn" class="flex items-center gap-2 px-4 py-2 border border-[#F0F1F2] bg-white text-[#464E58] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                        <span>Ascending</span>
                    </button>
                    <button onclick="setSortOrder('desc')" id="sort-desc-btn" class="flex items-center gap-2 px-4 py-2 border border-[#F13D30] bg-[#FEEDEC] text-[#F13D30] text-sm font-medium rounded-lg transition-colors">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        <span>Descending</span>
                    </button>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-[#F9FAFB] border border-[#F0F1F2] rounded-lg p-4">
                <p class="font-normal text-sm text-[#565F6C]" id="sort-preview-text">
                    <span class="font-semibold text-[#22262A]">Preview:</span> <span id="preview-text-content">Sorting by <span class="font-semibold text-[#22262A]" id="preview-sort-by">Last Updated</span> in <span class="font-semibold text-[#22262A]" id="preview-order">descending</span> order</span>
                </p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-4 p-6 border-t border-[#F0F1F2]">
            <button onclick="closeSortModal()" class="flex-1 px-4 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                Cancel
            </button>
            <button onclick="applySort()" class="flex-1 px-4 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                Apply Sort
            </button>
        </div>
    </div>
</div>

<!-- Add New AI System Modal -->
<div id="add-system-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-[#E5E7EB]">
            <h2 class="text-xl font-bold text-[#22262A]">Add New AI System</h2>
            <button onclick="closeAddSystemModal()" class="w-6 h-6 flex items-center justify-center text-[#6B7280] hover:text-[#111827] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
            <!-- Tip Box -->
            <div class="bg-[#EFF6FF] border border-[#BFDBFE] rounded-lg p-4">
                <p class="font-normal text-sm text-[#1E40AF]">
                    <span class="font-semibold">Tip:</span> Only AI system name is mandatory to create the record. Other questions are for the assessment, which could be provided later.
                </p>
            </div>

            <!-- Optional Document Upload -->
            <div class="border border-[#F0F1F2] rounded-lg p-4 bg-[#F9FAFB]">
                <label class="block font-semibold text-sm text-[#22262A] mb-3">
                    <span class="text-[#565F6C]">(Optional)</span> Upload Document for AI Auto-fill
                </label>
                <div class="flex gap-3">
                    <label class="flex-1 flex items-center gap-3 px-4 py-3 bg-white border border-[#B5BCC4] rounded-lg cursor-pointer hover:bg-[#F0F1F2] transition-colors">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#565F6C]">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <div class="flex-1 min-w-0 overflow-hidden">
                            <span id="add-system-file-name" class="font-normal text-sm text-[#B5BCC4] block truncate max-w-full" title="">Choose file...</span>
                        </div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-[#565F6C]">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <input type="file" id="add-system-file-input" accept=".pdf,.doc,.docx,.txt" class="hidden">
                    </label>
                    <button onclick="aiReadAndAutoFill()" disabled id="ai-read-btn" class="px-4 py-3 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <img src="{% static 'governance/img/sparkle.svg' %}" alt="Sparkle" class="w-4 h-4" style="filter: brightness(0) invert(1);">
                        <span>AI Read & Auto-fill</span>
                    </button>
                </div>
                <p class="font-normal text-xs text-[#565F6C] mt-2">Supported formats: PDF, DOC, DOCX, TXT</p>
            </div>

            <!-- Form Fields -->
            <form id="add-system-form" class="space-y-4">
                <!-- AI System Name (Mandatory) -->
                <div>
                    <label class="block font-semibold text-sm text-[#22262A] mb-2">
                        AI System Name <span class="text-[#F13D30]">*</span>
                    </label>
                    <input type="text" name="system_name" required placeholder="Enter AI system name" 
                        class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                </div>

                <!-- Owner and Status -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Owner (Person / Team)</label>
                        <input type="text" name="owner" placeholder="Not provided" value="Not provided"
                            class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                    </div>
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Status</label>
                        <select name="status" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="Planned" selected>Planned</option>
                            <option value="Testing">Testing</option>
                            <option value="In production">In production</option>
                            <option value="Retired">Retired</option>
                        </select>
                    </div>
                </div>

                <!-- Role (Multi-select) and Provider Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Role (Select all that apply)</label>
                        <div class="space-y-2 border border-[#B5BCC4] rounded-lg p-3 bg-white">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role" value="Provider" checked class="w-4 h-4 accent-[#F13D30] cursor-pointer">
                                <span class="text-sm text-[#22262A]">Provider</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role" value="Deployer" class="w-4 h-4 accent-[#F13D30] cursor-pointer">
                                <span class="text-sm text-[#22262A]">Deployer</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role" value="Distributor" class="w-4 h-4 accent-[#F13D30] cursor-pointer">
                                <span class="text-sm text-[#22262A]">Distributor</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="role" value="Importer" class="w-4 h-4 accent-[#F13D30] cursor-pointer">
                                <span class="text-sm text-[#22262A]">Importer</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Provider Type</label>
                        <select name="provider_type" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="In-house">In-house</option>
                            <option value="External">External</option>
                            <option value="Mixed">Mixed</option>
                            <option value="Unknown" selected>Unknown</option>
                        </select>
                    </div>
                </div>

                <!-- Risk Classification and Compliance Status -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Risk Classification</label>
                        <select name="risk_classification" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="Not assessed" selected>Not assessed</option>
                            <option value="Prohibited">Prohibited</option>
                            <option value="High-risk">High-risk</option>
                            <option value="Limited transparency">Limited transparency</option>
                            <option value="Minimal">Minimal</option>
                            <option value="Not in scope">Not in scope</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Compliance Status</label>
                        <select name="compliance_status" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="Not started" selected>Not started</option>
                            <option value="In progress">In progress</option>
                            <option value="Compliant">Compliant</option>
                            <option value="Non-compliant">Non-compliant</option>
                        </select>
                    </div>
                </div>

                <!-- Deployment Context and EU / EEA Relevance -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">Deployment Context</label>
                        <select name="deployment_context" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="Workplace" selected>Workplace</option>
                            <option value="Education">Education</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Law enforcement">Law enforcement</option>
                            <option value="Consumer">Consumer</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold text-sm text-[#22262A] mb-2">EU / EEA Relevance</label>
                        <select name="eu_eea_relevance" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="Planned">Planned</option>
                            <option value="Unknown" selected>Unknown</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 px-6 py-4 border-t border-[#F0F1F2]">
            <button onclick="closeAddSystemModal()" class="flex-1 px-4 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                Cancel
            </button>
            <button onclick="createAISystem()" class="flex-1 px-4 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                Create
            </button>
        </div>
    </div>
</div>

<style>
.styled-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: #fff;
    border: 1px solid #D1D5DB;
    border-radius: 0.75rem;
    padding: 0.5rem 3rem 0.5rem 0.75rem;
    width: 100%;
    color: #374151;
    font-size: 0.875rem;
    line-height: 1.4;
}
.styled-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(241, 61, 48, 0.15);
    border-color: #F13D30;
}
.styled-select-wrapper {
    position: relative;
}
.styled-select-wrapper svg {
    pointer-events: none;
}
</style>

<script>
let selectedCsvFile = null;

// Import Modal Functions
function openImportModal() {
    document.getElementById('import-modal').classList.remove('hidden');
}

function closeImportModal() {
    document.getElementById('import-modal').classList.add('hidden');
    resetImportModal();
}

function resetImportModal() {
    selectedCsvFile = null;
    document.getElementById('csv-file-input').value = '';
    document.getElementById('csv-drop-content').classList.remove('hidden');
    document.getElementById('csv-file-info').classList.add('hidden');
    document.getElementById('import-btn').disabled = true;
    const dropZone = document.getElementById('csv-drop-zone');
    if (dropZone) {
        dropZone.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
        dropZone.classList.add('border-[#B5BCC4]', 'bg-[#F9FAFB]');
        const svg = dropZone.querySelector('svg');
        if (svg) {
            svg.classList.remove('text-[#F13D30]');
            svg.classList.add('text-[#B5BCC4]');
        }
    }
}

function downloadTemplate() {
    // Create CSV template matching "Add New AI System" form fields
    // Note: "Last Updated" is auto-generated, not needed in template
    const headers = [
        'AI System Name',           // Required
        'Owner (Person / Team)',    // Default: "Not provided"
        'Status',                   // Planned, Testing, In production, Retired
        'Role',                     // Provider, Deployer, Distributor, Importer (comma-separated for multiple, e.g., "Provider, Deployer")
        'Risk Classification',       // Not assessed, Prohibited, High-risk, Limited transparency, Minimal, Not in scope
        'Compliance Status',        // Not started, In progress, Compliant, Non-compliant
        'Provider Type',            // In-house, External, Mixed, Unknown
        'Deployment Context',       // Workplace, Education, Healthcare, Law enforcement, Consumer, Other
        'EU / EEA Relevance'        // Yes, No, Planned, Unknown
    ];
    
    // Add example rows with different scenarios
    const exampleRow1 = [
        'Example AI System 1',       // AI System Name
        'Not provided',              // Owner
        'Planned',                   // Status
        'Provider',                  // Role (single role)
        'Not assessed',              // Risk Classification
        'Not started',               // Compliance Status
        'Unknown',                   // Provider Type
        'Workplace',                 // Deployment Context
        'Unknown'                    // EU / EEA Relevance
    ];
    
    const exampleRow2 = [
        'Example AI System 2',       // AI System Name
        'Product Team',              // Owner
        'In production',             // Status
        'Provider, Deployer',        // Role (multiple roles - comma-separated)
        'High-risk',                 // Risk Classification
        'Compliant',                 // Compliance Status
        'Mixed',                     // Provider Type
        'Healthcare',                // Deployment Context
        'Yes'                        // EU / EEA Relevance
    ];
    
    // Add third example with 3 roles to show more possibilities
    const exampleRow3 = [
        'Example AI System 3',       // AI System Name
        'Operations Team',           // Owner
        'Testing',                   // Status
        'Provider, Distributor, Importer',  // Role (3 roles - comma-separated)
        'Limited transparency',      // Risk Classification
        'In progress',               // Compliance Status
        'External',                  // Provider Type
        'Education',                 // Deployment Context
        'No'                         // EU / EEA Relevance
    ];
    
    // Create CSV with proper escaping for values containing commas
    const escapeCsvValue = (value) => {
        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
            return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
    };
    
    const csvContent = headers.map(escapeCsvValue).join(',') + '\n' + 
                       exampleRow1.map(escapeCsvValue).join(',') + '\n' + 
                       exampleRow2.map(escapeCsvValue).join(',') + '\n' +
                       exampleRow3.map(escapeCsvValue).join(',') + '\n';
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'ai_systems_template.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function handleFileSelect(file) {
    if (!file) return;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please upload a CSV file');
        return;
    }
    
    // Validate file size (10MB max)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        alert('File size exceeds 10MB limit');
        return;
    }
    
    selectedCsvFile = file;
    const dropZone = document.getElementById('csv-drop-zone');
    const dropContent = document.getElementById('csv-drop-content');
    const fileInfo = document.getElementById('csv-file-info');
    
    dropContent.classList.add('hidden');
    fileInfo.classList.remove('hidden');
    fileInfo.querySelector('p.font-semibold').textContent = file.name;
    fileInfo.querySelector('p.font-normal').textContent = `${(file.size / 1024).toFixed(2)} KB`;
    document.getElementById('import-btn').disabled = false;
}

function removeCsvFile() {
    selectedCsvFile = null;
    document.getElementById('csv-file-input').value = '';
    document.getElementById('csv-drop-content').classList.remove('hidden');
    document.getElementById('csv-file-info').classList.add('hidden');
    document.getElementById('import-btn').disabled = true;
    const dropZone = document.getElementById('csv-drop-zone');
    dropZone.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
    dropZone.classList.add('border-[#B5BCC4]', 'bg-[#F9FAFB]');
}

async function importCsvFile() {
    if (!selectedCsvFile) {
        alert('Please select a CSV file first');
        return;
    }
    
    try {
        // Upload file using shared API (like Organization page)
        const uploadFormData = new FormData();
        uploadFormData.append('file', selectedCsvFile);
        uploadFormData.append('folder', 'governance/uploads');
        
        const uploadResponse = await fetch('/api/upload-file/', {
            method: 'POST',
            body: uploadFormData
        });
        
        const uploadResult = await uploadResponse.json();
        
        if (!uploadResult.success || !uploadResult.files || uploadResult.files.length === 0) {
            alert('Error uploading CSV file: ' + (uploadResult.error || 'Unknown error'));
            return;
        }
        
        const uploadedFile = uploadResult.files[0];
        
        // Send file info to import API
        const importResponse = await fetch('/api/ai-inventory/import/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_url: uploadedFile.url,
                file_path: uploadedFile.path,
                file_name: uploadedFile.name
            })
        });
        
        const importResult = await importResponse.json();
        
        if (importResult.success) {
            alert('AI Systems imported successfully!');
            closeImportModal();
            location.reload(); // Reload page to show new data
        } else {
            alert('Error importing: ' + (importResult.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error importing CSV file: ' + error.message);
    }
}

// File input change handler
document.getElementById('csv-file-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    handleFileSelect(file);
});

// Drag and drop handlers
document.addEventListener('DOMContentLoaded', function() {
    const csvDropZone = document.getElementById('csv-drop-zone');
    if (csvDropZone) {
        ['dragenter', 'dragover'].forEach(evt => {
            csvDropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                csvDropZone.classList.remove('border-[#B5BCC4]', 'bg-[#F9FAFB]');
                csvDropZone.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                const svg = csvDropZone.querySelector('svg');
                if (svg) {
                    svg.classList.remove('text-[#B5BCC4]');
                    svg.classList.add('text-[#F13D30]');
                }
            });
        });

        ['dragleave', 'drop'].forEach(evt => {
            csvDropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!selectedCsvFile) {
                    csvDropZone.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                    csvDropZone.classList.add('border-[#B5BCC4]', 'bg-[#F9FAFB]');
                    const svg = csvDropZone.querySelector('svg');
                    if (svg) {
                        svg.classList.remove('text-[#F13D30]');
                        svg.classList.add('text-[#B5BCC4]');
                    }
                }
            });
        });

        csvDropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer?.files[0];
            handleFileSelect(file);
        });
    }
});

// Close modal when clicking outside
document.getElementById('import-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeImportModal();
    }
});

// Export Modal Functions
function openExportModal() {
    document.getElementById('export-modal').classList.remove('hidden');
}

function closeExportModal() {
    document.getElementById('export-modal').classList.add('hidden');
}

async function downloadExport() {
    try {
        // Call API to export
        const response = await fetch('/api/ai-inventory/export/', {
            method: 'GET',
        });
        
        if (!response.ok) {
            throw new Error('Export failed');
        }
        
        // Get CSV content from response
        const csvContent = await response.text();
        
        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `ai_systems_export_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Close modal after download
        closeExportModal();
    } catch (error) {
        console.error('Error:', error);
        alert('Error exporting AI systems: ' + error.message);
    }
}

// Close export modal when clicking outside
document.getElementById('export-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeExportModal();
    }
});

// Filter Modal Functions
let activeFilters = {
    status: [],
    role: [],
    risk: [],
    compliance: [],
    provider: []
};

function openFilterModal() {
    document.getElementById('filter-modal').classList.remove('hidden');
    updateFilterCount();
}

function closeFilterModal() {
    document.getElementById('filter-modal').classList.add('hidden');
}

function updateFilterCount() {
    const total = Object.values(activeFilters).flat().length;
    const countEl = document.getElementById('filter-count');
    const pluralEl = document.getElementById('filter-count-plural');
    if (countEl) countEl.textContent = total;
    if (pluralEl) pluralEl.textContent = total !== 1 ? 's' : '';
}

function toggleFilter(checkbox) {
    const category = checkbox.dataset.category;
    const value = checkbox.value;
    
    if (checkbox.checked) {
        if (!activeFilters[category].includes(value)) {
            activeFilters[category].push(value);
        }
    } else {
        activeFilters[category] = activeFilters[category].filter(v => v !== value);
    }
    
    updateFilterCount();
}

function clearAllFilters() {
    // Reset active filters
    activeFilters = {
        status: [],
        role: [],
        risk: [],
        compliance: [],
        provider: []
    };
    
    // Uncheck all checkboxes
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    updateFilterCount();
}

function applyFilters() {
    const rows = document.querySelectorAll('tbody tr.system-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 9) {
            row.style.display = 'none';
            return;
        }
        
        // Get row data - correct cell indices:
        // cells[0] = checkbox
        // cells[1] = AI System Name
        // cells[2] = Owner
        // cells[3] = Status
        // cells[4] = Role
        // cells[5] = Risk Classification
        // cells[6] = Compliance Status
        // cells[7] = Last Updated
        // cells[8] = Provider Type
        
        const statusText = cells[3].textContent.trim().toLowerCase();
        // Handle multiple roles - get all role badges
        const roleCell = cells[4];
        const roleBadges = roleCell.querySelectorAll('span');
        const roleTexts = Array.from(roleBadges).map(badge => badge.textContent.trim().toLowerCase());
        const roleText = roleTexts.length > 0 ? roleTexts.join(', ') : roleCell.textContent.trim().toLowerCase();
        const riskText = cells[5].textContent.trim().toLowerCase();
        const complianceText = cells[6].textContent.trim().toLowerCase();
        const providerText = cells[8].textContent.trim().toLowerCase();
        
        // Normalize values for matching
        const statusMap = {
            'planned': 'planned',
            'in production': 'in_production',
            'testing': 'testing',
            'retired': 'retired'
        };
        
        const roleMap = {
            'provider': 'provider',
            'distributor': 'distributor',
            'deployer': 'deployer',
            'importer': 'importer'
        };
        
        const riskMap = {
            'prohibited': 'prohibited',
            'limited transparency': 'limited_transparency',
            'not assessed': 'not_assessed',
            'high-risk': 'high_risk',
            'minimal': 'minimal',
            'not in scope': 'not_in_scope'
        };
        
        const complianceMap = {
            'not started': 'not_started',
            'compliant': 'compliant',
            'not in scope': 'not_in_scope',
            'in progress': 'in_progress',
            'non-compliant': 'non_compliant'
        };
        
        const providerMap = {
            'in-house': 'in_house',
            'mixed': 'mixed',
            'external': 'external',
            'unknown': 'unknown'
        };
        
        // Check if row matches filters
        let matches = true;
        
        if (activeFilters.status.length > 0) {
            // Normalize status text
            let normalizedStatus = statusText;
            if (statusText === 'in production') {
                normalizedStatus = 'in_production';
            } else {
                normalizedStatus = statusMap[statusText] || statusText.replace(/\s+/g, '_');
            }
            matches = matches && activeFilters.status.includes(normalizedStatus);
            console.log(`Status filter: row="${statusText}" -> normalized="${normalizedStatus}", filter=${activeFilters.status}, match=${matches}`);
        }
        
        if (activeFilters.role.length > 0 && matches) {
            // Check if any of the row's roles match any of the selected filters
            const rowRoles = roleTexts.length > 0 ? roleTexts : [roleText];
            const matchedRoles = rowRoles.filter(r => {
                const normalized = roleMap[r.trim()] || r.trim();
                return activeFilters.role.includes(normalized);
            });
            matches = matches && matchedRoles.length > 0;
            console.log(`Role filter: rowRoles=${rowRoles}, filter=${activeFilters.role}, matched=${matchedRoles}, match=${matches}`);
        }
        
        if (activeFilters.risk.length > 0 && matches) {
            // Normalize risk text
            let normalizedRisk = riskMap[riskText] || riskText.replace(/\s+/g, '_');
            // Handle "high-risk" -> "high_risk"
            if (riskText === 'high-risk') {
                normalizedRisk = 'high_risk';
            }
            matches = matches && activeFilters.risk.includes(normalizedRisk);
            console.log(`Risk filter: row="${riskText}" -> normalized="${normalizedRisk}", filter=${activeFilters.risk}, match=${matches}`);
        }
        
        if (activeFilters.compliance.length > 0 && matches) {
            // Normalize compliance text
            let normalizedCompliance = complianceMap[complianceText] || complianceText.replace(/\s+/g, '_');
            matches = matches && activeFilters.compliance.includes(normalizedCompliance);
            console.log(`Compliance filter: row="${complianceText}" -> normalized="${normalizedCompliance}", filter=${activeFilters.compliance}, match=${matches}`);
        }
        
        if (activeFilters.provider.length > 0 && matches) {
            // Normalize provider text
            let normalizedProvider = providerMap[providerText] || providerText.replace(/\s+/g, '_');
            matches = matches && activeFilters.provider.includes(normalizedProvider);
            console.log(`Provider filter: row="${providerText}" -> normalized="${normalizedProvider}", filter=${activeFilters.provider}, match=${matches}`);
        }
        
        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update pagination text
    const paginationText = document.querySelector('.flex.items-center.justify-between p');
    if (paginationText) {
        paginationText.textContent = `Showing ${visibleCount} AI system${visibleCount !== 1 ? 's' : ''}`;
    }
    
    // Reset pagination to page 1 and re-render (based on React code)
    currentPage = 1;
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
    updateSelectedCount();
    
    closeFilterModal();
}

// Initialize filter checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleFilter(this);
        });
        
        // Also handle click on label
        const label = checkbox.closest('label');
        if (label) {
            label.addEventListener('click', function(e) {
                if (e.target !== checkbox && e.target !== checkbox.nextElementSibling) {
                    checkbox.click();
                }
            });
        }
    });
});

// Close filter modal when clicking outside
document.getElementById('filter-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeFilterModal();
    }
});

// Sort Modal Functions
let currentSortBy = 'last_updated';
let currentSortOrder = 'desc';

function openSortModal() {
    document.getElementById('sort-modal').classList.remove('hidden');
    updateSortPreview();
}

function closeSortModal() {
    document.getElementById('sort-modal').classList.add('hidden');
}

function setSortOrder(order) {
    currentSortOrder = order;
    const ascBtn = document.getElementById('sort-asc-btn');
    const descBtn = document.getElementById('sort-desc-btn');
    
    // Remove existing hover listeners
    ascBtn.onmouseenter = null;
    ascBtn.onmouseleave = null;
    descBtn.onmouseenter = null;
    descBtn.onmouseleave = null;
    
    if (order === 'asc') {
        // Active button: red border, pink background, red text
        ascBtn.classList.remove('border-[#F0F1F2]', 'bg-white', 'text-[#464E58]', 'hover:bg-[#F9FAFB]');
        ascBtn.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]', 'text-[#F13D30]');
        // Inactive button: grey border, white background, grey text
        descBtn.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]', 'text-[#F13D30]');
        descBtn.classList.add('border-[#F0F1F2]', 'bg-white', 'text-[#464E58]', 'hover:bg-[#F9FAFB]');
    } else {
        // Active button: red border, pink background, red text
        descBtn.classList.remove('border-[#F0F1F2]', 'bg-white', 'text-[#464E58]', 'hover:bg-[#F9FAFB]');
        descBtn.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]', 'text-[#F13D30]');
        // Inactive button: grey border, white background, grey text
        ascBtn.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]', 'text-[#F13D30]');
        ascBtn.classList.add('border-[#F0F1F2]', 'bg-white', 'text-[#464E58]', 'hover:bg-[#F9FAFB]');
    }
    
    updateSortPreview();
}

function updateSortPreview() {
    const sortByLabels = {
        'name': 'AI System Name',
        'owner': 'Owner',
        'status': 'Status',
        'role': 'Role',
        'risk': 'Risk Classification',
        'compliance': 'Compliance Status',
        'last_updated': 'Last Updated',
        'provider': 'Provider Type'
    };
    
    const orderLabels = {
        'asc': 'ascending',
        'desc': 'descending'
    };
    
    const sortByText = currentSortBy ? (sortByLabels[currentSortBy] || currentSortBy) : '';
    const orderText = orderLabels[currentSortOrder] || currentSortOrder;
    
    const previewContent = document.getElementById('preview-text-content');
    
    if (currentSortBy) {
        previewContent.innerHTML = `Sorting by <span class="font-semibold text-[#22262A]">${sortByText}</span> in <span class="font-semibold text-[#22262A]">${orderText}</span> order`;
    } else {
        previewContent.innerHTML = `Sorting in <span class="font-semibold text-[#22262A]">${orderText}</span> order`;
    }
}

function toggleSortOption(radio) {
    // Check if this radio was already checked before the change event
    const wasChecked = radio.checked;
    
    // If clicking on already selected option, deselect it
    if (wasChecked) {
        // Uncheck this radio
        radio.checked = false;
        currentSortBy = null;
    } else {
        // Uncheck all other radios first
        document.querySelectorAll('.sort-radio').forEach(r => {
            if (r !== radio) {
                r.checked = false;
            }
        });
        // Check this radio
        radio.checked = true;
        currentSortBy = radio.value;
    }
    
    // Update visual state for all options
    document.querySelectorAll('.sort-option').forEach(option => {
        const optionRadio = option.querySelector('.sort-radio');
        const radioDisplay = option.querySelector('.sort-radio-display');
        const radioDot = radioDisplay.querySelector('.radio-dot');
        
        if (optionRadio.checked) {
            option.classList.add('sort-option-selected');
            option.classList.remove('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
            option.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
            radioDisplay.classList.remove('border-[#B5BCC4]');
            radioDisplay.classList.add('border-[#F13D30]');
            radioDot.classList.remove('hidden');
        } else {
            option.classList.remove('sort-option-selected', 'bg-[#FEEDEC]');
            option.classList.remove('border-[#F13D30]');
            option.classList.add('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
            radioDisplay.classList.remove('border-[#F13D30]');
            radioDisplay.classList.add('border-[#B5BCC4]');
            radioDot.classList.add('hidden');
        }
    });
    
    updateSortPreview();
}

function applySort() {
    // If no sort option is selected, don't apply sort
    if (!currentSortBy) {
        closeSortModal();
        return;
    }
    
    const tbody = document.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr.system-row'));
    
    rows.sort((a, b) => {
        const aCells = a.querySelectorAll('td');
        const bCells = b.querySelectorAll('td');
        
        if (aCells.length < 8 || bCells.length < 8) return 0;
        
        let aValue, bValue;
        
        switch(currentSortBy) {
            case 'name':
                aValue = aCells[0].textContent.trim();
                bValue = bCells[0].textContent.trim();
                break;
            case 'owner':
                aValue = aCells[1].textContent.trim();
                bValue = bCells[1].textContent.trim();
                break;
            case 'status':
                aValue = aCells[2].textContent.trim();
                bValue = bCells[2].textContent.trim();
                break;
            case 'role':
                aValue = aCells[3].textContent.trim();
                bValue = bCells[3].textContent.trim();
                break;
            case 'risk':
                aValue = aCells[4].textContent.trim();
                bValue = bCells[4].textContent.trim();
                break;
            case 'compliance':
                aValue = aCells[5].textContent.trim();
                bValue = bCells[5].textContent.trim();
                break;
            case 'last_updated':
                aValue = aCells[6].textContent.trim();
                bValue = bCells[6].textContent.trim();
                // Try to parse as date if possible
                const aDate = new Date(aValue);
                const bDate = new Date(bValue);
                if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
                    return currentSortOrder === 'asc' ? aDate - bDate : bDate - aDate;
                }
                break;
            case 'provider':
                aValue = aCells[7].textContent.trim();
                bValue = bCells[7].textContent.trim();
                break;
            default:
                return 0;
        }
        
        // String comparison
        if (aValue < bValue) {
            return currentSortOrder === 'asc' ? -1 : 1;
        }
        if (aValue > bValue) {
            return currentSortOrder === 'asc' ? 1 : -1;
        }
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Reset pagination to page 1 and re-render (based on React code)
    currentPage = 1;
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
    updateSelectedCount();
    
    closeSortModal();
}

// Initialize sort radio buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sort-option').forEach(option => {
        const radio = option.querySelector('.sort-radio');
        if (!radio) return;
        
        // Handle click on the entire label/option
        option.addEventListener('click', function(e) {
            // Don't handle if clicking directly on radio (browser handles it)
            if (e.target === radio) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            // Check if this radio is already checked
            const wasChecked = radio.checked;
            
            if (wasChecked) {
                // Deselect: uncheck this radio
                radio.checked = false;
                currentSortBy = null;
            } else {
                // Select: uncheck all others first, then check this one
                document.querySelectorAll('.sort-radio').forEach(r => {
                    r.checked = false;
                });
                radio.checked = true;
                currentSortBy = radio.value;
            }
            
            // Update visual state
            document.querySelectorAll('.sort-option').forEach(opt => {
                const optRadio = opt.querySelector('.sort-radio');
                const radioDisplay = opt.querySelector('.sort-radio-display');
                const radioDot = radioDisplay.querySelector('.radio-dot');
                
                if (optRadio.checked) {
                    opt.classList.add('sort-option-selected');
                    opt.classList.remove('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
                    opt.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                    radioDisplay.classList.remove('border-[#B5BCC4]');
                    radioDisplay.classList.add('border-[#F13D30]');
                    radioDot.classList.remove('hidden');
                } else {
                    opt.classList.remove('sort-option-selected', 'bg-[#FEEDEC]');
                    opt.classList.remove('border-[#F13D30]');
                    opt.classList.add('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
                    radioDisplay.classList.remove('border-[#F13D30]');
                    radioDisplay.classList.add('border-[#B5BCC4]');
                    radioDot.classList.add('hidden');
                }
            });
            
            updateSortPreview();
        });
        
        // Also handle change event for when radio is clicked directly
        radio.addEventListener('change', function() {
            // Only update if this wasn't already handled by the click handler
            if (this.checked) {
                currentSortBy = this.value;
            } else {
                currentSortBy = null;
            }
            
            // Update visual state
            document.querySelectorAll('.sort-option').forEach(opt => {
                const optRadio = opt.querySelector('.sort-radio');
                const radioDisplay = opt.querySelector('.sort-radio-display');
                const radioDot = radioDisplay.querySelector('.radio-dot');
                
                if (optRadio.checked) {
                    opt.classList.add('sort-option-selected');
                    opt.classList.remove('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
                    opt.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                    radioDisplay.classList.remove('border-[#B5BCC4]');
                    radioDisplay.classList.add('border-[#F13D30]');
                    radioDot.classList.remove('hidden');
                } else {
                    opt.classList.remove('sort-option-selected', 'bg-[#FEEDEC]');
                    opt.classList.remove('border-[#F13D30]');
                    opt.classList.add('border-[#F0F1F2]', 'hover:bg-[#F9FAFB]');
                    radioDisplay.classList.remove('border-[#F13D30]');
                    radioDisplay.classList.add('border-[#B5BCC4]');
                    radioDot.classList.add('hidden');
                }
            });
            
            updateSortPreview();
        });
    });
    
    // Set initial state for "Last Updated" option
    const lastUpdatedRadio = document.querySelector('input[value="last_updated"]');
    if (lastUpdatedRadio && lastUpdatedRadio.checked) {
        currentSortBy = 'last_updated';
        updateSortPreview();
    }
    
    // Initialize hover listeners for default selected button (Descending)
    setSortOrder('desc');
});

// Close sort modal when clicking outside
document.getElementById('sort-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeSortModal();
    }
});

// Other existing functions
// Add New AI System Modal Functions
function openAddSystemModal() {
    document.getElementById('add-system-modal').classList.remove('hidden');
}

function closeAddSystemModal() {
    document.getElementById('add-system-modal').classList.add('hidden');
    // Reset form
    document.getElementById('add-system-form').reset();
    document.getElementById('add-system-file-input').value = '';
    document.getElementById('add-system-file-name').textContent = 'Choose file...';
}

function aiReadAndAutoFill() {
    const fileInput = document.getElementById('add-system-file-input');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file first');
        return;
    }
    
    // TODO: Implement AI read and auto-fill logic
    alert('AI Read & Auto-fill functionality coming soon');
}

async function createAISystem() {
    const form = document.getElementById('add-system-form');
    const formData = new FormData(form);
    
    // Validate required field
    const systemName = formData.get('system_name');
    if (!systemName || !systemName.trim()) {
        alert('AI System Name is required');
        return;
    }
    
    // Collect role values (multi-select checkboxes)
    const roleCheckboxes = form.querySelectorAll('input[name="role"]:checked');
    const roles = Array.from(roleCheckboxes).map(cb => cb.value);
    
    // Get file if selected - upload first if file exists
    const fileInput = document.getElementById('add-system-file-input');
    let uploadedFileInfo = null;
    
    if (fileInput.files[0]) {
        try {
            // Upload file using shared API
            const uploadFormData = new FormData();
            uploadFormData.append('file', fileInput.files[0]);
            uploadFormData.append('folder', 'governance/uploads');
            
            const uploadResponse = await fetch('/api/upload-file/', {
                method: 'POST',
                body: uploadFormData
            });
            
            const uploadResult = await uploadResponse.json();
            
            if (uploadResult.success && uploadResult.files && uploadResult.files.length > 0) {
                uploadedFileInfo = uploadResult.files[0];
                console.log('File uploaded successfully:', uploadedFileInfo);
            } else {
                console.warn('File upload failed or no files returned');
            }
        } catch (error) {
            console.error('Error uploading file:', error);
            // Continue with creation even if file upload fails
        }
    }
    
    // Prepare data for API
    const systemData = {
        name: systemName.trim(),
        owner: formData.get('owner') || 'Not provided',
        status: formData.get('status') || 'Planned',
        roles: roles.length > 0 ? roles : ['Provider'], // Default to Provider if none selected
        provider_type: formData.get('provider_type') || 'Unknown',
        risk_classification: formData.get('risk_classification') || 'Not assessed',
        compliance_status: formData.get('compliance_status') || 'Not started',
        deployment_context: formData.get('deployment_context') || '',
        eu_eea_relevance: formData.get('eu_eea_relevance') || ''
    };
    
    // Add file info if uploaded
    if (uploadedFileInfo) {
        systemData.document = {
            name: uploadedFileInfo.name,
            url: uploadedFileInfo.url,
            path: uploadedFileInfo.path,
            size: uploadedFileInfo.size
        };
    }
    
    // Send to backend API
    try {
        const response = await fetch('/api/ai-inventory/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(systemData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('AI System created successfully!');
            closeAddSystemModal();
            location.reload(); // Reload page to show new system
        } else {
            alert('Error creating AI System: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating AI System');
    }
}

// File input change handler for Add System modal
document.getElementById('add-system-file-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileNameEl = document.getElementById('add-system-file-name');
    const aiReadBtn = document.getElementById('ai-read-btn');
    if (file) {
        // Truncate long file names (max 40 characters)
        const maxLength = 40;
        let displayName = file.name;
        if (file.name.length > maxLength) {
            const extension = file.name.substring(file.name.lastIndexOf('.'));
            const nameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
            const truncatedName = nameWithoutExt.substring(0, maxLength - extension.length - 3) + '...';
            displayName = truncatedName + extension;
        }
        fileNameEl.textContent = displayName;
        fileNameEl.setAttribute('title', file.name); // Show full name on hover
        fileNameEl.classList.remove('text-[#B5BCC4]');
        fileNameEl.classList.add('text-[#22262A]');
        if (aiReadBtn) aiReadBtn.disabled = false;
    } else {
        fileNameEl.textContent = 'Choose file...';
        fileNameEl.removeAttribute('title');
        fileNameEl.classList.remove('text-[#22262A]');
        fileNameEl.classList.add('text-[#B5BCC4]');
        if (aiReadBtn) aiReadBtn.disabled = true;
    }
});

// Close add system modal when clicking outside
document.getElementById('add-system-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddSystemModal();
    }
});

function viewSystemDetails(agentId) {
    window.location.href = '{% url "ai_system_detail" 0 %}'.replace('0', agentId);
}

// Row click handler
document.querySelectorAll('.system-row').forEach(row => {
    row.addEventListener('click', function() {
        const agentId = this.getAttribute('data-agent-id');
        if (agentId) {
            viewSystemDetails(agentId);
        }
    });
});

// Search functionality (kết hợp với pagination)
document.getElementById('search-input')?.addEventListener('input', function(e) {
    searchTermFilter = e.target.value.toLowerCase();

    // Reset về trang 1 và re-render pagination sau khi search
    currentPage = 1;
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
    updateSelectedCount();
});

// Checkbox Selection Management
let selectedSystemIds = [];

function updateSelectedCount() {
    const count = selectedSystemIds.length;
    const display = document.getElementById('selected-count-display');
    const countSpan = document.getElementById('selected-count');
    const deleteBtn = document.getElementById('delete-selected-btn');
    
    if (count > 0) {
        display.classList.remove('hidden');
        countSpan.textContent = count;
        deleteBtn.classList.remove('hidden');
    } else {
        display.classList.add('hidden');
        deleteBtn.classList.add('hidden');
    }
    
    // Update select all checkbox - only check current page (based on React code)
    const selectAll = document.getElementById('select-all-checkbox');
    const rows = Array.from(document.querySelectorAll('tbody tr:not([style*="display: none"])'));
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const currentPageRows = rows.slice(startIndex, endIndex);
    const currentPageCheckboxes = currentPageRows
        .map(row => row.querySelector('.system-checkbox'))
        .filter(cb => cb !== null);
    const checkedCount = currentPageCheckboxes.filter(cb => {
        const systemId = cb.dataset.systemId;
        return cb.checked && selectedSystemIds.includes(systemId);
    }).length;
    
    if (currentPageCheckboxes.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
    } else if (checkedCount === currentPageCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
    } else if (checkedCount > 0) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
    } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
    }
}

function toggleSelectAll(e) {
    // Only select/deselect checkboxes on current page (based on React code)
    const rows = Array.from(document.querySelectorAll('tbody tr:not([style*="display: none"])'));
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const currentPageRows = rows.slice(startIndex, endIndex);
    
    currentPageRows.forEach(row => {
        const checkbox = row.querySelector('.system-checkbox');
        if (checkbox) {
            checkbox.checked = e.target.checked;
            const systemId = checkbox.dataset.systemId;
            if (e.target.checked) {
                if (!selectedSystemIds.includes(systemId)) {
                    selectedSystemIds.push(systemId);
                }
            } else {
                selectedSystemIds = selectedSystemIds.filter(id => id !== systemId);
            }
        }
    });
    updateSelectedCount();
}

function toggleSystemSelect(checkbox) {
    const systemId = checkbox.dataset.systemId;
    if (checkbox.checked) {
        if (!selectedSystemIds.includes(systemId)) {
            selectedSystemIds.push(systemId);
        }
    } else {
        selectedSystemIds = selectedSystemIds.filter(id => id !== systemId);
    }
    updateSelectedCount();
}

async function deleteSelectedSystems() {
    if (selectedSystemIds.length === 0) return;
    
    const confirmDelete = confirm(
        `Are you sure you want to delete ${selectedSystemIds.length} selected system${selectedSystemIds.length > 1 ? 's' : ''}? This action cannot be undone.`
    );
    
    if (!confirmDelete) {
        return;
    }
    
    // Convert system IDs to integers to match backend data format
    const systemIdsInt = selectedSystemIds.map(id => parseInt(id, 10)).filter(id => !isNaN(id));
    
    if (systemIdsInt.length === 0) {
        alert('No valid system IDs found');
        return;
    }
    
    console.log('Deleting systems with IDs:', systemIdsInt);
    
    try {
        const response = await fetch('/api/ai-inventory/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ system_ids: systemIdsInt })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.deleted_count || systemIdsInt.length} system${(data.deleted_count || systemIdsInt.length) > 1 ? 's' : ''} deleted successfully!`);
            location.reload();
        } else {
            alert('Error deleting systems: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting systems: ' + error.message);
    }
}

// Initialize checkbox handlers
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    document.getElementById('select-all-checkbox')?.addEventListener('change', toggleSelectAll);
    
    // Individual checkboxes
    document.querySelectorAll('.system-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            toggleSystemSelect(this);
        });
    });
    
    // Update initial count
    updateSelectedCount();
});

// Pagination (based on React code)
let currentPage = 1;
const itemsPerPage = 10;
let searchTermFilter = '';

function getTotalPages() {
    // Tính tổng dựa trên các dòng data phù hợp với search (nếu có)
    const rows = Array.from(document.querySelectorAll('tbody tr.system-row'));
    const visibleRows = rows.filter(row => {
        if (!searchTermFilter) return true;
        const text = row.textContent.toLowerCase();
        return text.includes(searchTermFilter);
    });
    return Math.max(1, Math.ceil(visibleRows.length / itemsPerPage));
}

function changePage(direction) {
    const totalPages = getTotalPages();
    const newPage = currentPage + direction;
    
    if (newPage < 1 || newPage > totalPages) {
        return;
    }
    
    currentPage = newPage;
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
    updateSelectedCount(); // Update checkbox states after page change
}

function goToPage(page) {
    const totalPages = getTotalPages();
    if (page < 1 || page > totalPages) {
        return;
    }
    
    currentPage = page;
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
    updateSelectedCount(); // Update checkbox states after page change
}

function renderTablePage() {
    // Phân trang trên tập dòng data đã được filter bởi search (nếu có)
    const allRows = Array.from(document.querySelectorAll('tbody tr.system-row'));
    const filteredRows = allRows.filter(row => {
        if (!searchTermFilter) return true;
        const text = row.textContent.toLowerCase();
        return text.includes(searchTermFilter);
    });

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;

    // Ẩn tất cả trước
    allRows.forEach(row => {
        row.style.display = 'none';
    });

    // Chỉ hiển thị các dòng thuộc trang hiện tại trong tập đã filter
    filteredRows.forEach((row, index) => {
        if (index >= startIndex && index < endIndex) {
            row.style.display = '';
        }
    });
}

function updatePaginationButtons() {
    const totalPages = getTotalPages();
    const prevBtn = document.getElementById('pagination-prev');
    const nextBtn = document.getElementById('pagination-next');
    
    if (prevBtn) {
        prevBtn.disabled = currentPage === 1;
    }
    if (nextBtn) {
        nextBtn.disabled = currentPage === totalPages;
    }
}

function renderPageNumbers() {
    const totalPages = getTotalPages();
    const container = document.getElementById('pagination-numbers');
    if (!container) return;
    
    const pages = [];
    const maxVisible = 7;
    
    if (totalPages <= maxVisible) {
        for (let i = 1; i <= totalPages; i++) {
            pages.push(i);
        }
    } else {
        if (currentPage <= 3) {
            pages.push(1, 2, 3, '...', totalPages - 1, totalPages);
        } else if (currentPage >= totalPages - 2) {
            pages.push(1, 2, '...', totalPages - 2, totalPages - 1, totalPages);
        } else {
            pages.push(1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages);
        }
    }
    
    container.innerHTML = '';
    pages.forEach((page, index) => {
        if (typeof page === 'number') {
            const button = document.createElement('button');
            button.className = `px-4 py-2 ${
                currentPage === page 
                    ? 'bg-[#F13D30] text-white border border-[#F13D30]' 
                    : 'bg-white border border-[#B5BCC4] text-[#464E58] hover:bg-[#F0F1F2]'
            } rounded-lg font-semibold text-sm transition-colors`;
            button.textContent = page;
            button.onclick = () => goToPage(page);
            container.appendChild(button);
        } else {
            const span = document.createElement('span');
            span.className = 'px-2 text-[#B5BCC4] font-semibold text-sm';
            span.textContent = page;
            container.appendChild(span);
        }
    });
}

// Initialize pagination on page load
document.addEventListener('DOMContentLoaded', function() {
    renderTablePage();
    renderPageNumbers();
    updatePaginationButtons();
});
</script>
{% endblock %}
