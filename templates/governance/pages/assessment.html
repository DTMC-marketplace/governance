{% extends "governance/base.html" %}
{% load i18n %}
{% load static %}
{% load custom_filters %}

{% block dashboard_content %}
<div class="flex flex-col gap-5">
    <!-- Breadcrumb Navigation -->
    <div class="flex items-center gap-3 pb-4">
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center"
            onclick="history.back()">
            <img src="{% static 'governance/img/arrow-left.svg' %}" alt="Back" class="w-3.5 h-3.5">
        </button>
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center"
            onclick="history.forward()">
            <img src="{% static 'governance/img/arrow-right-gray.svg' %}" alt="Forward" class="w-3.5 h-3.5">
        </button>
        <span class="text-sm font-semibold text-[#F13D30]">{% trans "Questionnaires" %}</span>
    </div>

    <!-- Page Header -->
    <div class="flex justify-between items-start">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-[#22262A]" id="page-title">
                {% if agent_name %}{{ agent_name }}{% else %}{% trans "Agent use cases mapping" %}{% endif %}
            </h1>
            <p class="text-sm text-[#6B7280] mt-1" id="page-subtitle">
                {% if agent_name %}{% blocktrans %}Review questionnaires and assessment for {{ agent_name }}{% endblocktrans %}{% else %}{% trans "Review data and information of agent use cases" %}{% endif %}
            </p>
        </div>
    </div>

    <hr class="border-t border-[#E5E7EB]">

    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold text-[#1a1a2e] mb-1">{% trans "Questionnaires" %}</h1>
            <p class="text-sm text-[#565F6C]">{% trans "Choose an AI assistant questionnaires to assess your compliance levels" %}</p>
        </div>
        <button
            class="flex items-center gap-2 px-4 py-2.5 bg-white border border-[#F13D30] rounded-full text-sm font-semibold text-[#F13D30] cursor-pointer hover:bg-[#FEF2F2] transition-colors">
            <img src="/static/icons/icon-benchmarking.svg" alt="{% trans 'Add' %}" class="w-4 h-4">
            {% trans "Add AI Agent" %}
        </button>
    </div>

    <!-- Toolbar -->
    <div class="flex justify-between items-center py-3 mb-4">
        <div class="flex items-center gap-4">
            <button
                class="flex items-center gap-1.5 px-3 py-2 border-none bg-transparent text-sm font-medium text-[#374151] cursor-pointer rounded-md transition-colors duration-200 hover:bg-[#F3F4F6]">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <line x1="4" y1="6" x2="20" y2="6" />
                    <line x1="4" y1="12" x2="14" y2="12" />
                    <line x1="4" y1="18" x2="8" y2="18" />
                </svg>
                Filter
            </button>
            <button
                class="flex items-center gap-1.5 px-3 py-2 border-none bg-transparent text-sm font-medium text-[#374151] cursor-pointer rounded-md transition-colors duration-200 hover:bg-[#F3F4F6]">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <line x1="7" y1="3" x2="7" y2="21" />
                    <line x1="17" y1="21" x2="17" y2="3" />
                    <polyline points="3,7 7,3 11,7" />
                    <polyline points="21,17 17,21 13,17" />
                </svg>
                Sort
            </button>
            <div class="flex items-center">
                <form class="w-full mx-auto" method="get" action="">
                    <div class="relative">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 20 20">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
                            </svg>
                        </div>
                        <input type="search" id="default-search" name="search" value="{{ search_term|default:'' }}"
                            class="block w-full p-4 !rounded-full text-sm" placeholder="{% trans 'Search' %}"
                            style="padding-inline-start: 1rem; text-indent: 1rem;" />
                    </div>
                </form>
            </div>
        </div>
        <div class="flex items-center space-x-4 text-gray-700">
            <span class="text-sm whitespace-nowrap">{% trans "Rows per page:" %}</span>
            <select id="rowsPerPage"
                class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-blue-300 w-20">
                <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if limit == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
            </select>
            <span class="text-sm text-gray-500">{% if page_obj %}{{ page_obj.start_index }} - {{ page_obj.end_index }}
                of {{ page_obj.paginator.count }}{% else %}1-10 of 135{% endif %}</span>

            <div class="flex items-center space-x-1">
                <!-- First Page Button -->
                <a href="?page=1&limit={% if limit %}{{ limit }}{% else %}10{% endif %}"
                    class="{% if page_obj and not page_obj.has_previous %}opacity-50 pointer-events-none{% endif %}">
                    <button
                        class="rounded-md p-1 text-gray-500 hover:text-blue-500 focus:outline-none focus:ring-blue-300">
                        <img src="/static/icons/Icon-2lt.svg" class="w-3 h-3" />
                    </button>
                </a>

                <!-- Previous Page Button -->
                {% if page_obj and page_obj.has_previous %}
                <a
                    href="?page={{ page_obj.previous_page_number }}&limit={% if limit %}{{ limit }}{% else %}10{% endif %}">
                    <button
                        class="rounded-md p-1 text-gray-500 hover:text-blue-500 focus:outline-none focus:ring-blue-300">
                        <img src="/static/icons/Icon-lt.svg" class="w-3 h-3" />
                    </button>
                </a>
                {% else %}
                <button class="rounded-md p-1 text-gray-300 cursor-not-allowed opacity-50" disabled>
                    <img src="/static/icons/Icon-lt.svg" class="w-3 h-3" />
                </button>
                {% endif %}

                <!-- Next Page Button -->
                {% if page_obj and page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&limit={% if limit %}{{ limit }}{% else %}10{% endif %}">
                    <button
                        class="rounded-md p-1 text-gray-500 hover:text-blue-500 focus:outline-none focus:ring-blue-300">
                        <img src="/static/icons/Icon-gt.svg" class="w-3 h-3" />
                    </button>
                </a>
                {% else %}
                <button class="rounded-md p-1 text-gray-300 cursor-not-allowed opacity-50" disabled>
                    <img src="/static/icons/Icon-gt.svg" class="w-3 h-3" />
                </button>
                {% endif %}

                <!-- Last Page Button -->
                <a href="?page={% if page_obj %}{{ page_obj.paginator.num_pages }}{% else %}1{% endif %}&limit={% if limit %}{{ limit }}{% else %}10{% endif %}"
                    class="{% if page_obj and not page_obj.has_next %}opacity-50 pointer-events-none{% endif %}">
                    <button class="rounded-md p-1 text-gray-500 focus:outline-none hover:text-blue-500">
                        <img src="/static/icons/Icon-2gt.svg" class="w-3 h-3" />
                    </button>
                </a>
            </div>
        </div>
    </div>

    <!-- AI Agent Cards - Always show 3 governance agents -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        {% for agent_item in all_agents %}
        <div
            class="bg-white rounded-2xl border border-[#E5E7EB] p-5 flex flex-col gap-3 cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg"
            onclick="window.location.href='?agent={{ agent_item.name|urlencode }}'">
            <div class="flex items-center justify-between">
                {% if agent_item.avatar_url %}
                <img src="{{ agent_item.avatar_url }}" alt="{{ agent_item.name }}" class="w-16 h-16 object-contain">
                {% else %}
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[#3B82F6] to-[#8B5CF6] flex items-center justify-center text-white font-bold text-xl">
                    {{ agent_item.name|slice:":1"|upper }}
            </div>
                {% endif %}
                <span
                    class="inline-flex items-center px-3 py-1 bg-[#D1FAE5] rounded-full text-xs font-medium text-[#065F46]">{% trans "Governance" %}</span>
            </div>
            <h3 class="text-lg font-bold text-[#1f2937]">{{ agent_item.name }}</h3>
            <p class="text-sm text-[#6b7280]">
                {% if agent_item.description %}
                    {{ agent_item.description }}
                {% elif agent_item.get_ai_act_role_display %}
                    {{ agent_item.get_ai_act_role_display }} - {{ agent_item.get_risk_classification_display }}
                {% else %}
                    Governance agent
                {% endif %}
            </p>
            <button
                class="w-fit px-5 py-2 bg-[#F13D30] text-white border-none rounded-lg text-sm font-semibold cursor-pointer hover:bg-[#DC180A] transition-colors">
                {% trans "View Questionnaires" %}
            </button>
        </div>
        {% empty %}
        <div class="col-span-3 text-center py-8 text-sm text-[#6B7280]">
            {% trans "No agents found." %} <a href="{% url 'ai_systems' %}" class="text-[#2563EB] hover:underline">{% trans "Create an agent" %}</a> {% trans "first." %}
            </div>
        {% endfor %}
    </div>

    {% if agent %}
    <!-- Use cases assessment progress -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6 mb-6">
        <h3 class="text-lg font-bold text-[#1f2937] mb-6">{% trans "Use cases assessment progress" %}</h3>
        {% with assessing_count=use_cases_data|length|default:0 reviewing_count=0 cleared_count=0 %}
        {% for use_case_data in use_cases_data %}
            {% if use_case_data.use_case.compliance_status == 'assessing' %}
                {% with assessing_count=assessing_count|add:1 %}{% endwith %}
            {% elif use_case_data.use_case.compliance_status == 'reviewing' %}
                {% with reviewing_count=reviewing_count|add:1 %}{% endwith %}
            {% elif use_case_data.use_case.compliance_status == 'cleared' %}
                {% with cleared_count=cleared_count|add:1 %}{% endwith %}
            {% endif %}
        {% endfor %}
        <div class="flex items-center justify-between">
            <div class="flex flex-col items-center gap-3 flex-1">
                <div class="w-16 h-16 rounded-full {% if assessing_count > 0 %}bg-[#F13D30]{% else %}bg-[#FECACA]{% endif %} border-4 flex items-center justify-center">
                    {% if assessing_count > 0 %}<span class="text-white font-bold">{{ assessing_count }}</span>{% endif %}
                </div>
                <span class="text-sm font-medium text-[#111827] text-center">{% trans "Assessing" %}</span>
            </div>
            <div class="flex-1 h-0.5 bg-[#6B7280] mx-4"></div>
            <div class="flex flex-col items-center gap-3 flex-1">
                <div class="w-16 h-16 rounded-full {% if reviewing_count > 0 %}bg-[#F13D30]{% else %}bg-[#FECACA]{% endif %} flex items-center justify-center">
                    {% if reviewing_count > 0 %}<span class="text-white font-bold">{{ reviewing_count }}</span>{% endif %}
                </div>
                <span class="text-sm font-medium text-[#111827] text-center">{% trans "Reviewing assessment" %}</span>
            </div>
            <div class="flex-1 h-0.5 bg-[#6B7280] mx-4"></div>
            <div class="flex flex-col items-center gap-3 flex-1">
                <div class="w-16 h-16 rounded-full {% if cleared_count > 0 %}bg-[#10B981]{% else %}bg-[#FECACA]{% endif %} flex items-center justify-center">
                    {% if cleared_count > 0 %}<span class="text-white font-bold">{{ cleared_count }}</span>{% endif %}
                </div>
                <span class="text-sm font-medium text-[#111827] text-center">{% trans "Cleared" %}</span>
            </div>
        </div>
        {% endwith %}
    </div>
    {% endif %}

    {% if agent or selected_use_case %}
    <!-- AI Use Case compliance alignment -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6 mb-6">
        <h3 class="text-xl font-bold text-[#22262A] mb-4">{% trans "AI Use Case compliance alignment" %}</h3>
        {% if selected_use_case %}
            {% with compliance=selected_use_case.calculate_compliance %}
        <table class="w-full border-collapse">
            <thead>
                <tr>
                        <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">{% trans "EU AI Act" %}</th>
                        <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">{% trans "GDPR" %}</th>
                        <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">{% trans "Data Act" %}</th>
                        <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">{% trans "Edit" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                        <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4]">
                            {% if compliance.eu_ai_act %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                            {% elif compliance.status == 'partial' %}
                                <span class="text-xs text-[#92400E]">⚠ Limited risks</span>
                            {% else %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#FEE2E2] text-[#991B1B] text-xs">✗</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4]">
                            {% if compliance.gdpr %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                            {% elif compliance.status == 'partial' %}
                                <span class="text-xs text-[#92400E]">⚠ Limited risks</span>
                            {% else %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#FEE2E2] text-[#991B1B] text-xs">✗</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4] {% if not compliance.data_act %}bg-[#FFF9E6]{% endif %}">
                            {% if compliance.data_act %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                            {% else %}
                                Not applicable
                            {% endif %}
                        </td>
                    <td class="py-3 px-4 text-center border-b flex items-center justify-center border-[#B5BCC4]">
                        <button
                            class="w-8 h-8 flex items-center justify-center text-[#6B7280] hover:bg-[#F3F4F6] rounded cursor-pointer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
            {% endwith %}
        {% elif agent and use_cases_data %}
            {% with first_use_case=use_cases_data.0.use_case compliance=use_cases_data.0.compliance %}
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">EU AI Act</th>
                    <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">GDPR</th>
                    <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">Data Act</th>
                    <th class="py-3 px-4 text-center text-sm font-medium text-[#6B7280] border-b border-[#B5BCC4]">Edit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4]">
                        {% if compliance.eu_ai_act %}
                            <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                        {% elif compliance.status == 'partial' %}
                            <span class="text-xs text-[#92400E]">⚠ Limited risks</span>
                        {% else %}
                            <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#FEE2E2] text-[#991B1B] text-xs">✗</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4]">
                        {% if compliance.gdpr %}
                            <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                        {% elif compliance.status == 'partial' %}
                            <span class="text-xs text-[#92400E]">⚠ Limited risks</span>
                        {% else %}
                            <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#FEE2E2] text-[#991B1B] text-xs">✗</span>
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-center text-sm font-medium text-[#22262A] border-b border-[#B5BCC4] {% if not compliance.data_act %}bg-[#FFF9E6]{% endif %}">
                        {% if compliance.data_act %}
                            <span class="w-5 h-5 inline-flex items-center justify-center rounded-full bg-[#D1FAE5] text-[#065F46] text-xs">✓</span>
                        {% else %}
                            Not applicable
                        {% endif %}
                    </td>
                    <td class="py-3 px-4 text-center border-b flex items-center justify-center border-[#B5BCC4]">
                        <button
                            class="w-8 h-8 flex items-center justify-center text-[#6B7280] hover:bg-[#F3F4F6] rounded cursor-pointer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
            {% endwith %}
        {% else %}
            <p class="text-sm text-[#6B7280] text-center py-4">{% trans "Select a use case from the table above to view compliance alignment" %}</p>
        {% endif %}
    </div>
    {% endif %}

    {% if selected_use_case %}
    <!-- AI Use Case information -->
    <div class="bg-[#EFF6FF] rounded-lg border border-[#BFDBFE] p-6 mb-6">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <p class="text-sm font-bold text-[#111827] mb-3">Name: {{ selected_use_case.name }}</p>
                <div class="flex flex-col gap-2">
                    <p class="text-sm text-[#374151]">Overview: {{ selected_use_case.get_overview_display }}</p>
                    <p class="text-sm text-[#374151]">Models: {% for model in selected_use_case.use_case_model_relations.all %}{{ model.model.name }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
                    <p class="text-sm text-[#374151]">Datasets: {% for dataset in selected_use_case.use_case_dataset_relations.all %}{{ dataset.dataset.name }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
                    <p class="text-sm text-[#374151]">Review Status: {{ selected_use_case.get_review_status_display }}</p>
                </div>
            </div>
            <div class="flex flex-col items-center gap-2">
                <span class="text-sm font-medium text-[#374151]">{% trans "AI Act Alignment" %}</span>
                {% with compliance=selected_use_case.calculate_compliance %}
                <div class="w-6 h-6 rounded-full {% if compliance.eu_ai_act %}bg-[#10B981]{% elif compliance.status == 'partial' %}bg-[#FCD34D]{% else %}bg-[#EF4444]{% endif %} flex items-center justify-center">
                    {% if compliance.eu_ai_act or compliance.status == 'partial' %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" class="w-4 h-4">
                        <polyline points="20,6 9,17 4,12" />
                    </svg>
                    {% else %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" class="w-4 h-4">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    {% endif %}
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
    {% elif agent and use_cases_data %}
    <!-- AI Use Case information -->
    <div class="bg-[#EFF6FF] rounded-lg border border-[#BFDBFE] p-6 mb-6">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <p class="text-sm font-bold text-[#111827] mb-3">Name: {{ use_cases_data.0.use_case.name }}</p>
                <div class="flex flex-col gap-2">
                    <p class="text-sm text-[#374151]">Overview: {{ use_cases_data.0.use_case.get_overview_display }}</p>
                    <p class="text-sm text-[#374151]">Models: {% for model in use_cases_data.0.models %}{{ model.name }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
                    <p class="text-sm text-[#374151]">Datasets: {% for dataset in use_cases_data.0.datasets %}{{ dataset.name }}{% if not forloop.last %}, {% endif %}{% empty %}None{% endfor %}</p>
                    <p class="text-sm text-[#374151]">Review Status: {{ use_cases_data.0.use_case.get_review_status_display }}</p>
                </div>
            </div>
            <div class="flex flex-col items-center gap-2">
                <span class="text-sm font-medium text-[#374151]">{% trans "AI Act Alignment" %}</span>
                {% with compliance=use_cases_data.0.compliance %}
                <div class="w-6 h-6 rounded-full {% if compliance.eu_ai_act %}bg-[#10B981]{% elif compliance.status == 'partial' %}bg-[#FCD34D]{% else %}bg-[#EF4444]{% endif %} flex items-center justify-center">
                    {% if compliance.eu_ai_act or compliance.status == 'partial' %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" class="w-4 h-4">
                        <polyline points="20,6 9,17 4,12" />
                    </svg>
                    {% else %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" class="w-4 h-4">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    {% endif %}
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Evidences Section -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6 mb-6">
        <h3 class="text-lg font-semibold text-[#111827] mb-4">{% trans "Evidences" %}</h3>

        {% if agent or selected_use_case %}
        <!-- Document List -->
        <div id="evidencesList" class="mb-4 space-y-2">
            {% if evidences %}
                {% for evidence in evidences %}
                <div class="flex items-center justify-between p-3 bg-[#F9FAFB] rounded-lg border border-[#E5E7EB] evidence-item" data-evidence-id="{{ evidence.id }}">
                <div class="flex items-center gap-3">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        class="w-5 h-5 text-[#DC2626]">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14,2 14,8 20,8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10,9 9,9 8,9" />
                    </svg>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-[#4B5563]">{{ evidence.file_name }}</span>
                            {% if agent and not selected_use_case %}
                            <span class="text-xs text-[#6B7280]">From: {{ evidence.use_case.name }}</span>
                            {% endif %}
                </div>
                    </div>
                    <button onclick="deleteEvidence({{ evidence.id }}, {{ evidence.use_case.id }})"
                    class="w-8 h-8 flex items-center justify-center text-[#DC2626] hover:bg-[#FEE2E2] rounded cursor-pointer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <polyline points="3,6 5,6 21,6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                </button>
            </div>
                {% endfor %}
            {% else %}
                <p class="text-sm text-[#6B7280] text-center py-4">
                    {% if agent or selected_use_case %}
                        {% trans "No evidences uploaded yet. Upload files below." %}
                    {% else %}
                        {% trans "No evidences uploaded yet. Select a use case or agent and upload files below." %}
                    {% endif %}
                </p>
            {% endif %}
        </div>

        <!-- Drag and Drop Area -->
        <div id="evidenceUploadArea"
            class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-12 text-center bg-[#F9FAFB] hover:border-[#9CA3AF] transition-colors cursor-pointer mb-4">
            <input type="file" id="evidenceFileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.xls,.xlsx" class="hidden">
            <div class="flex flex-col items-center gap-4">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="w-8 h-8 text-[#6B7280]">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17,8 12,3 7,8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                <div class="flex flex-col gap-1">
                    <p class="text-sm font-medium text-[#374151]">{% trans "Click or drag and drop to add evidence documents" %}</p>
                    <p class="text-xs text-[#6B7280]">{% trans "PDF, DOC, JPG, XLS (Max 5GB per file)" %}</p>
                </div>
            </div>
        </div>
        {% else %}
        <div class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-12 text-center bg-[#F9FAFB] mb-4">
            <p class="text-sm text-[#6B7280]">{% trans "Please select an agent or use case from the table above to upload evidences" %}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Evaluation report Section -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6 mb-6">
        <h3 class="text-lg font-semibold text-[#111827] mb-4">{% trans "Evaluation report" %}</h3>
        
        {% if agent or selected_use_case %}
        <div class="flex flex-col gap-3" id="evaluationReportsList">
            <!-- 8 Report Types (all optional) -->
            {% for report_type, report_label in report_types %}
                {% if reports_dict|get_item:report_type %}
                    {% with report=reports_dict|get_item:report_type %}
                    <div class="evaluation-report-item flex items-center justify-between p-3 rounded-lg border bg-white border-green-500 cursor-pointer hover:bg-[#F9FAFB] report-upload-area" data-report-type="{{ report_type }}" onclick="triggerReportUpload('{{ report_type }}'); event.stopPropagation();">
                        <div class="flex items-center gap-3 flex-1">
                            <img src="{% static 'icons/file-icon.svg' %}" alt="Report" class="w-5 h-5">
                            <div class="flex flex-col flex-1">
                                <span class="text-sm font-medium text-[#111827]">{{ report_label }}</span>
                                <span class="text-xs text-[#6B7280]">{{ report.file_name }}</span>
                                {% if agent and not selected_use_case %}
                                <span class="text-xs text-[#9CA3AF]">From: {{ report.use_case.name }}</span>
                                {% endif %}
                    </div>
                            <div class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center mr-4">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" class="w-3 h-3">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </div>
                </div>
                        <div class="flex items-center gap-3" onclick="event.stopPropagation();">
                            <input type="file" id="report_{{ report_type }}" class="hidden" accept=".xlsx,.json,.csv" data-report-type="{{ report_type }}">
                            {% if report.file.file_url or report.file_url %}
                            <a href="{{ report.file.file_url|default:report.file_url }}" target="_blank" class="text-xs text-[#2563EB] hover:underline" onclick="event.stopPropagation();">View</a>
                            {% endif %}
                            <button onclick="deleteEvaluationReport('{{ report_type }}', {{ report.id }}, {{ report.use_case.id }}); event.stopPropagation();" class="flex items-center gap-1.5 text-[#111827] hover:text-[#DC2626] cursor-pointer">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                            <polyline points="3,6 5,6 21,6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        <span class="text-sm font-medium">Delete</span>
                    </button>
                </div>
            </div>
                    {% endwith %}
                {% else %}
                <div class="evaluation-report-item flex items-center justify-between p-3 rounded-lg border bg-[#F9FAFB] border-2 border-dashed border-[#D1D5DB] cursor-pointer report-upload-area" data-report-type="{{ report_type }}" onclick="triggerReportUpload('{{ report_type }}'); event.stopPropagation();">
                    <div class="flex items-center gap-3 flex-1">
                        <img src="{% static 'icons/file-icon.svg' %}" alt="Report" class="w-5 h-5">
                        <div class="flex flex-col flex-1">
                            <span class="text-sm font-medium text-[#4B5563]">{{ report_label }}</span>
                            <span class="text-xs text-[#6B7280]">.xlsx / .json / .csv</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                        <input type="file" id="report_{{ report_type }}" class="hidden" accept=".xlsx,.json,.csv" data-report-type="{{ report_type }}">
                        <span class="text-xs text-[#6B7280] cursor-pointer hover:text-[#2563EB]">Click or drag to upload</span>
                </div>
            </div>
                {% endif %}
            {% endfor %}
                    </div>
        {% else %}
        <div class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-12 text-center bg-[#F9FAFB]">
            <p class="text-sm text-[#6B7280]">{% trans "Please select an agent or use case from the table above to upload evaluation reports" %}</p>
                </div>
        {% endif %}
    </div>

    <!-- Governance Plan Section -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <img src="/static/icons/icon-benchmarking.svg" alt="Dataset" class="w-5 h-5">
                <div>
                    <h3 class="text-lg font-semibold text-[#111827]">Governance Plan</h3>
                    <p class="text-sm text-[#6B7280] mt-1">Risks types</p>
                </div>
            </div>
            <button class="flex items-center gap-2 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm font-medium text-[#374151] hover:bg-[#F9FAFB] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <polyline points="23,4 23,10 17,10"/>
                    <polyline points="1,20 1,14 7,14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Refresh
            </button>
        </div>

        <div class="flex flex-col">
            <!-- Information integrity -->
            <div class="py-4 border-b border-[#E5E7EB]">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold text-[#111827]">Information integrity</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#F3F4F6] text-[#374151]">3 alerts</span>
                    </div>
                    <a href="#" class="text-sm font-medium text-[#374151] hover:underline">View & Mitigate</a>
                </div>
                <p class="text-sm text-[#6B7280]">Row 245: invalid LEI format</p>
            </div>

            <!-- Harmful content -->
            <div class="py-4 border-b border-[#E5E7EB]">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold text-[#111827]">Harmful content</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#F3F4F6] text-[#374151]">1 alert</span>
                    </div>
                    <a href="#" class="text-sm font-medium text-[#374151] hover:underline">View & Mitigate</a>
                </div>
                <p class="text-sm text-[#6B7280]">Row 89: missing ISIN mapping</p>
            </div>

            <!-- Evasion attacks -->
            <div class="py-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold text-[#111827]">Evasion attacks</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#F3F4F6] text-[#374151]">no alert</span>
                    </div>
                    <a href="#" class="text-sm font-medium text-[#374151] hover:underline">View & Mitigate</a>
                </div>
                <p class="text-sm text-[#6B7280]">1,247 rows processed</p>
            </div>
        </div>
    </div>

    <!-- Review comments Section -->
    <div class="bg-white rounded-lg border border-[#E5E7EB] p-6 mb-4">
        <h3 class="text-lg font-semibold text-[#111827] mb-4">Review comments</h3>

        {% if agent or selected_use_case %}
        <!-- Comment Input -->
        <div class="mb-6">
            <textarea 
                id="newCommentTextarea"
                class="w-full p-3 border border-[#D1D5DB] rounded-lg text-sm text-[#374151] focus:outline-none focus:ring-2 focus:ring-[#2563EB] focus:border-transparent resize-none"
                rows="3"
                placeholder="Add a comment..."></textarea>
            <div class="flex justify-end gap-3 mt-3">
                <button onclick="cancelComment()" class="px-4 py-2 border border-[#D1D5DB] rounded-lg text-sm font-medium text-[#374151] hover:bg-[#F9FAFB] transition-colors">
                    Cancel
                </button>
                <button onclick="submitComment()" class="px-4 py-2 bg-[#2563EB] border-none rounded-lg text-sm font-medium text-white hover:bg-[#1D4ED8] transition-colors">
                    Send Comments
                </button>
            </div>
        </div>

        <!-- Comments List -->
        <div id="commentsList" class="flex flex-col gap-4">
            {% if review_comments %}
                {% for comment in review_comments %}
                <div class="comment-item" data-comment-id="{{ comment.id }}">
            <div class="flex gap-3">
                        {% with initials=comment.author.username|slice:":2"|upper %}
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#3B82F6] to-[#8B5CF6] flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                            {{ initials }}
                </div>
                        {% endwith %}
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-semibold text-[#111827]">{{ comment.author.username|default:"Anonymous" }}</span>
                                <span class="text-xs text-[#6B7280]">{{ comment.created_at|timesince }} ago</span>
                                {% if agent and not selected_use_case %}
                                <span class="text-xs text-[#9CA3AF]">On: {{ comment.use_case.name }}</span>
                                {% endif %}
                    </div>
                            <p class="text-sm text-[#4B5563] mb-2">{{ comment.content }}</p>
                    <div class="flex items-center gap-4">
                                <button onclick="replyToComment({{ comment.id }})" class="text-xs text-[#6B7280] hover:text-[#374151]">Reply</button>
                    </div>

                            <!-- Reply Input (hidden by default) -->
                            <div id="replyForm_{{ comment.id }}" class="ml-6 mt-4 hidden">
                                <textarea 
                                    id="replyTextarea_{{ comment.id }}"
                                    class="w-full p-3 border border-[#D1D5DB] rounded-lg text-sm text-[#374151] focus:outline-none focus:ring-2 focus:ring-[#2563EB] focus:border-transparent resize-none"
                                    rows="2"
                                    placeholder="Write a reply..."></textarea>
                                <div class="flex justify-end gap-3 mt-2">
                                    <button onclick="cancelReply({{ comment.id }})" class="px-3 py-1.5 text-xs border border-[#D1D5DB] rounded-lg text-[#374151] hover:bg-[#F9FAFB]">
                                        Cancel
                                </button>
                                    <button onclick="submitReply({{ comment.id }})" class="px-3 py-1.5 text-xs bg-[#2563EB] text-white rounded-lg hover:bg-[#1D4ED8]">
                                        Reply
                                    </button>
                                </div>
                            </div>

                            <!-- Replies List -->
                            {% if comment.replies.all %}
                            <div class="ml-6 mt-4 space-y-4">
                                {% for reply in comment.replies.all %}
                                <div class="flex gap-3">
                                    {% with initials=reply.author.username|slice:":2"|upper %}
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#EC4899] to-[#F472B6] flex items-center justify-center text-white font-semibold text-xs flex-shrink-0">
                                        {{ initials }}
                                </div>
                                    {% endwith %}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                            <span class="text-sm font-semibold text-[#111827]">{{ reply.author.username|default:"Anonymous" }}</span>
                                            <span class="text-xs text-[#6B7280]">{{ reply.created_at|timesince }} ago</span>
                                    </div>
                                        <p class="text-sm text-[#4B5563]">{{ reply.content }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-sm text-[#6B7280] text-center py-4">No comments yet. Be the first to comment!</p>
            {% endif %}
            </div>
        {% else %}
        <div class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-12 text-center bg-[#F9FAFB]">
            <p class="text-sm text-[#6B7280]">{% trans "Please select an agent or use case from the table above to view and add review comments." %}</p>
                </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{% load static %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Dynamic Title Update based on URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const agentName = urlParams.get('agent');

        if (agentName) {
            const titleElement = document.getElementById('page-title');
            const subtitleElement = document.getElementById('page-subtitle');
            if (titleElement) {
                titleElement.textContent = `${agentName}`;
            }
            if (subtitleElement) {
                subtitleElement.textContent = `Review questionnaires and assessment for ${agentName}`;
            }
            document.title = `${agentName}`;
        }
    });
    
    // Evidence upload handling
    {% if agent or selected_use_case %}
    const evidenceUploadArea = document.getElementById('evidenceUploadArea');
    const evidenceFileInput = document.getElementById('evidenceFileInput');
    {% if selected_use_case %}
    const currentUseCaseId = {{ selected_use_case.id }};
    {% elif agent and use_cases_data %}
    const currentUseCaseId = {{ use_cases_data.0.use_case.id }};
    {% else %}
    const currentUseCaseId = null;
    {% endif %}
    
    if (evidenceUploadArea && evidenceFileInput && currentUseCaseId) {
        evidenceUploadArea.addEventListener('click', () => evidenceFileInput.click());
        evidenceUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            evidenceUploadArea.classList.add('border-[#2563EB]');
        });
        evidenceUploadArea.addEventListener('dragleave', () => {
            evidenceUploadArea.classList.remove('border-[#2563EB]');
        });
        evidenceUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            evidenceUploadArea.classList.remove('border-[#2563EB]');
            const files = e.dataTransfer.files;
            handleEvidenceUpload(files);
        });
        
        evidenceFileInput.addEventListener('change', (e) => {
            handleEvidenceUpload(e.target.files);
        });
    }
    
    async function handleEvidenceUpload(files) {
        if (!currentUseCaseId) {
            alert('Please select a use case first');
            return;
        }
        
        for (let file of files) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('description', `Uploaded: ${file.name}`);
                
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
                
                const response = await fetch(`/api/use-cases/${currentUseCaseId}/evidences/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error uploading evidence: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error: ' + error.message);
            }
        }
    }
    
    async function deleteEvidence(evidenceId, useCaseId) {
        if (!confirm('Are you sure you want to delete this evidence?')) return;
        
        if (!useCaseId) {
            useCaseId = currentUseCaseId;
        }
        
        if (!useCaseId) {
            alert('Please select a use case first');
            return;
        }
        
        try {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
            
            const response = await fetch(`/api/use-cases/${useCaseId}/evidences/${evidenceId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error deleting evidence: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Error: ' + error.message);
        }
    }
    {% endif %}
    
    // Evaluation report upload handling
    {% if agent or selected_use_case %}
    {% if selected_use_case %}
    const currentUseCaseIdForReports = {{ selected_use_case.id }};
    {% elif agent and use_cases_data|length > 0 %}
    const currentUseCaseIdForReports = {{ use_cases_data.0.use_case.id }};
    {% else %}
    const currentUseCaseIdForReports = null;
    {% endif %}
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    async function handleReportUpload(file, reportType) {
        if (!file) return;
        
        if (!currentUseCaseIdForReports) {
            alert('Please select a use case first');
            return;
        }
        
        const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
        const url = `/api/use-cases/${currentUseCaseIdForReports}/evaluation-reports/`;
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('report_type', reportType);
            formData.append('description', `Uploaded: ${file.name}`);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error uploading report: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Error: ' + error.message);
        }
    }
    
    function triggerReportUpload(reportType) {
        const input = document.getElementById(`report_${reportType}`);
        if (input) {
            input.click();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const reportInputs = document.querySelectorAll('input[data-report-type]');
        const reportUploadAreas = document.querySelectorAll('.report-upload-area');
        
        if (reportInputs.length === 0 || !currentUseCaseIdForReports) return;
        
        reportInputs.forEach(input => {
            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                const reportType = input.dataset.reportType;
                await handleReportUpload(file, reportType);
            });
        });
        
        reportUploadAreas.forEach(area => {
            const reportType = area.dataset.reportType;
            const input = document.getElementById(`report_${reportType}`);
            
            if (!input) return;
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.add('border-[#2563EB]', 'bg-blue-50');
            });
            
            area.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('border-[#2563EB]', 'bg-blue-50');
            });
            
            area.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                area.classList.remove('border-[#2563EB]', 'bg-blue-50');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const allowedExtensions = ['.xlsx', '.json', '.csv'];
                    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                    if (allowedExtensions.includes(fileExtension)) {
                        await handleReportUpload(file, reportType);
                    } else {
                        alert('Please upload .xlsx, .json, or .csv files only');
                    }
                }
            });
        });
    });
    {% endif %}
    
    // Review Comments Functions
    {% if agent or selected_use_case %}
    let currentUseCaseIdForComments = null;
    {% if selected_use_case %}
    currentUseCaseIdForComments = {{ selected_use_case.id }};
    {% elif agent and use_cases_data|length > 0 %}
    currentUseCaseIdForComments = {{ use_cases_data.0.use_case.id }};
    {% endif %}
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    async function submitComment() {
        const textarea = document.getElementById('newCommentTextarea');
        const content = textarea.value.trim();
        
        if (!content) {
            alert('Please enter a comment');
            return;
        }
        
        if (!currentUseCaseIdForComments) {
            alert('Please select a use case first');
            return;
        }
        
        const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
        
        try {
            const response = await fetch(`/api/use-cases/${currentUseCaseIdForComments}/review-comments/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ content: content })
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error submitting comment: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Comment submit error:', error);
            alert('Error: ' + error.message);
        }
    }
    
    function cancelComment() {
        document.getElementById('newCommentTextarea').value = '';
    }
    
    function replyToComment(commentId) {
        const replyForm = document.getElementById(`replyForm_${commentId}`);
        if (replyForm) {
            replyForm.classList.remove('hidden');
            document.getElementById(`replyTextarea_${commentId}`).focus();
        }
    }
    
    function cancelReply(commentId) {
        const replyForm = document.getElementById(`replyForm_${commentId}`);
        const textarea = document.getElementById(`replyTextarea_${commentId}`);
        if (replyForm) {
            replyForm.classList.add('hidden');
            textarea.value = '';
        }
    }
    
    async function submitReply(parentCommentId) {
        const textarea = document.getElementById(`replyTextarea_${parentCommentId}`);
        const content = textarea.value.trim();
        
        if (!content) {
            alert('Please enter a reply');
            return;
        }
        
        if (!currentUseCaseIdForComments) {
            alert('Please select a use case first');
            return;
        }
        
        const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
        
        try {
            const response = await fetch(`/api/use-cases/${currentUseCaseIdForComments}/review-comments/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ content: content, parent_id: parentCommentId })
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error submitting reply: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Reply submit error:', error);
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteEvaluationReport(reportType, reportId, useCaseId) {
        if (!confirm('Are you sure you want to delete this report?')) return;
        
        if (!useCaseId) {
            useCaseId = currentUseCaseIdForReports;
        }
        
        if (!useCaseId) {
            alert('Please select a use case first');
            return;
        }
        
        try {
            const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
            
            const response = await fetch(`/api/use-cases/${useCaseId}/evaluation-reports/${reportId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error deleting report: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Error: ' + error.message);
        }
    }
    {% endif %}
</script>
{% endblock %}