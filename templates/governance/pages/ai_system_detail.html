{% extends "governance/base.html" %}
{% load static %}

{% block title %}{{ agent.name }} - AI System Detail{% endblock %}

{% block dashboard_content %}
<style>
/* Styled select to match provided design (rounded, padded, custom arrow) */
.styled-select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: #fff;
    border: 1px solid #D1D5DB;
    border-radius: 0.75rem; /* 12px */
    padding: 0.75rem 3rem 0.75rem 0.75rem;
    width: 100%;
    color: #374151;
    font-size: 0.95rem;
    line-height: 1.4;
}
.styled-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(241, 61, 48, 0.15);
    border-color: #F13D30;
}
.styled-select-wrapper {
    position: relative;
}
.styled-select-wrapper svg {
    pointer-events: none;
}
</style>
<div class="flex flex-col gap-6 mx-auto" data-agent-id="{{ agent.id }}">
    <!-- Breadcrumb Navigation -->
    <div class="flex items-center gap-3">
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.back()">
            <img src="{% static 'governance/img/arrow-left.svg' %}" alt="Back" class="w-3.5 h-3.5">
        </button>
        <button class="w-6 h-6 bg-transparent border-none cursor-pointer p-0 flex items-center justify-center" onclick="history.forward()">
            <img src="{% static 'governance/img/arrow-right-gray.svg' %}" alt="Forward" class="w-3.5 h-3.5">
        </button>
        <span class="text-sm font-semibold text-[#F13D30]">AI Inventory / {{ agent.name }}</span>
    </div>


    <!-- Title -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-[#22262A]">{{ agent.name }}</h1>
        <a href="{% url 'ai_inventory' %}" class="flex items-center gap-2 px-4 py-2 border border-[#D1D5DB] text-[#374151] text-sm font-medium rounded-lg hover:bg-[#F9FAFB] transition-colors">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back to List
        </a>
    </div>

    <!-- Tabs -->
    <div class="border-b border-[#E5E7EB]">
        <div class="flex gap-6">
            <button onclick="switchTab('profile')" id="tab-profile" class="tab-button active px-4 py-3 text-sm font-medium text-[#F13D30] border-b-2 border-[#F13D30]">
                Profile
            </button>
            <button onclick="switchTab('assessment')" id="tab-assessment" class="tab-button px-4 py-3 text-sm font-medium text-[#6B7280] border-b-2 border-transparent hover:text-[#F13D30]">
                Assessment
            </button>
            <button onclick="switchTab('result')" id="tab-result" class="tab-button px-4 py-3 text-sm font-medium text-[#6B7280] border-b-2 border-transparent hover:text-[#F13D30]">
                Result
            </button>
        </div>
    </div>

    <!-- Tab Content: Profile -->
    <div id="content-profile" class="tab-content">
         <!-- Section 1: Document & Evidence Upload -->
        <div class="flex flex-col gap-6">
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section1')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">1. Document & Evidence Upload</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Upload documents for AI-assisted form completion.</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section1-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section1-content">
                    <!-- File Upload Zone -->
                    <div class="border-2 border-dashed border-[#D1D5DB] rounded-lg p-8 text-center mb-6">
                        <p class="text-sm text-[#6B7280] mb-2">Click or drag and drop to add more evidence document...</p>
                        <p class="text-sm text-[#6B7280] mb-4">or</p>
                        <p class="text-xs text-[#6B7280] mb-4">PDF, DOC, JPG, XLS, XLSX, CSV</p>
                        <input type="file" id="file-upload" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.xls,.xlsx,.csv" class="hidden">
                        <button onclick="document.getElementById('file-upload').click()" class="bg-[#F13D30] text-white px-6 py-2.5 rounded-lg font-medium hover:bg-[#d63529] transition-colors flex items-center gap-2 mx-auto">
                            <span>ðŸ“Ž</span> Choose File
                        </button>
                    </div>

                    <!-- Uploaded Documents List -->
                    <div id="uploaded-documents" class="space-y-3 mb-6">
                        <!-- Documents will be loaded dynamically from API -->
                    </div>

                    <!-- AI Read & Auto-fill options -->
                    <div class="flex gap-3 items-center">
                        <span class="text-sm text-[#6B7280]">AI Read & Auto-fill from:</span>
                        <button class="ai-read-toggle active px-4 py-2 rounded-lg bg-[#F13D30] text-white font-medium shadow-sm flex items-center gap-2" data-option="all">
                            <img src="{% static 'governance/img/sparkle.svg' %}" alt="Sparkle" class="w-4 h-4" style="filter: brightness(0) invert(1);">
                            <span>All files</span>
                        </button>
                        <button class="ai-read-toggle px-4 py-2 rounded-lg border border-[#F13D30] text-[#F13D30] font-medium bg-white flex items-center gap-2" data-option="selected">
                            <img src="{% static 'governance/img/sparkle.svg' %}" alt="Sparkle" class="w-4 h-4" style="filter: brightness(0) saturate(100%) invert(32%) sepia(98%) saturate(1500%) hue-rotate(344deg) brightness(98%) contrast(95%);">
                            <span>Selected files</span>
                        </button>
                        <button id="delete-selected-files-btn" onclick="deleteSelectedFiles()" class="hidden px-4 py-2 rounded-lg border border-[#DC180A] text-[#F13D30] font-medium bg-white flex items-center gap-2 hover:bg-[#FEE2E2] transition-colors">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            <span>Delete selected</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section 2: System Identity -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section2')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">2. System Identity</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Basic information about this AI system.</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section2-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section2-content">
                    <form id="system-identity-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q1: AI System Name <span class="text-[#F13D30]">*</span></label>
                            <input type="text" name="ai_system_name" value="{{ agent.name }}" placeholder="Customer Service Chatbot" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q2: Internal system ID / reference</label>
                            <input type="text" name="internal_system_id" placeholder="Enter internal system ID or reference" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q3: Commercial name of the AI system, if any</label>
                            <input type="text" name="commercial_name" placeholder="Enter commercial name" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q4: Owner / Responsible Team</label>
                            <div class="mb-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" name="same_as_compliance_owner" id="same-as-compliance-owner" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">Same as internal AI compliance owner</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs text-[#6B7280] mb-1">Name</label>
                                    <input type="text" name="owner_name" placeholder="Enter name" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                                </div>
                                <div>
                                    <label class="block text-xs text-[#6B7280] mb-1">Email</label>
                                    <input type="email" name="owner_email" placeholder="Enter email" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                                </div>
                                <div>
                                    <label class="block text-xs text-[#6B7280] mb-1">Department</label>
                                    <input type="text" name="owner_department" placeholder="Enter department" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q5: System status <span class="text-[#F13D30]">*</span></label>
                            <div class="styled-select-wrapper">
                                <select name="system_status" id="system-status" class="styled-select">
                                    <option value="Planned" selected>Planned</option>
                                    <option value="In development">In development</option>
                                    <option value="Testing / Pilot">Testing / Pilot</option>
                                    <option value="In use (production)">In use (production)</option>
                                    <option value="Retired">Retired</option>
                                </select>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-[#9CA3AF] absolute right-3 top-1/2 transform -translate-y-1/2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold text-sm text-[#22262A] mb-2">Q6: Go-live date (planned or actual)</label>
                            <div class="relative">
                                <!-- Custom date input with highlighted day -->
                                <div id="go-live-date-wrapper" class="relative w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] focus-within:border-[#F13D30] focus-within:ring-2 focus-within:ring-[#FEEDEC] transition-colors cursor-pointer bg-white">
                                    <div id="go-live-date-display" class="flex items-center gap-1">
                                        <span id="date-day" class="px-1.5 py-0.5 rounded bg-[#3B82F6]/20 text-[#3B82F6] font-medium">DD</span>
                                        <span>/</span>
                                        <span id="date-month">MM</span>
                                        <span>/</span>
                                        <span id="date-year">YYYY</span>
                                    </div>
                                    <input type="text" 
                                        id="go-live-date-input" 
                                        name="go_live_date" 
                                        placeholder="DD/MM/YYYY" 
                                        readonly
                                        class="absolute inset-0 opacity-0 cursor-pointer">
                                    <input type="date" 
                                        id="go-live-date-hidden" 
                                        class="hidden">
                                </div>
                                <!-- Date Picker Dropdown -->
                                <div id="date-picker-dropdown" class="hidden absolute top-full left-0 mt-2 z-[100] bg-[#1F2937] rounded-lg shadow-xl p-4 min-w-[280px]">
                                    <div class="flex items-center justify-between mb-4">
                                        <button type="button" id="date-picker-prev-month" class="text-white hover:text-[#9CA3AF] transition-colors">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                                <polyline points="15 18 9 12 15 6"></polyline>
                                            </svg>
                                        </button>
                                        <div class="flex items-center gap-2">
                                            <span id="date-picker-month-year" class="text-white font-medium text-sm">Jan 2026</span>
                                            <button type="button" id="date-picker-today" class="w-4 h-4 rounded-full bg-white/20 hover:bg-white/30 transition-colors"></button>
                                        </div>
                                        <button type="button" id="date-picker-next-month" class="text-white hover:text-[#9CA3AF] transition-colors">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                                                <polyline points="9 18 15 12 9 6"></polyline>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Mo</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Tu</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">We</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Th</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Fr</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Sa</div>
                                        <div class="text-center text-xs text-[#9CA3AF] py-1">Su</div>
                                    </div>
                                    <div id="date-picker-calendar" class="grid grid-cols-7 gap-1">
                                        <!-- Calendar dates will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-1">Q7: Is this system part of a broader product / service?</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="part_of_product" value="yes" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">Yes</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="part_of_product" value="no" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">No</span>
                                </label>
                            </div>
                            <div id="product-service-name-field" class="mt-3 hidden">
                                <label class="block text-xs text-[#6B7280] mb-1">Product / Service Name</label>
                                <input type="text" name="product_service_name" placeholder="Enter product/service name" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection('system-identity-form')" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Section 3: Source & Operator Role -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section3')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">3. Source & Operator Role</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Define your organization's role and system source</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section3-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section3-content">
                    <div class="space-y-6">
                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q1: In Organization module, your default role is set to be: <span class="text-[#F13D30]">"{{ org_default_roles_display|default:'Deployer' }}"</span>. Does your organisation's default role apply to this AI system? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="default_role_apply" id="default-role-yes" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Yes</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="default_role_apply" id="default-role-no" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]" checked>
                                    <span class="font-normal text-sm text-[#22262A]">No</span>
                                </label>
                            </div>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-3">
                            <div class="flex items-start gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">
                                    Q2: Your role for this AI system <span class="text-[#F13D30]">*</span>
                                </label>
                                <div class="group relative">
                                    <div class="w-4 h-4 rounded-full bg-[#B5BCC4] flex items-center justify-center cursor-help">
                                        <span class="text-xs text-white font-medium">?</span>
                                    </div>
                                    <div class="invisible group-hover:visible absolute left-0 top-6 w-64 p-3 bg-[#22262A] text-white text-xs rounded-lg shadow-lg z-10">
                                        <p class="font-normal">
                                            <strong>Provider:</strong> Develops, produces or trains AI systems<br />
                                            <strong>Deployer:</strong> Uses AI systems under its authority<br />
                                            <strong>Importer:</strong> Places AI systems on EU market<br />
                                            <strong>Distributor:</strong> Makes AI systems available on EU market
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p class="font-normal text-xs text-[#565F6C]">
                                Multiple selections allowed
                            </p>
                            <div class="grid grid-cols-2 gap-3">
                                <label id="role-provider-label" class="flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="checkbox" name="roles[]" id="role-provider" value="Provider" class="role-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Provider</span>
                                </label>
                                <label id="role-deployer-label" class="flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="checkbox" name="roles[]" id="role-deployer" value="Deployer" class="role-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Deployer</span>
                                </label>
                                <label id="role-importer-label" class="flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="checkbox" name="roles[]" id="role-importer" value="Importer" class="role-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Importer</span>
                                </label>
                                <label id="role-distributor-label" class="flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="checkbox" name="roles[]" id="role-distributor" value="Distributor" class="role-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Distributor</span>
                                </label>
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-3">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q3: System source <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="system-source-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="system_source" value="In-house" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">In-house</span>
                                </label>
                                <label class="system-source-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="system_source" value="Vendor / Third-party" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Vendor / Third-party</span>
                                </label>
                                <label class="system-source-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="system_source" value="Mixed" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Mixed</span>
                                </label>
                                <label class="system-source-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="system_source" value="Unknown" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Unknown</span>
                                </label>
                            </div>
                            <!-- Conditional fields for Vendor/Mixed -->
                            <div id="vendor-fields" class="space-y-3 pt-3 hidden">
                                <div>
                                    <label class="block font-medium text-sm text-[#22262A] mb-2">
                                        External vendor / provider name <span class="text-[#F13D30]">*</span>
                                    </label>
                                    <input type="text" name="vendor_name" id="vendor-name" placeholder="Enter vendor / provider name" class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC]">
                                </div>
                                <div class="space-y-3">
                                    <label class="font-normal text-sm text-[#464E58]">
                                        Paste a link from Section 1 or an external link
                                    </label>
                                    <div class="flex gap-2">
                                        <input type="text" name="vendor_evidence_link" id="vendor-evidence-link" placeholder="Paste link here" class="flex-1 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] transition-colors">
                                        <button type="button" id="save-vendor-link-btn" class="px-4 py-2 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors whitespace-nowrap">
                                            Save link
                                        </button>
                                    </div>
                                    <div id="vendor-link-saved" class="flex items-center gap-2 mt-2 hidden">
                                        <svg class="w-4 h-4 text-[#F13D30]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                        </svg>
                                        <span id="vendor-link-text" class="font-normal text-sm text-[#464E58]"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q4 -->
                        <div class="space-y-3">
                            <div class="flex items-start gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">
                                    Q4: Do you modify / customize this AI system before use or resale? <span class="text-[#F13D30]">*</span>
                                </label>
                                <div class="group relative">
                                    <div class="w-4 h-4 rounded-full bg-[#B5BCC4] flex items-center justify-center cursor-help">
                                        <span class="text-xs text-white font-medium">?</span>
                                    </div>
                                    <div class="invisible group-hover:visible absolute left-0 top-6 w-64 p-3 bg-[#22262A] text-white text-xs rounded-lg shadow-lg z-10">
                                        <p class="font-normal">
                                            Examples: fine-tuning, retraining, changing decision logic, changing intended purpose, re-branding
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="modify_customize" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Yes</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="modify_customize" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">No</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="modify_customize" value="Unknown" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Unknown</span>
                                </label>
                            </div>
                            <!-- Warning banner when Yes is selected -->
                            <div id="modify-warning" class="bg-[#FEF3C7] border border-[#FDE047] rounded-lg p-4 flex items-start gap-3 hidden">
                                <svg class="w-5 h-5 text-[#92400E] shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="font-semibold text-sm text-[#92400E] mb-1">
                                        Role impact
                                    </p>
                                    <p class="font-normal text-sm text-[#92400E]">
                                        Customising / modifying an AI system may make your organisation responsible as a Provider (in addition to Deployer / Distributor / Importer). Please review and update the role for this AI system if needed.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Q5 -->
                        <div class="space-y-3">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q5: Is this AI system offered / used in the EU / EEA? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="eu-usage-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_usage" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Yes</span>
                                </label>
                                <label class="eu-usage-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_usage" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">No</span>
                                </label>
                                <label class="eu-usage-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_usage" value="Planned" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Planned</span>
                                </label>
                                <label class="eu-usage-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_usage" value="Unknown" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Unknown</span>
                                </label>
                            </div>
                        </div>

                        <!-- Q6 -->
                        <div class="space-y-3">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q6: Do system outputs affect persons located in the EU / EEA? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="eu-effect-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_effect" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Yes</span>
                                </label>
                                <label class="eu-effect-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_effect" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">No</span>
                                </label>
                                <label class="eu-effect-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_effect" value="Planned" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Planned</span>
                                </label>
                                <label class="eu-effect-option flex items-center gap-2 px-4 py-3 border border-[#F0F1F2] rounded-lg cursor-pointer transition-colors bg-white hover:bg-[#F9FAFB]">
                                    <input type="radio" name="eu_effect" value="Unknown" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">Unknown</span>
                                </label>
                            </div>
                        </div>

                        <!-- Notice when BOTH Q5 and Q6 are "No" -->
                        <div id="eu-act-notice" class="rounded-xl p-4 flex items-start gap-3 hidden" style="background-color: #FFF2D6; border: 1px solid #FFD58C;">
                            <svg class="w-5 h-5 text-[#92400E] shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="min-w-0">
                                <p class="font-semibold text-[#8B4513] text-base leading-tight">
                                    Out of Scope
                                </p>
                                <p class="font-normal text-[#8B4513] text-sm mt-1 leading-snug">
                                    Based on your selection in Q5 and Q6, this AI system appears to be out of scope for the EU AI Act.
                                </p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Intended Purpose & Decision Use -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section4')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">4. Intended Purpose & Decision Use</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Define the purpose and usage domain</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section4-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section4-content">
                    <div class="space-y-6">
                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q1: What is the intended purpose of this system? (1â€“3 sentences) <span class="text-[#F13D30]">*</span></label>
                            <textarea name="intended_purpose" rows="4" placeholder="Describe the intended purpose of this AI system..." class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F13D30]"></textarea>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">Q2: In which sector / domain is this system used? <span class="text-[#F13D30]">*</span></label>
                                <span class="font-normal text-xs text-[#565F6C]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in sector_options %}
                                    {% if option != "Other / not listed:" and option != "Other / not listed" %}
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" name="sector_domain" value="{{ option }}" class="sector-domain-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                        <span class="font-normal text-sm text-[#464E58]">{{ option }}</span>
                                    </label>
                                    {% endif %}
                                {% endfor %}
                                <!-- Other / not listed with conditional input -->
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" name="sector_domain" id="sector-other-checkbox" value="Other / not listed" class="sector-domain-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                    <div class="flex-1">
                                        <label for="sector-other-checkbox" class="font-normal text-sm text-[#464E58] cursor-pointer">
                                            Other / not listed:
                                        </label>
                                        <input type="text" name="sector_other" id="sector-other-input" placeholder="Please specify" class="w-full mt-2 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-2">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q3: Is this AI system a safety component of a product, or itself a product, covered by EU harmonisation legislation in Annex I? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="safety_component" id="safety-component-yes" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#464E58]">Yes</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="safety_component" id="safety-component-no" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#464E58]">No</span>
                                </label>
                            </div>
                            
                            <!-- Follow-up Question (conditional) -->
                            <div id="third-party-conformity-field" class="ml-7 mt-4 pl-4 border-l-2 border-[#F0F1F2] space-y-3 hidden">
                                <label class="block font-semibold text-sm text-[#22262A]">
                                    If the product requires a third-party conformity assessment under the corresponding legislation. <span class="text-[#F13D30]">*</span>
                                </label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="third_party_conformity" value="Yes" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                        <span class="font-normal text-sm text-[#464E58]">Yes</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="third_party_conformity" value="No" class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                        <span class="font-normal text-sm text-[#464E58]">No</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Deployment & Stakeholders -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section5')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">5. Deployment & Stakeholders</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Define deployment context and affected parties</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section5-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section5-content">
                    <div class="space-y-8">
                        <!-- Q1 -->
                        <div class="space-y-3">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q1: In what context will this AI system be deployed? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="space-y-2">
                                {% for option in deployment_contexts %}
                                    {% if option != "Other:" and option != "Other" %}
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="deployment_context" value="{{ option }}" class="deployment-context-radio w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                        <span class="font-normal text-sm text-[#464E58]">{{ option }}</span>
                                    </label>
                                    {% endif %}
                                {% endfor %}
                                <!-- Other option with conditional input -->
                                <div class="flex items-start gap-3">
                                    <input type="radio" name="deployment_context" id="deployment-other-radio" value="Other" class="deployment-context-radio w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30] mt-0.5">
                                    <div class="flex-1">
                                        <label for="deployment-other-radio" class="font-normal text-sm text-[#464E58] cursor-pointer">
                                            Other:
                                        </label>
                                        <input type="text" name="deployment_other" id="deployment-other-input" placeholder="Please specify" class="w-full mt-2 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">Q2: Who will use this AI system? <span class="text-[#F13D30]">*</span></label>
                                <span class="font-normal text-xs text-[#565F6C]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in system_users %}
                                    {% if option != "Other:" and option != "Other" %}
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" name="system_users" value="{{ option }}" class="system-users-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                        <span class="font-normal text-sm text-[#464E58]">{{ option }}</span>
                                    </label>
                                    {% endif %}
                                {% endfor %}
                                <!-- Other option with conditional input -->
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" name="system_users" id="system-users-other-checkbox" value="Other" class="system-users-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                    <div class="flex-1">
                                        <label for="system-users-other-checkbox" class="font-normal text-sm text-[#464E58] cursor-pointer">
                                            Other:
                                        </label>
                                        <input type="text" name="system_users_other" id="system-users-other-input" placeholder="Please specify" class="w-full mt-2 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">Q3: Who can be affected by the AI system's outputs? <span class="text-[#F13D30]">*</span></label>
                                <span class="font-normal text-xs text-[#565F6C]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in affected_outputs %}
                                    {% if option != "Other:" and option != "Other" %}
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" name="affected_outputs" value="{{ option }}" class="affected-outputs-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                        <span class="font-normal text-sm text-[#464E58]">{{ option }}</span>
                                    </label>
                                    {% endif %}
                                {% endfor %}
                                <!-- Other option with conditional input -->
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" name="affected_outputs" id="affected-outputs-other-checkbox" value="Other" class="affected-outputs-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                    <div class="flex-1">
                                        <label for="affected-outputs-other-checkbox" class="font-normal text-sm text-[#464E58] cursor-pointer">
                                            Other:
                                        </label>
                                        <input type="text" name="affected_outputs_other" id="affected-outputs-other-input" placeholder="Please specify" class="w-full mt-2 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q4 -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <label class="block text-sm font-medium text-[#374151]">Q4: Does the AI system affect vulnerable persons? <span class="text-[#F13D30]">*</span></label>
                                <span class="text-xs text-[#9CA3AF]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in vulnerable_groups %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="vulnerable_groups" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Workflow, Outputs & Decision Impact -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section6')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">6. Workflow, Outputs & Decision Impact</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Define how the system operates and its decision-making role</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section6-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section6-content">
                    <div class="space-y-6">
                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q1: What does the AI system do in the workflow? <span class="text-[#F13D30]">*</span></label>
                            <div class="space-y-2">
                                {% for option in workflow_roles %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="workflow_role" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <label class="block font-semibold text-sm text-[#22262A]">Q2: What type of output does the AI system produce? <span class="text-[#F13D30]">*</span></label>
                                <span class="font-normal text-xs text-[#565F6C]">Select all that apply</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in output_types %}
                                    {% if option != "Other:" and option != "Other" %}
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" name="output_types" value="{{ option }}" class="output-types-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                        <span class="font-normal text-sm text-[#464E58]">{{ option }}</span>
                                    </label>
                                    {% endif %}
                                {% endfor %}
                                <!-- Other option with conditional input -->
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" name="output_types" id="output-types-other-checkbox" value="Other" class="output-types-checkbox w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30] mt-0.5">
                                    <div class="flex-1">
                                        <label for="output-types-other-checkbox" class="font-normal text-sm text-[#464E58] cursor-pointer">
                                            Other:
                                        </label>
                                        <input type="text" name="output_types_other" id="output-types-other-input" placeholder="Please specify" class="w-full mt-2 px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC] hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q3: Is the AI output used to make or influence decisions about individuals (natural persons)? <span class="text-[#F13D30]">*</span></label>
                            <div class="flex flex-wrap gap-4">
                                {% for option in decision_influence %}
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="decision_influence" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q4 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q4: Does the AI system automatically execute actions based on its output? <span class="text-[#F13D30]">*</span></label>
                            <div class="flex flex-wrap gap-4">
                                {% for option in auto_execute %}
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="auto_execute" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 7: Capabilities -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section7')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">7. Capabilities</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Identify specific capabilities and interaction modes</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section7-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section7-content">
                    <div class="space-y-6">
                        <!-- Q1 -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <label class="block text-sm font-medium text-[#374151]">Q1: Does your AI system use any of the following capabilities or practices? <span class="text-[#F13D30]">*</span></label>
                                <span class="text-xs text-[#9CA3AF]">Select all that apply</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in capability_practices %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="capability_practices" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q2: Does the AI system interact directly with natural persons? (e.g., chatbot, voicebot, assistant) <span class="text-[#F13D30]">*</span></label>
                            <div class="flex flex-wrap gap-4">
                                {% for option in interacts_natural_persons %}
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="interacts_persons" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <label class="block text-sm font-medium text-[#374151]">Q3: Does the AI system generate synthetic content that may be perceived as human-made? <span class="text-[#F13D30]">*</span></label>
                                <span class="text-xs text-[#9CA3AF]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in synthetic_content %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="synthetic_content" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 8: Technical Profile (Model & Data) -->
            <div class="bg-white rounded-lg border border-[#E5E7EB] shadow-sm">
                <div class="p-6 border-b border-[#E5E7EB] cursor-pointer" onclick="toggleSection('section8')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-[#22262A]">8. Technical Profile (Model & Data)</h2>
                            <p class="text-sm text-[#6B7280] mt-1">Technical details about the AI model and data processing</p>
                        </div>
                        <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="w-5 h-5 section-toggle" id="section8-toggle">
                    </div>
                </div>
                <div class="p-6 section-content" id="section8-content">
                    <div class="space-y-6">
                        <!-- Q1 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q1: What kind of AI is used? <span class="text-[#F13D30]">*</span></label>
                            <div class="space-y-2">
                                {% for option in ai_kinds %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="ai_kind" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q2 -->
                        <div class="space-y-2">
                            <label class="block font-semibold text-sm text-[#22262A]">
                                Q2: Is this system provided as a general-purpose AI (GPAI) model / component or does it integrate one? <span class="text-[#F13D30]">*</span>
                            </label>
                            <div class="flex gap-4">
                                {% for option in gpai_integration %}
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="gpai_integration" value="{{ option }}" class="gpai-integration-radio w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                                    <span class="font-normal text-sm text-[#22262A]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <!-- Conditional input when Yes is selected -->
                            <div id="gpai-provider-field" class="mt-3 hidden">
                                <label class="block font-medium text-sm text-[#22262A] mb-2">
                                    Which GPAI provider / model? (optional)
                                </label>
                                <input type="text" name="gpai_provider" id="gpai-provider-input" placeholder="e.g., OpenAI GPT-4, Google Gemini, etc." class="w-full px-4 py-2.5 border border-[#B5BCC4] rounded-lg font-normal text-sm text-[#22262A] placeholder:text-[#B5BCC4] focus:outline-none focus:border-[#F13D30] focus:ring-2 focus:ring-[#FEEDEC]">
                            </div>
                        </div>

                        <!-- Q3 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q3: What is the training source? <span class="text-[#F13D30]">*</span></label>
                            <div class="space-y-2">
                                {% for option in training_sources %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="training_source" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q4 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-[#374151]">Q4: How often does the model / system update? <span class="text-[#F13D30]">*</span></label>
                            <div class="space-y-2">
                                {% for option in update_frequency %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="radio" name="update_frequency" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Q5 -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <label class="block text-sm font-medium text-[#374151]">Q5: What data types are processed? <span class="text-[#F13D30]">*</span></label>
                                <span class="text-xs text-[#9CA3AF]">Multiple selections allowed</span>
                            </div>
                            <div class="space-y-2">
                                {% for option in data_types %}
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="data_types" value="{{ option }}" class="w-4 h-4">
                                    <span class="text-sm text-[#374151]">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="px-6 py-2 border border-[#F13D30] text-[#F13D30] rounded-lg font-medium hover:bg-[#F13D30] hover:text-white transition-colors">Cancel</button>
                            <button type="button" onclick="saveSection()" class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-medium hover:bg-[#d63529] transition-colors">Confirm and Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Footer action -->
    <div class="flex justify-end mt-8">
        <button type="button" onclick="saveAllAndProceedToAssessment()" class="px-6 py-3 bg-[#F13D30] text-white text-base font-semibold rounded-xl shadow hover:bg-[#d63529] transition-colors">
            Save all and proceed to Assessment
        </button>
    </div>

    </div>

    <!-- Tab Content: Assessment -->
    <div id="content-assessment" class="tab-content hidden">
        <div class="flex flex-col gap-6">
            <!-- Info banner -->
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-normal text-sm text-[#464E58]">
                    Assessment is based on the information provided in the Profile page. Please review the assessment below and confirm or update them using the legal references provided.
                </p>
            </div>

            <!-- Assessment Blocks -->
            <div class="space-y-6">
                <!-- Block 1: Prohibited Practices -->
                <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm overflow-hidden" id="assessment-block-1">
                    <button onclick="toggleAssessmentBlock(1)" class="w-full flex items-center justify-between px-6 py-4 hover:bg-[#FEFEFE] transition-colors">
                        <h2 class="font-bold text-xl text-[#22262A]">Block 1 â€” Prohibited Practices Screening</h2>
                        <div class="flex items-center gap-3">
                            <span id="block-1-status" class="px-4 py-1.5 rounded-full font-semibold text-sm bg-[#F0F1F2] text-[#6B7280]">Not assessed</span>
                            <img id="block-1-chevron" src="{% static 'governance/img/chevron-down.svg' %}" alt="Toggle" class="w-5 h-5 text-[#565F6C] shrink-0">
                        </div>
                    </button>
                    <div id="block-1-content" class="hidden px-6 py-6 border-t border-[#F0F1F2]">
                        <div id="block-1-content-inner">
                            <!-- Content will be dynamically populated based on status -->
                            <p class="text-sm text-[#464E58]">Calculating assessment status...</p>
                        </div>
                    </div>
                </div>

                <!-- Block 2: High-Risk Classification -->
                <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm overflow-hidden" id="assessment-block-2">
                    <button onclick="toggleAssessmentBlock(2)" class="w-full flex items-center justify-between px-6 py-4 hover:bg-[#FEFEFE] transition-colors">
                        <h2 class="font-bold text-xl text-[#22262A]">Block 2 â€” High-Risk Classification</h2>
                        <div class="flex items-center gap-3">
                            <span id="block-2-status" class="px-4 py-1.5 rounded-full font-semibold text-sm bg-[#F0F1F2] text-[#6B7280]">Not assessed</span>
                            <img id="block-2-chevron" src="{% static 'governance/img/chevron-down.svg' %}" alt="Toggle" class="w-5 h-5 text-[#565F6C] shrink-0">
                        </div>
                    </button>
                    <div id="block-2-content" class="hidden px-6 py-6 border-t border-[#F0F1F2]">
                        <div id="block-2-content-inner">
                            <p class="text-sm text-[#464E58]">Calculating assessment status...</p>
                        </div>
                    </div>
                </div>

                <!-- Block 3: Transparency Obligation -->
                <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm overflow-hidden" id="assessment-block-3">
                    <button onclick="toggleAssessmentBlock(3)" class="w-full flex items-center justify-between px-6 py-4 hover:bg-[#FEFEFE] transition-colors">
                        <h2 class="font-bold text-xl text-[#22262A]">Block 3 â€” Transparency Obligation</h2>
                        <div class="flex items-center gap-3">
                            <span id="block-3-status" class="px-4 py-1.5 rounded-full font-semibold text-sm bg-[#F0F1F2] text-[#6B7280]">Not assessed</span>
                            <img id="block-3-chevron" src="{% static 'governance/img/chevron-down.svg' %}" alt="Toggle" class="w-5 h-5 text-[#565F6C] shrink-0">
                        </div>
                    </button>
                    <div id="block-3-content" class="hidden px-6 py-6 border-t border-[#F0F1F2]">
                        <div id="block-3-content-inner">
                            <p class="text-sm text-[#464E58]">Calculating assessment status...</p>
                        </div>
                    </div>
                </div>

                <!-- Block 4: GPAI Applicability -->
                <div class="bg-white rounded-lg border border-[#F0F1F2] shadow-sm overflow-hidden" id="assessment-block-4">
                    <button onclick="toggleAssessmentBlock(4)" class="w-full flex items-center justify-between px-6 py-4 hover:bg-[#FEFEFE] transition-colors">
                        <h2 class="font-bold text-xl text-[#22262A]">Block 4 â€” GPAI (General-Purpose AI) Applicability</h2>
                        <div class="flex items-center gap-3">
                            <span id="block-4-status" class="px-4 py-1.5 rounded-full font-semibold text-sm bg-[#F0F1F2] text-[#6B7280]">Not assessed</span>
                            <img id="block-4-chevron" src="{% static 'governance/img/chevron-down.svg' %}" alt="Toggle" class="w-5 h-5 text-[#565F6C] shrink-0">
                        </div>
                    </button>
                    <div id="block-4-content" class="hidden px-6 py-6 border-t border-[#F0F1F2]">
                        <div id="block-4-content-inner">
                            <p class="text-sm text-[#464E58]">Calculating assessment status...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer buttons -->
            <div class="flex justify-between items-center pt-2">
                <button type="button" onclick="switchTab('profile')" class="px-5 py-2.5 border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                    Back to Profile
                </button>
                <button type="button" onclick="proceedToResult()" class="px-6 md:px-10 py-3 bg-[#F13D30] text-white font-semibold rounded-lg shadow hover:bg-[#DC180A] transition-colors">
                    Proceed to Result
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Result -->
    <div id="content-result" class="tab-content hidden">
        <div class="flex flex-col gap-6">
            <!-- Assessment Result Header -->
            <div class="bg-[#F9FAFB] rounded-lg border border-[#E5E7EB] shadow-sm p-6">
                <h2 class="text-xl font-bold text-[#111827] mb-2">Assessment Result</h2>
                <p class="text-sm text-[#6B7280]">Summary of EU AI Act compliance assessment for this AI system</p>
            </div>

            <!-- Result Blocks -->
            <div id="result-blocks-container" class="space-y-4">
                {% for block in result_blocks %}
                <div class="result-block bg-white rounded-lg border border-[#E5E7EB] shadow-sm p-6" data-block-id="{{ forloop.counter }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-base font-semibold text-[#111827] mb-2">{{ block.title }}</h3>
                            <p class="result-block-description text-sm text-[#6B7280]">{{ block.description|default:"" }}</p>
                        </div>
                        <span class="result-block-status px-3 py-1 text-sm font-medium rounded-full {{ block.status_class }}">
                            {{ block.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Footer Button -->
            <div class="flex justify-start pt-2">
                <button type="button" onclick="switchTab('assessment')" class="px-5 py-2.5 border border-[#CBD5E1] text-[#374151] rounded-xl font-medium hover:bg-[#F3F4F6] transition-colors">
                    Back to Assessment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Link Modal -->
<div id="share-link-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
    <button type="button" class="absolute top-4 right-4 text-[#9CA3AF] hover:text-[#4B5563]" onclick="closeShareModal()">
      <img src="{% static 'governance/img/x.svg' %}" alt="Close" class="w-4 h-4">
    </button>
    <h3 class="text-lg font-semibold text-[#111827] mb-2">Share Link</h3>
    <p class="text-sm text-[#6B7280] mb-4">
      Share link for: 
      <span id="share-file-name" class="font-semibold text-[#111827]">File.pdf</span>
    </p>
    <div class="flex items-center gap-3">
      <input id="share-link-input" type="text" readonly
         class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm text-[#111827] bg-[#F9FAFB] focus:outline-none">
      <button type="button" id="share-link-copy-btn"
         class="px-4 py-2 bg-[#F13D30] text-white text-sm font-medium rounded-lg hover:bg-[#d63529] transition-colors flex items-center gap-2">
        <svg id="share-link-chain-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
        </svg>
        <span id="share-link-text">Copy</span>
      </button>
    </div>
  </div>
</div>

<script>
// Tab switching
// Tab switching
function switchTab(tabName, skipUpdate = false) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'text-[#F13D30]', 'border-[#F13D30]');
        btn.classList.add('text-[#6B7280]', 'border-transparent');
    });
    
    // Show selected tab content
    document.getElementById('content-' + tabName).classList.remove('hidden');
    
    // Add active class to selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    if (activeTab) {
        activeTab.classList.add('active', 'text-[#F13D30]', 'border-[#F13D30]');
        activeTab.classList.remove('text-[#6B7280]', 'border-transparent');
    }
    
    // Update assessment blocks when switching to Assessment tab
    if (tabName === 'assessment' && !skipUpdate) {
        // Use setTimeout to ensure tab switch happens first, then update blocks
        setTimeout(function() {
            try {
                if (typeof updateAllAssessmentBlocks === 'function') {
                    updateAllAssessmentBlocks();
                }
            } catch (error) {
                console.error('Error updating assessment blocks:', error);
            }
        }, 0);
    }
    
    // Update result blocks when switching to Result tab
    if (tabName === 'result') {
        // Use setTimeout to ensure tab switch happens first, then update blocks
        setTimeout(function() {
            try {
                if (typeof updateAllResultBlocks === 'function') {
                    updateAllResultBlocks();
                }
            } catch (error) {
                console.error('Error updating result blocks:', error);
            }
        }, 0);
    }
}

// Save section data (saves all profile data)
async function saveSection() {
    // Ensure vendor link is saved to the saved div if it exists in input but not in saved div
    const linkInput = document.getElementById('vendor-evidence-link');
    const savedLinkDiv = document.getElementById('vendor-link-saved');
    const linkText = document.getElementById('vendor-link-text');
    
    if (linkInput && linkInput.value && linkInput.value.trim()) {
        // If input has value but saved div is hidden, update saved div
        if (savedLinkDiv && savedLinkDiv.classList.contains('hidden')) {
            if (linkText) {
                linkText.innerHTML = `<a href="${linkInput.value.trim()}" target="_blank" class="text-[#F13D30] hover:underline">${linkInput.value.trim()}</a>`;
                savedLinkDiv.classList.remove('hidden');
            }
        }
    }
    
    // Save all profile data (sections are part of profile)
    const success = await saveProfileData();
    if (success) {
        alert('Section saved successfully!');
    } else {
        alert('Error saving section. Please try again.');
    }
}

// Save all and proceed to Assessment
async function saveAllAndProceedToAssessment() {
    // Save all profile data first
    const success = await saveProfileData();
    if (success) {
        // Switch to Assessment tab, but SKIP triggering updateAllAssessmentBlocks 
        // because saveProfileData already called updateAssessmentBlocksFromBE with fresh data.
        switchTab('assessment', true);
    } else {
        alert('Error saving data. Please try again.');
    }
}

// Proceed to Result
function proceedToResult() {
    try {
        // Recheck and update all result blocks before switching
        if (typeof updateAllResultBlocks === 'function') {
            updateAllResultBlocks();
        }
    } catch (error) {
        console.error('Error updating result blocks:', error);
    }
    // Switch to Result tab
    switchTab('result');
}

// Section toggle
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const toggle = document.getElementById(sectionId + '-toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.src = '{% static "governance/img/chevron-up.svg" %}';
    } else {
        content.style.display = 'none';
        toggle.src = '{% static "governance/img/chevron-down.svg" %}';
    }
}

// Load AI System detail data from API
async function loadAISystemDetailData() {
    // Get agent_id from data attribute
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    if (!agentId) {
        console.warn('No agent ID available');
        return;
    }
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/detail/`, {
            method: 'GET',
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
            // Load documents
            if (result.data.documents && result.data.documents.length > 0) {
                loadDocuments(result.data.documents);
            }
            
            // Load profile data if exists
            if (result.data.profile) {
                loadProfileData(result.data.profile);
            }
            
            // Load assessment data if exists
            if (result.data.assessment) {
                loadAssessmentData(result.data.assessment);
                
                // Load Block 1 state from BE
                if (result.data.assessment.block1_state) {
                    block1State.prohibitedConfirmed = result.data.assessment.block1_state.prohibited_confirmed || false;
                    block1State.claimingException = result.data.assessment.block1_state.claiming_exception || '';
                    block1State.exceptionQualifies = result.data.assessment.block1_state.exception_qualifies || '';
                    block1State.exceptionEvidenceUploaded = result.data.assessment.block1_state.exception_evidence_uploaded || false;
                    block1State.exceptionEvidenceSavedLink = result.data.assessment.block1_state.exception_evidence_saved_link || '';
                    block1State.noExceptionConfirmed = result.data.assessment.block1_state.no_exception_confirmed || false;
                }
                
                // Load Block 2 state from BE
                if (result.data.assessment.block2_state) {
                    block2State.highRiskConfirmed = result.data.assessment.block2_state.high_risk_confirmed || false;
                    block2State.materialInfluence = result.data.assessment.block2_state.material_influence || '';
                    block2State.narrowTasks = result.data.assessment.block2_state.narrow_tasks || [];
                    block2State.profiling = result.data.assessment.block2_state.profiling || '';
                    block2State.exemptionEvidenceUploaded = result.data.assessment.block2_state.exemption_evidence_uploaded || false;
                    block2State.exemptionEvidenceSavedLink = result.data.assessment.block2_state.exemption_evidence_saved_link || '';
                }
                
                // Load Block 3 state from BE
                if (result.data.assessment.block3_state) {
                    block3State.transparencyConfirmed = result.data.assessment.block3_state.transparency_confirmed || false;
                    block3State.exceptionOptions = result.data.assessment.block3_state.exception_options || [];
                    block3State.transparencyEvidenceUploaded = result.data.assessment.block3_state.transparency_evidence_uploaded || false;
                    block3State.transparencyEvidenceSavedLink = result.data.assessment.block3_state.transparency_evidence_saved_link || '';
                }
                
                // Load Block 4 state from BE
                if (result.data.assessment.block4_state) {
                    block4State.gpaiConfirmed = result.data.assessment.block4_state.gpai_confirmed || false;
                    block4State.gpaiProviderAnswer = result.data.assessment.block4_state.gpai_provider_answer || '';
                }
            }
            
            console.log('AI System detail data loaded successfully');
        } else {
            console.log('No saved detail data found, starting fresh');
        }
    } catch (error) {
        console.error('Error loading AI System detail data:', error);
    }
}

// Load documents into UI
function loadDocuments(documents) {
    const container = document.getElementById('uploaded-documents');
    if (!container) return;
    
    container.innerHTML = ''; // Clear existing
    
    documents.forEach((doc, index) => {
        const fileId = 'file-' + Date.now() + '-' + index;
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-[#E5E7EB]';
        fileItem.setAttribute('data-file-name', doc.name || '');
        fileItem.setAttribute('data-file-url', doc.url || '');
        fileItem.setAttribute('data-file-path', doc.path || '');
        
        // Calculate time ago
        let uploadedText = 'recently';
        if (doc.uploaded_at) {
            try {
                const uploadedDate = new Date(doc.uploaded_at);
                const now = new Date();
                const diffMs = now - uploadedDate;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) {
                    uploadedText = 'just now';
                } else if (diffMins < 60) {
                    uploadedText = `${diffMins} mins ago`;
                } else if (diffMins < 1440) {
                    uploadedText = `${Math.floor(diffMins / 60)} hours ago`;
                } else {
                    uploadedText = `${Math.floor(diffMins / 1440)} days ago`;
                }
            } catch (e) {
                uploadedText = 'recently';
            }
        }
        
        fileItem.innerHTML = `
            <div class="flex items-center gap-3">
                <label class="cursor-pointer">
                    <input type="checkbox" class="file-checkbox hidden" data-file-id="${fileId}" onchange="toggleFileSelection(this)">
                    <div class="file-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center">
                        <svg class="hidden check-icon w-3 h-3 text-[#F13D30]" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </label>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="w-5 h-5 text-[#DC2626]">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14,2 14,8 20,8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                    <polyline points="10,9 9,9 8,9" />
                </svg>
                <div>
                    <p class="text-sm font-medium text-[#111827]">${doc.name || 'Unknown'}</p>
                    <p class="text-xs text-[#6B7280]">Uploaded ${uploadedText}</p>
                </div>
            </div>
            <button onclick="generateLink('${doc.name || ''}')" class="flex items-center gap-2 px-4 py-1.5 bg-[#F13D30] text-white text-sm rounded-lg hover:bg-[#d63529] transition-colors">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                Generate link
            </button>
        `;
        container.appendChild(fileItem);
    });
    
    updateDeleteButtonVisibility();
}

// Load profile data into form fields
function loadProfileData(profileData) {
    if (!profileData) return;
    
    console.log('Loading profile data:', profileData);
    
    // Section 2: System Identity
    if (profileData.system_identity) {
        const si = profileData.system_identity;
        setValue('ai_system_name', si.ai_system_name);
        setValue('internal_system_id', si.internal_system_id);
        setValue('commercial_name', si.commercial_name);
        setValue('owner_name', si.owner_name);
        setValue('owner_email', si.owner_email);
        setValue('owner_department', si.owner_department);
        setChecked('same_as_compliance_owner', si.same_as_compliance_owner);
        setValue('system_status', si.system_status);
        setValue('go_live_date', si.go_live_date);
        setRadio('part_of_product', si.part_of_product);
        setValue('product_service_name', si.product_service_name);
    }
    
    // Section 3: Source & Operator Role
    if (profileData.source_operator_role) {
        const sor = profileData.source_operator_role;
        setRadio('default_role_apply', sor.default_role_apply);
        setCheckboxes('roles[]', sor.roles);  // Fix: field name is roles[]
        setRadio('system_source', sor.system_source);
        setValue('vendor_name', sor.vendor_name);
        setVendorEvidenceLink(sor.vendor_evidence_link);  // Set link to saved div
        setRadio('modify_customize', sor.modify_customize);
        setRadio('eu_usage', sor.eu_usage);
        setRadio('eu_effect', sor.eu_effect);
        if (window.refreshEuActNotice) window.refreshEuActNotice();
    }
    
    // Section 4: Intended Purpose
    if (profileData.intended_purpose) {
        const ip = profileData.intended_purpose;
        setValue('intended_purpose', ip.intended_purpose);
        setCheckboxes('sector_domain', ip.sector_domain);
        setValue('sector_other', ip.sector_other);
        setRadio('safety_component', ip.safety_component);
        setRadio('third_party_conformity', ip.third_party_conformity);
    }
    
    // Section 5-9: Other sections
    if (profileData.deployment_context) {
        setRadio('deployment_context', profileData.deployment_context);  // Fix: deployment_context is radio
        // Show Other input if value is "Other"
        if (profileData.deployment_context === 'Other' && profileData.deployment_other) {
            setTimeout(() => {
                const otherInput = document.getElementById('deployment-other-input');
                if (otherInput) {
                    otherInput.classList.remove('hidden');
                    otherInput.value = profileData.deployment_other;
                }
            }, 100);
        }
    }
    if (profileData.system_users) {
        setCheckboxes('system_users', profileData.system_users);
        // Show Other input if "Other" is selected
        if (profileData.system_users.includes('Other') && profileData.system_users_other) {
            setTimeout(() => {
                const otherInput = document.getElementById('system-users-other-input');
                if (otherInput) {
                    otherInput.classList.remove('hidden');
                    otherInput.value = profileData.system_users_other;
                }
            }, 100);
        }
    }
    if (profileData.affected_outputs) {
        setCheckboxes('affected_outputs', profileData.affected_outputs);
        // Show Other input if "Other" is selected
        if (profileData.affected_outputs.includes('Other') && profileData.affected_outputs_other) {
            setTimeout(() => {
                const otherInput = document.getElementById('affected-outputs-other-input');
                if (otherInput) {
                    otherInput.classList.remove('hidden');
                    otherInput.value = profileData.affected_outputs_other;
                }
            }, 100);
        }
    }
    if (profileData.vulnerable_groups) setCheckboxes('vulnerable_groups', profileData.vulnerable_groups);
    if (profileData.workflow_role) setRadio('workflow_role', profileData.workflow_role);
    if (profileData.output_types) setCheckboxes('output_types', profileData.output_types);
    if (profileData.decision_influence) setRadio('decision_influence', profileData.decision_influence);
    if (profileData.auto_execute) setRadio('auto_execute', profileData.auto_execute);
    if (profileData.capability_practices) setCheckboxes('capability_practices', profileData.capability_practices);
    if (profileData.interacts_persons) setRadio('interacts_persons', profileData.interacts_persons);
    if (profileData.synthetic_content) setCheckboxes('synthetic_content', profileData.synthetic_content);
    if (profileData.ai_kind) setCheckboxes('ai_kind', profileData.ai_kind);
    if (profileData.gpai_integration) setRadio('gpai_integration', profileData.gpai_integration);
    if (profileData.gpai_provider) setValue('gpai_provider', profileData.gpai_provider);
    if (profileData.training_source) setRadio('training_source', profileData.training_source);
    if (profileData.update_frequency) setRadio('update_frequency', profileData.update_frequency);
    if (profileData.data_types) setCheckboxes('data_types', profileData.data_types);
}

// Helper functions to set form values
function setValue(name, value) {
    if (!value) return;
    const field = document.querySelector(`[name="${name}"]`);
    if (field) {
        if (field.type === 'checkbox') {
            field.checked = value;
        } else {
            field.value = value;
        }
    }
}

function setRadio(name, value) {
    if (!value) return;
    const radio = document.querySelector(`[name="${name}"][value="${value}"]`);
    if (radio) {
        radio.checked = true;
        // Trigger change event for conditional logic (important for system_source to show vendor fields, safety_component to show third_party_conformity)
        radio.dispatchEvent(new Event('change', { bubbles: true }));
        
        // Special handling for system_source to ensure vendor fields are shown
        if (name === 'system_source' && (value === 'Vendor / Third-party' || value === 'Mixed')) {
            setTimeout(() => {
                const vendorFields = document.getElementById('vendor-fields');
                if (vendorFields) {
                    vendorFields.classList.remove('hidden');
                }
            }, 100);
        }
        
        // Special handling for safety_component to ensure third_party_conformity field is shown
        if (name === 'safety_component' && value === 'Yes') {
            setTimeout(() => {
                const thirdPartyField = document.getElementById('third-party-conformity-field');
                if (thirdPartyField) {
                    thirdPartyField.classList.remove('hidden');
                }
            }, 100);
        }
    }
}

function setCheckboxes(name, values) {
    if (!values || !Array.isArray(values)) {
        // If no values, uncheck all checkboxes with this name
        const allCheckboxes = document.querySelectorAll(`[name="${name}"], [name="${name}[]"]`);
        allCheckboxes.forEach(cb => cb.checked = false);
        return;
    }
    
    // First, uncheck all checkboxes with this name
    const allCheckboxes = document.querySelectorAll(`[name="${name}"], [name="${name}[]"]`);
    allCheckboxes.forEach(cb => cb.checked = false);
    
    // Then, check only the ones in the values array
    values.forEach(value => {
        // Support both "roles" and "roles[]" format
        const checkbox = document.querySelector(`[name="${name}"][value="${value}"], [name="${name}[]"][value="${value}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
}

// Set vendor evidence link to saved div
function setVendorEvidenceLink(link) {
    if (!link) return;
    
    const savedLinkDiv = document.getElementById('vendor-link-saved');
    const linkText = document.getElementById('vendor-link-text');
    const linkInput = document.getElementById('vendor-evidence-link');
    
    if (savedLinkDiv && linkText) {
        // Create clickable link
        linkText.innerHTML = `<a href="${link}" target="_blank" class="text-[#F13D30] hover:underline">${link}</a>`;
        savedLinkDiv.classList.remove('hidden');
        
        // Also set input value for reference
        if (linkInput) {
            linkInput.value = link;
        }
    } else if (linkInput) {
        // Fallback to input field
        linkInput.value = link;
    }
}

function setChecked(name, checked) {
    if (checked === undefined || checked === null) return;
    const checkbox = document.getElementById(name) || document.querySelector(`[name="${name}"]`);
    if (checkbox) {
        checkbox.checked = checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
}

// Collect all profile form data
function collectProfileData() {
    // Debug: Check vendor evidence link before collecting
    const vendorLink = getVendorEvidenceLink();
    console.log('Collecting profile data - vendor_evidence_link:', vendorLink);
    
    const profile = {
        system_identity: {
            ai_system_name: getValue('ai_system_name'),
            internal_system_id: getValue('internal_system_id'),
            commercial_name: getValue('commercial_name'),
            owner_name: getValue('owner_name'),
            owner_email: getValue('owner_email'),
            owner_department: getValue('owner_department'),
            same_as_compliance_owner: getChecked('same_as_compliance_owner'),
            system_status: getValue('system_status'),
            go_live_date: getValue('go_live_date'),
            part_of_product: getRadio('part_of_product'),
            product_service_name: getValue('product_service_name')
        },
        source_operator_role: {
            default_role_apply: getRadio('default_role_apply'),
            roles: getCheckboxes('roles[]'),  // Fix: field name is roles[]
            system_source: getRadio('system_source'),
            vendor_name: getValue('vendor_name'),
            vendor_evidence_link: getVendorEvidenceLink(),  // Get link from saved div or input
            modify_customize: getRadio('modify_customize'),
            eu_usage: getRadio('eu_usage'),
            eu_effect: getRadio('eu_effect')
        },
        intended_purpose: {
            intended_purpose: getValue('intended_purpose'),
            sector_domain: getCheckboxes('sector_domain'),
            sector_other: getValue('sector_other'),
            safety_component: getRadio('safety_component'),
            third_party_conformity: getRadio('third_party_conformity')
        },
        deployment_context: getRadio('deployment_context'),  // Fix: deployment_context is radio, not checkbox
        deployment_other: getValue('deployment_other'),  // Add Other field
        system_users: getCheckboxes('system_users'),
        system_users_other: getValue('system_users_other'),  // Add Other field
        affected_outputs: getCheckboxes('affected_outputs'),
        affected_outputs_other: getValue('affected_outputs_other'),  // Add Other field
        vulnerable_groups: getCheckboxes('vulnerable_groups'),
        workflow_role: getRadio('workflow_role'),
        output_types: getCheckboxes('output_types'),
        decision_influence: getRadio('decision_influence'),
        auto_execute: getRadio('auto_execute'),
        capability_practices: getCheckboxes('capability_practices'),
        interacts_persons: getRadio('interacts_persons'),
        synthetic_content: getCheckboxes('synthetic_content'),
        ai_kind: getCheckboxes('ai_kind'),
        gpai_integration: getRadio('gpai_integration'),
        gpai_provider: getValue('gpai_provider'),
        training_source: getRadio('training_source'),
        update_frequency: getRadio('update_frequency'),
        data_types: getCheckboxes('data_types')
    };
    
    return profile;
}

// Helper functions to get form values
function getValue(name) {
    const field = document.querySelector(`[name="${name}"]`);
    return field ? field.value : '';
}

function getRadio(name) {
    const radio = document.querySelector(`[name="${name}"]:checked`);
    return radio ? radio.value : '';
}

function getCheckboxes(name) {
    // Support both "roles" and "roles[]" format
    // IMPORTANT: Only get checked checkboxes, not all checkboxes
    const checkboxes = Array.from(document.querySelectorAll(`[name="${name}"]:checked, [name="${name}[]"]:checked`));
    return checkboxes.map(cb => cb.value);
}

// Get vendor evidence link from saved div or input field
function getVendorEvidenceLink() {
    const savedLinkDiv = document.getElementById('vendor-link-saved');
    const linkText = document.getElementById('vendor-link-text');
    const linkInput = document.getElementById('vendor-evidence-link');
    
    // Debug
    console.log('getVendorEvidenceLink - savedLinkDiv:', savedLinkDiv);
    console.log('getVendorEvidenceLink - linkText:', linkText);
    console.log('getVendorEvidenceLink - linkInput:', linkInput);
    console.log('getVendorEvidenceLink - linkInput.value:', linkInput?.value);
    
    // Priority: Check input field first (most up-to-date)
    // Then check saved div
    if (linkInput && linkInput.value && linkInput.value.trim()) {
        const linkValue = linkInput.value.trim();
        console.log('getVendorEvidenceLink - returning from input:', linkValue);
        return linkValue;
    }
    
    // Fallback to saved div if input is empty
    if (savedLinkDiv && !savedLinkDiv.classList.contains('hidden') && linkText) {
        // Extract link from text or href if it's a link element
        const linkMatch = linkText.innerHTML.match(/href="([^"]+)"/);
        if (linkMatch) {
            console.log('getVendorEvidenceLink - returning from saved div (href):', linkMatch[1]);
            return linkMatch[1];
        }
        // Or get text content if it's just text
        const text = linkText.textContent || linkText.innerText;
        if (text && text.trim()) {
            console.log('getVendorEvidenceLink - returning from saved div (text):', text.trim());
            return text.trim();
        }
    }
    
    console.log('getVendorEvidenceLink - returning empty string');
    return '';
}

function getChecked(name) {
    const checkbox = document.getElementById(name) || document.querySelector(`[name="${name}"]`);
    return checkbox ? checkbox.checked : false;
}

// Save profile data to API
async function saveProfileData() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    if (!agentId) {
        console.error('No agent ID available');
        return false;
    }
    
    try {
        // Ensure vendor link is captured from input field if user hasn't clicked "Save link"
        const linkInput = document.getElementById('vendor-evidence-link');
        if (linkInput && linkInput.value && linkInput.value.trim()) {
            // Update saved div to reflect current input value
            const savedLinkDiv = document.getElementById('vendor-link-saved');
            const linkText = document.getElementById('vendor-link-text');
            if (savedLinkDiv && linkText) {
                linkText.innerHTML = `<a href="${linkInput.value.trim()}" target="_blank" class="text-[#F13D30] hover:underline">${linkInput.value.trim()}</a>`;
                savedLinkDiv.classList.remove('hidden');
            }
        }
        
        const profileData = collectProfileData();
        console.log('Saving profile data:', profileData);
        console.log('Vendor evidence link in profile:', profileData.source_operator_role?.vendor_evidence_link);
        
        const response = await fetch(`/api/ai-inventory/${agentId}/detail/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                profile: profileData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Profile data saved successfully');
            
            // If assessment results are returned from BE, update assessment blocks
            if (result.assessment) {
                console.log('Assessment results from BE:', result.assessment);
                updateAssessmentBlocksFromBE(result.assessment);
            }
            
            return true;
        } else {
            console.error('Error saving profile data:', result.error);
            return false;
        }
    } catch (error) {
        console.error('Error saving profile data:', error);
        return false;
    }
}

// Load assessment data (placeholder - to be implemented based on form structure)
function loadAssessmentData(assessmentData) {
    if (!assessmentData) return;
    console.log('Loading assessment data:', assessmentData);
    // TODO: Implement loading assessment form fields when needed
}

// File upload handling
document.getElementById('file-upload')?.addEventListener('change', async function(e) {
    const files = Array.from(e.target.files);
    const container = document.getElementById('uploaded-documents');
    if (!container || !files?.length) return;
    
    // Get agent_id from data attribute
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    // Upload files to static folder using general upload API
    try {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('file', file);
        });
        formData.append('folder', 'governance/uploads');
        
        const uploadResponse = await fetch('/api/upload-file/', {
            method: 'POST',
            body: formData,
        });
        
        const uploadResult = await uploadResponse.json();
        
        if (!uploadResponse.ok || !uploadResult.success) {
            throw new Error(uploadResult.error || uploadResult.message || 'Upload failed');
        }
        
        // Prepare file info
        const fileInfos = uploadResult.files.map(fileInfo => ({
            name: fileInfo.name,
            size: fileInfo.size,
            url: fileInfo.url,
            path: fileInfo.path,
            uploaded_at: new Date().toISOString()
        }));
        
        // Get existing documents
        let existingDocuments = [];
        try {
            const getResponse = await fetch(`/api/ai-inventory/${agentId}/detail/`);
            const getResult = await getResponse.json();
            if (getResult.success && getResult.data && getResult.data.documents) {
                existingDocuments = getResult.data.documents;
            }
        } catch (e) {
            console.warn('Could not load existing documents:', e);
        }
        
        // Merge new files with existing
        const allDocuments = [...existingDocuments, ...fileInfos];
        
        // Save documents to detail API
        try {
            const saveResponse = await fetch(`/api/ai-inventory/${agentId}/detail/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    documents: allDocuments
                })
            });
            
            if (!saveResponse.ok) {
                console.warn('Could not save file info to detail data');
            }
        } catch (e) {
            console.warn('Error saving file info:', e);
        }
        
        // Add uploaded files to UI
        fileInfos.forEach(fileInfo => {
            const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-[#E5E7EB]';
            fileItem.setAttribute('data-file-name', fileInfo.name);
            fileItem.setAttribute('data-file-url', fileInfo.url);
            fileItem.setAttribute('data-file-path', fileInfo.path);
            fileItem.innerHTML = `
                <div class="flex items-center gap-3">
                    <label class="cursor-pointer">
                        <input type="checkbox" class="file-checkbox hidden" data-file-id="${fileId}" onchange="toggleFileSelection(this)">
                        <div class="file-checkbox-display w-5 h-5 border-2 border-[#111827] rounded flex items-center justify-center">
                            <svg class="hidden check-icon w-3 h-3 text-[#F13D30]" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </label>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        class="w-5 h-5 text-[#DC2626]">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14,2 14,8 20,8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10,9 9,9 8,9" />
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-[#111827]">${fileInfo.name}</p>
                        <p class="text-xs text-[#6B7280]">Uploaded just now</p>
                    </div>
                </div>
                <button onclick="generateLink('${fileInfo.name}')" class="flex items-center gap-2 px-4 py-1.5 bg-[#F13D30] text-white text-sm rounded-lg hover:bg-[#d63529] transition-colors">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    Generate link
                </button>
            `;
            container.appendChild(fileItem);
        });
        
        e.target.value = '';
        updateDeleteButtonVisibility();
    } catch (error) {
        console.error('Upload error:', error);
        alert(`Error uploading files: ${error.message}`);
    }
});

// Toggle file selection
function toggleFileSelection(checkbox) {
    const display = checkbox.nextElementSibling;
    const checkIcon = display.querySelector('.check-icon');
    
    if (checkbox.checked) {
        display.classList.remove('border-[#111827]');
        display.classList.add('border-[#F13D30]', 'bg-white');
        checkIcon.classList.remove('hidden');
    } else {
        display.classList.remove('border-[#F13D30]');
        display.classList.add('border-[#111827]');
        checkIcon.classList.add('hidden');
    }
    
    // Update delete button visibility
    updateDeleteButtonVisibility();
}

// Update delete button visibility based on selected files
function updateDeleteButtonVisibility() {
    const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
    const deleteBtn = document.getElementById('delete-selected-files-btn');
    
    if (deleteBtn) {
        if (selectedCheckboxes.length > 0) {
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }
    }
}

// Delete selected files
async function deleteSelectedFiles() {
    const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        return;
    }
    
    const confirmDelete = confirm(
        `Are you sure you want to delete ${selectedCheckboxes.length} selected file${selectedCheckboxes.length > 1 ? 's' : ''}? This action cannot be undone.`
    );
    
    if (!confirmDelete) {
        return;
    }
    
    // Get agent_id
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    // Collect file information from selected checkboxes
    const filesToDelete = [];
    selectedCheckboxes.forEach(checkbox => {
        const fileItem = checkbox.closest('.flex.items-center.justify-between');
        if (fileItem) {
            const fileName = fileItem.getAttribute('data-file-name');
            const fileUrl = fileItem.getAttribute('data-file-url');
            const filePath = fileItem.getAttribute('data-file-path');
            
            if (fileName) {
                filesToDelete.push({
                    name: fileName,
                    url: fileUrl || '',
                    path: filePath || ''
                });
            }
        }
    });
    
    if (filesToDelete.length === 0) {
        alert('No file information found to delete');
        return;
    }
    
    try {
        // Get current documents
        let currentDocuments = [];
        try {
            const getResponse = await fetch(`/api/ai-inventory/${agentId}/detail/`);
            const getResult = await getResponse.json();
            if (getResult.success && getResult.data && getResult.data.documents) {
                currentDocuments = getResult.data.documents;
            }
        } catch (e) {
            console.warn('Could not load current documents:', e);
        }
        
        // Remove deleted files from documents array
        const remainingDocuments = currentDocuments.filter(doc => {
            return !filesToDelete.some(fileToDelete => fileToDelete.name === doc.name);
        });
        
        // Update detail data
        const saveResponse = await fetch(`/api/ai-inventory/${agentId}/detail/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                documents: remainingDocuments
            })
        });
        
        if (!saveResponse.ok) {
            throw new Error('Failed to update documents');
        }
        
        // Remove file items from DOM
        selectedCheckboxes.forEach(checkbox => {
            const fileItem = checkbox.closest('.flex.items-center.justify-between');
            if (fileItem) {
                fileItem.remove();
            }
        });
        
        // Update delete button visibility after deletion
        updateDeleteButtonVisibility();
        
        console.log(`Successfully deleted ${filesToDelete.length} file(s)`);
    } catch (error) {
        console.error('Error deleting files:', error);
        alert(`Error deleting files: ${error.message}`);
    }
}

// Initialize delete button visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDeleteButtonVisibility();
});

// AI Read toggle
document.querySelectorAll('.ai-read-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.ai-read-toggle').forEach(b => {
            b.classList.remove('active');
            b.classList.remove('bg-[#F13D30]', 'text-white', 'shadow-sm');
            b.classList.add('border', 'border-[#F13D30]', 'text-[#F13D30]', 'bg-white');
            // Update icon to red
            const icon = b.querySelector('img');
            if (icon) {
                icon.style.filter = 'brightness(0) saturate(100%) invert(32%) sepia(98%) saturate(1500%) hue-rotate(344deg) brightness(98%) contrast(95%)';
            }
        });
        this.classList.add('active', 'bg-[#F13D30]', 'text-white', 'shadow-sm');
        this.classList.remove('border', 'border-[#F13D30]', 'text-[#F13D30]', 'bg-white');
        // Update icon to white
        const icon = this.querySelector('img');
        if (icon) {
            icon.style.filter = 'brightness(0) invert(1)';
        }
    });
});

// Generate link function
function generateLink(fileName) {
    const safeName = fileName || 'document';
    const randomId = (self.crypto && self.crypto.randomUUID) ? self.crypto.randomUUID() : Date.now().toString(36);
    const link = `https://${randomId}`;
    openShareModal(safeName, link);
}

// Generate link modal helpers
function openShareModal(fileName, link) {
    const modal = document.getElementById('share-link-modal');
    const nameEl = document.getElementById('share-file-name');
    const inputEl = document.getElementById('share-link-input');
    const copyBtn = document.getElementById('share-link-copy-btn');
    if (!modal || !nameEl || !inputEl || !copyBtn) return;

    nameEl.textContent = fileName;
    inputEl.value = link;
    modal.classList.remove('hidden');

    // Reset button to initial state
    const iconEl = document.getElementById('share-link-chain-icon');
    const textEl = document.getElementById('share-link-text');
    if (iconEl && textEl) {
        // Reset to chain-link icon
        iconEl.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>';
        textEl.textContent = 'Copy';
    }
}

function closeShareModal() {
    const modal = document.getElementById('share-link-modal');
    if (modal) modal.classList.add('hidden');
}

// Copy button handler
document.getElementById('share-link-copy-btn')?.addEventListener('click', function() {
    const inputEl = document.getElementById('share-link-input');
    const iconEl = document.getElementById('share-link-chain-icon');
    const textEl = document.getElementById('share-link-text');
    
    if (!inputEl || !inputEl.value || !iconEl || !textEl) return;
    
    navigator.clipboard.writeText(inputEl.value).then(() => {
        // Change icon to checkmark
        iconEl.innerHTML = '<polyline points="20,6 9,17 4,12" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></polyline>';
        // Change text to "Copied"
        textEl.textContent = 'Copied';
    }).catch(() => {
        alert('Unable to copy link');
    });
});

// Close modal when clicking outside content
document.getElementById('share-link-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeShareModal();
    }
});

// Assessment Block Logic
let assessmentBlockStates = {
    1: false, 2: false, 3: false, 4: false
};

function toggleAssessmentBlock(blockNum) {
    const content = document.getElementById(`block-${blockNum}-content`);
    const chevron = document.getElementById(`block-${blockNum}-chevron`);
    
    if (assessmentBlockStates[blockNum]) {
        content.classList.add('hidden');
        chevron.src = '{% static "governance/img/chevron-down.svg" %}';
        assessmentBlockStates[blockNum] = false;
    } else {
        content.classList.remove('hidden');
        chevron.src = '{% static "governance/img/chevron-up.svg" %}';
        assessmentBlockStates[blockNum] = true;
        updateAssessmentBlock(blockNum);
    }
}

// Block 1 State Variables (for confirmation and exception flow)
// This will be synced with BE state when loading assessment
let block1State = {
    prohibitedConfirmed: false,
    claimingException: '', // 'Yes' | 'No' | ''
    exceptionQualifies: '', // 'Yes' | 'No' | 'Not sure' | ''
    exceptionEvidenceUploaded: false,
    exceptionEvidenceSavedLink: '',
    exceptionEvidenceFiles: [], // Array of {name, url, path, size}
    noExceptionConfirmed: false,
    be_assessment: null // Store BE assessment results for reference
};

// Block 2 State Variables (for confirmation and Annex III flow)
// This will be synced with BE state when loading assessment
let block2State = {
    highRiskConfirmed: false,
    materialInfluence: '', // 'Yes' | 'No' | 'Not sure' | ''
    narrowTasks: [], // Array of task strings
    profiling: '', // 'Yes' | 'No' | 'Unknown' | ''
    exemptionEvidenceUploaded: false,
    exemptionEvidenceSavedLink: '',
    be_assessment: null // Store BE assessment results for reference
};

// Block 3 State Variables (for confirmation and exception flow)
// This will be synced with BE state when loading assessment
let block3State = {
    transparencyConfirmed: false,
    exceptionOptions: [], // Array of selected exception options
    transparencyEvidenceUploaded: false,
    transparencyEvidenceSavedLink: '',
    be_assessment: null // Store BE assessment results for reference
};

// Block 4 State Variables (for confirmation and provider determination)
// This will be synced with BE state when loading assessment
let block4State = {
    gpaiConfirmed: false,
    gpaiProviderAnswer: '', // 'Yes' | 'No' | 'Not sure' | ''
    be_assessment: null // Store BE assessment results for reference
};

// Prohibited Practices Mapping (from Block_1_Prohibited_Practices_Logic.md)
const prohibitedPracticesMap = {
    'Subliminal / manipulative / deceptive techniques that materially distort behaviour and are likely to cause significant harm': {
        'label': 'Subliminal/manipulative/deceptive techniques',
        'article': '5(1)(a)',
        'has_exception': false,
        'exception_condition': null
    },
    'Exploitation of vulnerabilities (age, disability, or social / economic situation) to distort behaviour likely causing significant harm': {
        'label': 'Exploitation of vulnerabilities',
        'article': '5(1)(b)',
        'has_exception': false,
        'exception_condition': null
    },
    'Social scoring leading to detrimental / unfavourable treatment (esp. unjustified / disproportionate)': {
        'label': 'Social scoring',
        'article': '5(1)(c)',
        'has_exception': false,
        'exception_condition': null
    },
    'Criminal offence risk assessment / prediction based solely on profiling or personality traits (individual predictive policing)': {
        'label': 'Criminal offence risk assessment',
        'article': '5(1)(d)',
        'has_exception': true,
        'exception_condition': 'AI system is used to support a human assessment based on objective and verifiable facts directly linked to criminal activity (not solely profiling). (Art.5(1)(d))'
    },
    'Untargeted scraping of facial images from the internet or CCTV to build / expand facial recognition databases': {
        'label': 'Untargeted facial image scraping',
        'article': '5(1)(e)',
        'has_exception': false,
        'exception_condition': null
    },
    'Emotion recognition in the workplace or in education settings': {
        'label': 'Emotion recognition in workplace/education',
        'article': '5(1)(f)',
        'has_exception': true,
        'exception_condition': 'AI system is for medical or safety reasons. (Art.5(1)(f))'
    },
    'Biometric categorisation that infers or predicts sensitive traits (e.g., race, political opinions, religion, trade union membership, sexual orientation)': {
        'label': 'Biometric categorisation (sensitive traits)',
        'article': '5(1)(g)',
        'has_exception': true,
        'exception_condition': 'AI system is for labelling or filtering of lawfully acquired biometric datasets, such as images, based on biometric data or categorizing of biometric data in the area of law enforcement. (Art.5(1)(g))'
    },
    'Real-time remote biometric identification (RBI) in publicly accessible spaces for law enforcement purposes': {
        'label': 'Real-time remote biometric identification (RBI)',
        'article': '5(1)(h)',
        'has_exception': true,
        'exception_condition': 'Only if strictly necessary for one of the listed objectives (victims / imminent serious threat / serious crime suspect) and with safeguards + authorisation requirements (Art. 5(2)â€“(7)).'
    }
};

// Helper function to determine if Block 1 resulted in Prohibited
function isBlock1Prohibited() {
    const status = getProhibitedStatus();
    return status === 'Prohibited';
}

// Assessment Status Calculation Functions - Now pure getters from BE state
function getProhibitedStatus() {
    if (block1State.be_assessment && block1State.be_assessment.status) {
        return block1State.be_assessment.status;
    }
    return 'Not assessed';
}

function getHighRiskStatus() {
    // If Block 1 is Prohibited, Block 2 is de-activated
    if (isBlock1Prohibited()) {
        return 'De-activated';
    }
    
    if (block2State.be_assessment && block2State.be_assessment.status) {
        return block2State.be_assessment.status;
    }
    
    return 'Not assessed';
}

function getTransparencyStatus() {
    // If Block 1 is Prohibited, Block 3 is de-activated
    if (isBlock1Prohibited()) {
        return 'De-activated';
    }
    
    if (block3State.be_assessment && block3State.be_assessment.status) {
        return block3State.be_assessment.status;
    }

    return 'Not assessed';
}

function getGPAIStatus() {
    // If Block 1 is Prohibited, Block 4 is de-activated
    if (isBlock1Prohibited()) {
        return 'De-activated';
    }
    
    if (block4State.be_assessment && block4State.be_assessment.status) {
        return block4State.be_assessment.status;
    }

    return 'Not assessed';
}

function getStatusColorClass(status) {
    const statusColors = {
        'PASS': 'bg-[#E8F5E9] text-[#2E7D32]',
        'Not Prohibited': 'bg-[#E8F5E9] text-[#2E7D32]',
        'Triggered': 'bg-[#FFF3E0] text-[#E65100]',
        'High-risk': 'bg-[#FFF3E0] text-[#E65100]',
        'Prohibited': 'bg-[#FFEBEE] text-[#C62828]',
        'Exception claimed': 'bg-[#E8F5E9] text-[#2E7D32]',
        'Needs Review': 'bg-[#FFF9E6] text-[#F57C00]',
        'Not assessed': 'bg-[#F0F1F2] text-[#6B7280]',
        'De-activated': 'bg-[#F0F1F2] text-[#B5BCC4]',
        'Applies': 'bg-[#FFF3E0] text-[#E65100]',
        'Not Applicable': 'bg-[#E8F5E9] text-[#2E7D32]',
        'Not high-risk': 'bg-[#E8F5E9] text-[#2E7D32]',
        'Pending': 'bg-[#FFF9E6] text-[#F57C00]'
    };
    return statusColors[status] || 'bg-[#F0F1F2] text-[#6B7280]';
}

function updateAssessmentBlock(blockNum) {
    let status = '';
    let content = '';
    let details = null;
    
    switch(blockNum) {
        case 1:
            status = getProhibitedStatus();
            content = renderBlock1Content(status);
            break;
        case 2:
            // Try to get status from BE assessment first
            if (block2State.be_assessment) {
                status = block2State.be_assessment.status || getHighRiskStatus();
                details = block2State.be_assessment.details || null;
            } else {
                status = getHighRiskStatus();
            }
            content = renderBlock2Content(status, details);
            break;
        case 3:
            // Try to get status from BE assessment first
            if (block3State.be_assessment) {
                status = block3State.be_assessment.status || getTransparencyStatus();
                details = block3State.be_assessment.details || null;
            } else {
                status = getTransparencyStatus();
            }
            content = renderBlock3Content(status, details);
            break;
        case 4:
            // Try to get status from BE assessment first
            if (block4State.be_assessment) {
                status = block4State.be_assessment.status || getGPAIStatus();
                details = block4State.be_assessment.details || null;
            } else {
                status = getGPAIStatus();
            }
            content = renderBlock4Content(status, details);
            break;
    }
    
    // Update status badge
    const statusEl = document.getElementById(`block-${blockNum}-status`);
    if (statusEl) {
        statusEl.textContent = status;
        statusEl.className = `px-4 py-1.5 rounded-full font-semibold text-sm ${getStatusColorClass(status)}`;
    }
    
    // Update content
    const contentEl = document.getElementById(`block-${blockNum}-content-inner`);
    if (contentEl) {
        contentEl.innerHTML = content;
    }
}

function renderConfirmProfileInput(selectedPractices, practicesInfo, showButtons = true) {
    // Generate Article Summary
    const articles = selectedPractices.map(p => {
        const info = practicesInfo[p] || prohibitedPracticesMap[p] || {article: null};
        return info.article ? `Art. ${info.article}` : null;
    }).filter(a => a);
    
    let articleSummary = '';
    if (articles.length > 0) {
        const uniqueArticles = [...new Set(articles)];
        articleSummary = `This is a prohibited practice under ${uniqueArticles.map(a => `${a} of the EU AI Act`).join(', ')}`;
    } else {
        articleSummary = 'This is a prohibited practice under the EU AI Act.';
    }

    // Render content
    let html = `
        <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4 mb-4">
            <div class="mb-4">
                <p class="font-bold text-sm text-[#22262A] mb-2">Confirm Profile input:</p>
                <p class="font-normal text-sm text-[#464E58] mb-1">
                    You indicated the system uses the following capabilities or practices:
                </p>
                <ul class="list-disc list-outside ml-5 space-y-1 mb-3">
                    ${selectedPractices.map(p => `<li class="font-normal text-sm text-[#464E58] pl-1">${p}</li>`).join('')}
                </ul>
                <p class="font-normal text-sm text-[#464E58]">
                    ${articleSummary}
                </p>
            </div>
    `;
    
    if (showButtons) {
        html += `<p class="font-bold text-sm text-[#22262A] mb-4">Do you confirm?</p>
                </div> <!-- End of content div -->
                <div class="flex justify-end gap-3">
                    <button onclick="confirmProhibited(false)" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                        Edit Profile Info
                    </button>
                    <button onclick="confirmProhibited(true)" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Confirm
                    </button>
                </div>`;
    } else {
        html += `</div>`;
    }
    
    return html;
}

function renderBlock1Content(status) {
    if (status === 'Not assessed') {
        return '<p class="font-normal text-sm text-[#464E58]">Please complete Section 7 (Capabilities) in Profile to assess prohibited practices.</p>';
    }
    
    if (status === 'PASS') {
        return `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#2E7D32] mb-2">âœ“ No prohibited practices detected</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    Based on your Profile inputs, this AI system does not appear to fall under the prohibited practices defined in Article 5 of the EU AI Act.
                </p>
            </div>
        `;
    }
    
    // Shared logic for getting selected practices (needed for Triggered and Prohibited)
    let selectedPractices = [];
    let practicesInfo = {};
    if (block1State.be_assessment && block1State.be_assessment.selected_practices) {
        selectedPractices = block1State.be_assessment.selected_practices;
        practicesInfo = block1State.be_assessment.practices_info || {};
    } else {
         // Fallback from DOM
         selectedPractices = Array.from(document.querySelectorAll('input[name="capability_practices"]:checked'))
                .map(cb => cb.value)
                .filter(v => v !== 'None of the above');
         
         selectedPractices.forEach(p => {
             if (prohibitedPracticesMap[p]) {
                 practicesInfo[p] = prohibitedPracticesMap[p];
             }
         });
    }
    
    // For Triggered or Prohibited, we often use the detailed view components
    
    if (status === 'Triggered') {
        if (!block1State.prohibitedConfirmed) {
            // Not confirmed yet: Show Confirm UI with buttons
            return `<div class="space-y-4">` + renderConfirmProfileInput(selectedPractices, practicesInfo, true) + `</div>`;
        } else {
            // Confirmed but still Triggered (likely waiting for Exception Claim answer)
            // Show Read-only Input + Exception Flow
            return `<div class="space-y-4">` + 
                   renderConfirmProfileInput(selectedPractices, practicesInfo, false) + 
                   renderBlock1ExceptionFlow(selectedPractices, practicesInfo) + 
                   `</div>`;
        }
    }
    
    if (status === 'Prohibited') {
        const confirmedBanner = `
            <div class="w-full bg-[#E8F5E9] border border-[#81C784] rounded-lg p-3 mb-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Confirmed</p>
            </div>
        `;
        
        const prohibitedBox = `
            <div class="bg-[#FFF5F5] border border-[#F13D30] rounded-lg p-4">
                <p class="font-bold text-sm text-[#F13D30] mb-2">Result: Prohibited</p>
                <p class="font-normal text-sm text-[#464E58]">
                    Your AI System is Prohibited under Art.5. You need to redesign or remove certain features to make it comply to EU AI Act.
                </p>
            </div>
        `;

        if (selectedPractices.length > 0) {
            return `<div class="space-y-4">` + 
                   renderConfirmProfileInput(selectedPractices, practicesInfo, false) + 
                   confirmedBanner + 
                   prohibitedBox + 
                   `</div>`;
        }
        
        return prohibitedBox;
    }
    
    
    if (status === 'Exception claimed') {
        const confirmedBanner = `
            <div class="w-full bg-[#E8F5E9] border border-[#81C784] rounded-lg p-3 mb-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Confirmed</p>
            </div>
        `;
        
        const exceptionClaimedBox = `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-bold text-sm text-[#2E7D32] mb-2">âœ“ Exception Claimed</p>
                <p class="font-normal text-sm text-[#464E58]">
                    Your exception claim has been recorded with supporting evidence. This will be subject to regulatory review.
                </p>
            </div>
        `;

        return `<div class="space-y-4">` + 
               renderConfirmProfileInput(selectedPractices, practicesInfo, false) + 
               confirmedBanner + 
               exceptionClaimedBox + 
               `</div>`;
    }
    
    if (status === 'Needs Review') {
        if (selectedPractices.length > 0 && block1State.be_assessment) {
            const details = block1State.be_assessment.details || {};
            
            // If user said "Yes" to exception - SHOW EVIDENCE FORM
            // Note: We check block1State.exceptionQualifies which should be synced from BE or set on interaction
            if (block1State.exceptionQualifies === 'Yes') {
                return `<div class="space-y-4">` + 
                       renderConfirmProfileInput(selectedPractices, practicesInfo, false) + 
                       renderBlock1ExceptionEvidenceForm(selectedPractices, practicesInfo) + 
                       `</div>`;
            }

            // Otherwise, this is the "Not sure" case - SHOW RESULT BOX
            const confirmedBanner = `
                <div class="w-full bg-[#E8F5E9] border border-[#81C784] rounded-lg p-3 mb-4">
                    <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Confirmed</p>
                </div>
            `;
            
            const needsReviewBox = `
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-bold text-sm text-[#F57C00] mb-2">Result: Needs Review</p>
                    <p class="font-normal text-sm text-[#464E58]">
                        This system requires legal review to determine if the exception applies. Please consult with your legal team or compliance officer.
                    </p>
                </div>
            `;
            
            return `<div class="space-y-4">` + 
                   renderConfirmProfileInput(selectedPractices, practicesInfo, false) + 
                   confirmedBanner + 
                   needsReviewBox + 
                   `</div>`;
        }
        
        // Default Needs Review (simple view)
        return `
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#F57C00] mb-2">âš ï¸ Needs Review</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    This assessment requires manual review by the compliance team.
                </p>
            </div>
        `;
    }
    
    return '<p class="text-sm text-[#464E58]">Status: ' + status + '</p>';
}

// Render exception flow content (from flowchart)
function renderBlock1ExceptionFlow(selectedPractices, practicesInfo = {}) {
    // Banner for Confirmed state
    const confirmedBanner = `
        <div class="w-full bg-[#E8F5E9] border border-[#81C784] rounded-lg p-3 mb-4">
            <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Confirmed</p>
        </div>
    `;

    // 1. Check if ANY practice has NO exception available (from flowchart)
    // If any selected practice has has_exception: false, then NO exception is available for the system as a whole (conservative approach)
    const practicesWithNoException = selectedPractices.filter(practice => {
        const info = practicesInfo[practice] || prohibitedPracticesMap[practice];
        return info && !info.has_exception;
    });
    
    if (practicesWithNoException.length > 0) {
        // All practices hasException: false â†’ No Exception Available â†’ Status: Prohibited (from flowchart)
        return `
            ${confirmedBanner}
            <div class="bg-[#FFEBEE] border border-[#EF5350] rounded-lg p-4">
                <p class="font-bold text-sm text-[#C62828] mb-2">No exception available</p>
                <p class="font-normal text-sm text-[#464E58] mb-4">
                    This prohibited practice does not allow exceptions under the EU AI Act.
                </p>
                <div class="flex justify-end">
                    <button onclick="acknowledgeNoException()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        `;
    }
    
    // 2. Exception Available â†’ Exception Claim UI
    const practicesWithException = selectedPractices.filter(practice => {
        const info = practicesInfo[practice] || prohibitedPracticesMap[practice];
        return info && info.has_exception;
    });
    
    if (practicesWithException.length > 0) {
        // Show exception condition and ask qualification question
        // Combine conditions if multiple
        const conditionsItems = practicesWithException.map((p, index) => {
             const info = practicesInfo[p] || prohibitedPracticesMap[p];
             // Ensure we display the condition text correctly
             const conditionText = info.exception_condition || info.exceptionCondition || 'Exception available';
             return `<div class="mb-2">
                <input type="text" id="exception-condition-${index}" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg text-[#464E58] bg-white text-sm" value="${conditionText}">
             </div>`;
        }).join('');
        
        const currentQualifies = block1State.exceptionQualifies; // 'Yes', 'No', 'Not sure', ''
        
        const practiceLabels = practicesWithException.map(p => {
            // Find the full version (key) if p is just a label
            let fullText = p;
            for (const key in prohibitedPracticesMap) {
                if (prohibitedPracticesMap[key].label === p) {
                    fullText = key;
                    break;
                }
            }
            return `â€œ${fullText}â€`;
        }).join(' and ');

        return `
            ${confirmedBanner}
            <div class="bg-[#FFF5F5] border border-[#F13D30] rounded-lg p-4">
                <p class="font-bold text-sm text-[#22262A] mb-3">Exception Claim</p>
                <p class="font-normal text-sm text-[#464E58] mb-3">Does your system ${practiceLabels} fall under the following condition?</p>
                
                <div class="mb-4">
                    ${conditionsItems}
                </div>

                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="exception_claim_radio" value="Yes" class="w-4 h-4 text-[#F13D30] border-gray-300 focus:ring-[#F13D30]" 
                            ${currentQualifies === 'Yes' ? 'checked' : ''} onchange="handleExceptionClaimChange(this.value)">
                        <span class="text-sm text-[#464E58]">Yes</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="exception_claim_radio" value="No" class="w-4 h-4 text-[#F13D30] border-gray-300 focus:ring-[#F13D30]" 
                            ${currentQualifies === 'No' ? 'checked' : ''} onchange="handleExceptionClaimChange(this.value)">
                        <span class="text-sm text-[#464E58]">No</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="exception_claim_radio" value="Not sure" class="w-4 h-4 text-[#F13D30] border-gray-300 focus:ring-[#F13D30]" 
                            ${currentQualifies === 'Not sure' ? 'checked' : ''} onchange="handleExceptionClaimChange(this.value)">
                        <span class="text-sm text-[#464E58]">Not sure</span>
                    </label>
                </div>
            </div>
        `;
    }
    
    return '<p class="text-sm text-[#464E58]">Processing exception flow...</p>';
}

// Render evidence upload form for Exception Claim "Yes" case
function renderBlock1ExceptionEvidenceForm(selectedPractices, practicesInfo = {}) {
    const confirmedBanner = `
        <div class="w-full bg-[#E8F5E9] border border-[#81C784] rounded-lg p-3 mb-4">
            <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Confirmed</p>
        </div>
    `;
    
    return `
        ${confirmedBanner}
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-[#22262A] mb-2">
                    Evidence / Documentation <span class="text-[#F13D30]">*</span>
                </label>
                <p class="text-sm text-[#464E58] mb-3">Paste a link or upload new document below.</p>
                
                <div class="flex gap-3 mb-3">
                    <input type="text" id="block1-evidence-link" placeholder="Paste link here" 
                        class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm text-[#464E58] focus:outline-none focus:ring-2 focus:ring-[#F13D30]">
                    <button onclick="saveBlock1EvidenceLink()" 
                        class="px-6 py-2 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Save link
                    </button>
                </div>
                
                <div id="block1-file-list" class="space-y-2 mb-3">
                    ${block1State.exceptionEvidenceFiles.map((file, idx) => `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="text-sm text-gray-600 truncate">${file.name}</span>
                            </div>
                            <button onclick="removeBlock1EvidenceFile(${idx})" class="text-gray-400 hover:text-red-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <input type="file" id="block1-evidence-file-input" class="hidden" onchange="handleBlock1FileUpload(this)">
                <button onclick="document.getElementById('block1-evidence-file-input').click()" 
                    class="w-full px-4 py-3 border-2 border-dashed border-[#D1D5DB] rounded-lg text-sm text-[#464E58] hover:border-[#F13D30] hover:bg-[#FFF5F5] transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Upload Supporting Documents
                </button>
            </div>
            
            <div>
                <textarea id="block1-evidence-explanation" rows="4" placeholder="Explain how the evidence supports your exception claim." 
                    class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm text-[#464E58] focus:outline-none focus:ring-2 focus:ring-[#F13D30] resize-none"></textarea>
            </div>
            
            <div class="flex justify-end">
                <button onclick="confirmBlock1ExceptionClaim()" 
                    class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                    Confirm Exception Claim
                </button>
            </div>
        </div>
    `;
}

// Helper functions for Block 1 exception flow
function acknowledgeNoException() {
    setClaimingException('No');
}

async function handleExceptionClaimChange(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        // Collect exception condition text from input field(s)
        const conditionInputs = document.querySelectorAll('[id^="exception-condition-"]');
        const exceptionConditions = Array.from(conditionInputs).map(input => input.value).filter(v => v);
        
        // Update both claiming_exception, exception_qualifies, and the customized condition text
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                claiming_exception: 'Yes',
                exception_qualifies: value,
                exception_conditions: exceptionConditions // Save the customized condition text
            })
        });
        const result = await response.json();
        
        if (result.success) {
            block1State.claimingException = 'Yes';
            block1State.exceptionQualifies = value;
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        }
    } catch(e) { console.error(e); }
}

// Evidence handling functions for Block 1
async function saveBlock1EvidenceLink() {
    const linkInput = document.getElementById('block1-evidence-link');
    if (!linkInput || !linkInput.value.trim()) {
        alert('Please enter a link');
        return;
    }
    
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                exception_evidence_saved_link: linkInput.value.trim()
            })
        });
        const result = await response.json();
        
        if (result.success) {
            alert('Link saved successfully!');
            block1State.exceptionEvidenceSavedLink = linkInput.value.trim();
        }
    } catch(e) { 
        console.error(e);
        alert('Error saving link');
    }
}

async function handleBlock1FileUpload(input) {
    const files = Array.from(input.files);
    if (!files.length) return;
    
    const formData = new FormData();
    files.forEach(file => formData.append('file', file));
    formData.append('folder', 'governance/uploads/block1');
    
    try {
        const response = await fetch('/api/upload-file/', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success && result.files) {
            // Append new files to state
            block1State.exceptionEvidenceFiles = [...block1State.exceptionEvidenceFiles, ...result.files];
            block1State.exceptionEvidenceUploaded = true;
            
            // Re-render the form to show the files
            const statusEl = document.getElementById('block-1-status');
            const status = statusEl ? statusEl.textContent.trim() : '';
            const contentEl = document.getElementById('block-1-content-inner');
            if (contentEl) {
                contentEl.innerHTML = renderBlock1Content(status);
            }
        } else {
            alert('Upload failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('File upload error:', e);
        alert('Error uploading file');
    }
}

function removeBlock1EvidenceFile(index) {
    block1State.exceptionEvidenceFiles.splice(index, 1);
    if (block1State.exceptionEvidenceFiles.length === 0) {
        block1State.exceptionEvidenceUploaded = false;
    }
    
    // Re-render the form
    const statusEl = document.getElementById('block-1-status');
    const status = statusEl ? statusEl.textContent.trim() : '';
    const contentEl = document.getElementById('block-1-content-inner');
    if (contentEl) {
        contentEl.innerHTML = renderBlock1Content(status);
    }
}

async function confirmBlock1ExceptionClaim() {
    const linkInput = document.getElementById('block1-evidence-link');
    const explanation = document.getElementById('block1-evidence-explanation');
    
    const hasLink = linkInput && linkInput.value.trim();
    const hasExplanation = explanation && explanation.value.trim();
    const hasFile = block1State.exceptionEvidenceFiles.length > 0;
    
    if (!hasLink && !hasExplanation && !hasFile) {
        alert('Please provide evidence (link, document, or explanation) to support your exception claim');
        return;
    }
    
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                exception_evidence_uploaded: hasFile,
                exception_evidence_saved_link: hasLink ? linkInput.value.trim() : '',
                exception_explanation: hasExplanation ? explanation.value.trim() : '',
                exception_evidence_files: block1State.exceptionEvidenceFiles // Send full file data
            })
        });
        const result = await response.json();
        
        if (result.success) {
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        }
    } catch(e) { 
        console.error(e);
        alert('Error confirming exception claim');
    }
}

// Helper functions for Block 1 exception flow - Update BE state
async function confirmProhibited(confirmed) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    if (!confirmed) {
        // Send to Profile Screen (from flowchart)
        switchTab('profile');
        return;
    }
    
    try {
        console.log('[DEBUG] confirmProhibited: Sending request to backend...');
        // Update BE state
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                prohibited_confirmed: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block1State.prohibitedConfirmed = true;
            // Update UI with new assessment results from BE
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        } else {
            alert('Error confirming assessment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming prohibited:', error);
        alert('Error confirming assessment. Please try again.');
    }
}

async function acknowledgeNoException() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                no_exception_confirmed: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block1State.noExceptionConfirmed = true;
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        }
    } catch (error) {
        console.error('Error acknowledging no exception:', error);
    }
}

async function setClaimingException(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                claiming_exception: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block1State.claimingException = value;
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        }
    } catch (error) {
        console.error('Error setting claiming exception:', error);
    }
}

async function setExceptionQualifies(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exception_qualifies: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block1State.exceptionQualifies = value;
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        }
    } catch (error) {
        console.error('Error setting exception qualifies:', error);
    }
}

async function confirmExceptionEvidence() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    const fileInput = document.getElementById('exception-evidence-upload');
    const linkInput = document.getElementById('exception-evidence-link');
    
    let evidenceUploaded = false;
    let evidenceLink = '';
    
    // Check file upload
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        // Upload file first
        try {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('folder', 'governance/uploads');
            
            const uploadResponse = await fetch('/api/upload-file/', {
                method: 'POST',
                body: formData,
            });
            
            const uploadResult = await uploadResponse.json();
            if (uploadResult.success) {
                evidenceUploaded = true;
            }
        } catch (error) {
            console.error('Error uploading evidence file:', error);
        }
    }
    
    // Check link
    if (linkInput && linkInput.value && linkInput.value.trim()) {
        evidenceLink = linkInput.value.trim();
    }
    
    if (!evidenceUploaded && !evidenceLink) {
        alert('Please upload a document or provide a link.');
        return;
    }
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block1-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exception_evidence_uploaded: evidenceUploaded,
                exception_evidence_saved_link: evidenceLink
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block1State.exceptionEvidenceUploaded = evidenceUploaded;
            block1State.exceptionEvidenceSavedLink = evidenceLink;
            if (result.assessment && result.assessment.block1) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(1);
            }
        } else {
            alert('Error saving evidence: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming exception evidence:', error);
        alert('Error saving evidence. Please try again.');
    }
}

// Helper functions for Block 2 (based on React code)
function isCondition1Met() {
    const safetyComponent = document.querySelector('input[name="safety_component"]:checked')?.value || '';
    const thirdPartyConformity = document.querySelector('input[name="third_party_conformity"]:checked')?.value || '';
    return safetyComponent === 'Yes' && thirdPartyConformity === 'Yes';
}

function isCondition2Met() {
    const sectorDomains = Array.from(document.querySelectorAll('input[name="sector_domain"]:checked')).map(cb => cb.value);
    return sectorDomains.some(sector => sector !== 'Other / not listed' && sector !== 'Other / not listed:');
}

function getHighRiskTrigger() {
    const cond1 = isCondition1Met();
    const cond2 = isCondition2Met();
    
    if (cond1 && cond2) return 'both';
    if (cond1) return 'condition1';
    if (cond2) return 'condition2';
    return 'none';
}

function renderBlock2Content(status, block2Details = null) {
    if (status === 'Not assessed') {
        const reason = block2Details?.reason || 'Please complete Section 4 (Intended Purpose) in Profile to assess high-risk classification.';
        return `<p class="font-normal text-sm text-[#464E58]">${reason}</p>`;
    }
    
    if (status === 'De-activated') {
        return `
            <div class="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#B5BCC4]">This block is de-activated</p>
                <p class="font-normal text-sm text-[#B5BCC4] mt-2">
                    ${block2Details?.reason || 'No high-risk conditions met.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Not high-risk') {
        return `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Not High-Risk</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block2Details?.reason || 'This AI system is not classified as high-risk under the EU AI Act.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Needs review') {
        return `
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#F57C00]">âš ï¸ Needs Review</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block2Details?.reason || 'This assessment requires manual review by the compliance team.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'High-risk') {
        // Check if this is Condition 1 only (no Annex III needed) or after Annex III
        const step = block2Details?.step;
        if (!step || step === 'condition1_only') {
            return `
                <div class="bg-[#FFEBEE] border border-[#EF5350] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#C62828]">ðŸš¨ High-Risk Classification</p>
                    <p class="font-normal text-sm text-[#464E58] mt-2">
                        ${block2Details?.reason || 'This AI system is classified as high-risk under the EU AI Act.'}
                    </p>
                </div>
            `;
        }
        // High-risk after Annex III (Q3 Profiling = Yes, or no evidence)
        return `
            <div class="bg-[#FFEBEE] border border-[#EF5350] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#C62828]">ðŸš¨ High-Risk Classification</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block2Details?.reason || 'This AI system is classified as high-risk under the EU AI Act.'}
                </p>
            </div>
        `;
    }
    
    // Status = 'Triggered' - Show confirmation or Annex III flow
    if (status === 'Triggered') {
        const trigger = block2Details?.trigger || getHighRiskTrigger();
        const step = block2Details?.step;
        
        // If not confirmed yet, show confirmation card
        if (!block2State.highRiskConfirmed) {
            const condition1Text = (block2Details?.condition1 || isCondition1Met()) ? 
                '<li class="font-medium text-sm text-[#464E58] ml-2">It is a safety component requiring third-party conformity assessment (Section 4, Q3)</li>' : '';
            
            let condition2Text = '';
            if (block2Details?.condition2 || isCondition2Met()) {
                const sectorDomains = Array.from(document.querySelectorAll('input[name="sector_domain"]:checked'))
                    .map(cb => cb.value)
                    .filter(s => s !== 'Other / not listed' && s !== 'Other / not listed:');
                const sectorsList = sectorDomains.length > 0 ? sectorDomains.join(', ') : 'Selected sectors';
                condition2Text = `<li class="font-medium text-sm text-[#464E58] ml-2">It is used in high-risk sectors: ${sectorsList} (Section 4, Q2)</li>`;
            }
            
            // Special case: Block 1 Prohibited trigger
            if (trigger === 'block1_prohibited' || block2Details?.trigger === 'block1_prohibited') {
                return `
                    <div class="space-y-4">
                        <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                            <p class="font-semibold text-sm text-[#22262A] mb-2">âš ï¸ High-Risk Classification Triggered</p>
                            <p class="font-normal text-sm text-[#464E58] mb-2">
                                ${block2Details?.reason || 'Block 1 Prohibited â€“ high-risk trigger. Please confirm or edit profile.'}
                            </p>
                            <p class="font-semibold text-sm text-[#22262A] mt-4">Do you confirm?</p>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button onclick="switchTab('profile')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                                Edit Profile Info
                            </button>
                            <button onclick="confirmHighRisk()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                                Confirm
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-4">
                    <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                        <p class="font-semibold text-sm text-[#22262A] mb-2">Confirm Profile input:</p>
                        <p class="font-normal text-sm text-[#464E58] mb-2">
                            Based on your Profile inputs, this AI system may be classified as high-risk because:
                        </p>
                        <ul class="list-disc list-inside space-y-1 mb-4">
                            ${condition1Text}
                            ${condition2Text}
                        </ul>
                        <p class="font-semibold text-sm text-[#22262A]">Do you confirm?</p>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="switchTab('profile')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                            Edit Profile Info
                        </button>
                        <button onclick="confirmHighRisk()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
        }
        
        // After confirmation - show Annex III flow (only if Condition 2 or Both)
        if (trigger === 'condition2' || trigger === 'both') {
            return renderBlock2AnnexIII(step, block2Details);
        }
    }
    
    return '<p class="text-sm text-[#464E58]">Status: ' + status + '</p>';
}

// Render Annex III Exemption Test flow
function renderBlock2AnnexIII(step, block2Details) {
    const condition1 = block2Details?.condition1 || false;
    const condition2 = block2Details?.condition2 || false;
    
    // Q1: Material Influence
    if (!step || step === 'q1') {
        return `
            <div class="space-y-4">
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#22262A] mb-2">Annex III Exemption Test</p>
                    <p class="font-normal text-sm text-[#464E58] mb-4">
                        Q1: Does the AI system have material influence on the outcome of the decision or action?
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="setMaterialInfluence('Not sure')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                        Not sure
                    </button>
                    <button onclick="setMaterialInfluence('No')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                        No
                    </button>
                    <button onclick="setMaterialInfluence('Yes')" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Yes
                    </button>
                </div>
            </div>
        `;
    }
    
    // Q2: Task Type Selection
    if (step === 'q2') {
        const narrowTaskOptions = [
            'Narrow procedural task',
            'Improves a previously completed human activity',
            'Detects patterns / deviations from past decisions (without influencing decisions)',
            'Preparatory task to an assessment relevant for the purposes of the use cases listed in Annex III (e.g., indexing, sorting, summarising)',
            'None of above'
        ];
        
        const tasksList = narrowTaskOptions.map(task => {
            const checked = block2State.narrowTasks.includes(task) ? 'checked' : '';
            return `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="narrow_tasks" value="${task}" ${checked} 
                           onchange="updateNarrowTasks()" 
                           class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] rounded focus:ring-[#F13D30]">
                    <span class="font-normal text-sm text-[#464E58]">${task}</span>
                </label>
            `;
        }).join('');
        
        return `
            <div class="space-y-4">
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#22262A] mb-2">Annex III Exemption Test</p>
                    <p class="font-normal text-sm text-[#464E58] mb-4">
                        Q2: What narrow procedural tasks does the AI system perform?
                    </p>
                    <div class="space-y-2">
                        ${tasksList}
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="confirmNarrowTasks()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Continue
                    </button>
                </div>
            </div>
        `;
    }
    
    // Q3: Profiling
    if (step === 'q3') {
        return `
            <div class="space-y-4">
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#22262A] mb-2">Annex III Exemption Test</p>
                    <p class="font-normal text-sm text-[#464E58] mb-4">
                        Q3: Does the AI system involve profiling of natural persons?
                    </p>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="setProfiling('Unknown')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                        Unknown
                    </button>
                    <button onclick="setProfiling('No')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                        No
                    </button>
                    <button onclick="setProfiling('Yes')" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Yes
                    </button>
                </div>
            </div>
        `;
    }
    
    // Evidence (when Q3 = No)
    if (step === 'evidence') {
        return `
            <div class="space-y-4">
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#22262A] mb-2">Evidence Required</p>
                    <p class="font-normal text-sm text-[#464E58] mb-2">
                        To claim exemption (Not high-risk), please provide evidence (upload document or paste link).
                    </p>
                    <div class="mt-4 space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-2">Upload Evidence Document</label>
                            <input type="file" id="exemption-evidence-upload" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-2">Or Paste Link</label>
                            <input type="text" id="exemption-evidence-link" placeholder="Paste link here" 
                                   value="${block2State.exemptionEvidenceSavedLink || ''}"
                                   class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="confirmExemptionEvidence()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Confirm Evidence
                    </button>
                </div>
            </div>
        `;
    }
    
    return '<p class="text-sm text-[#464E58]">Annex III flow</p>';
}

// Block 2 API functions
async function confirmHighRisk() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block2-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                high_risk_confirmed: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block2State.highRiskConfirmed = true;
            if (result.assessment && result.assessment.block2) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(2);
            }
        } else {
            alert('Error confirming assessment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming high-risk:', error);
        alert('Error confirming assessment. Please try again.');
    }
}

async function setMaterialInfluence(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block2-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                material_influence: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block2State.materialInfluence = value;
            if (result.assessment && result.assessment.block2) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(2);
            }
        }
    } catch (error) {
        console.error('Error setting material influence:', error);
    }
}

function updateNarrowTasks() {
    const checkboxes = Array.from(document.querySelectorAll('input[name="narrow_tasks"]:checked'));
    block2State.narrowTasks = checkboxes.map(cb => cb.value);
}

async function confirmNarrowTasks() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block2-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                narrow_tasks: block2State.narrowTasks
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.assessment && result.assessment.block2) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(2);
            }
        }
    } catch (error) {
        console.error('Error confirming narrow tasks:', error);
    }
}

async function setProfiling(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block2-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                profiling: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block2State.profiling = value;
            if (result.assessment && result.assessment.block2) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(2);
            }
        }
    } catch (error) {
        console.error('Error setting profiling:', error);
    }
}

async function confirmExemptionEvidence() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    const fileInput = document.getElementById('exemption-evidence-upload');
    const linkInput = document.getElementById('exemption-evidence-link');
    
    let evidenceUploaded = false;
    let evidenceLink = '';
    
    // Check file upload
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        try {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('folder', 'governance/uploads');
            
            const uploadResponse = await fetch('/api/upload-file/', {
                method: 'POST',
                body: formData,
            });
            
            const uploadResult = await uploadResponse.json();
            if (uploadResult.success) {
                evidenceUploaded = true;
            }
        } catch (error) {
            console.error('Error uploading evidence file:', error);
        }
    }
    
    // Check link
    if (linkInput && linkInput.value && linkInput.value.trim()) {
        evidenceLink = linkInput.value.trim();
    }
    
    if (!evidenceUploaded && !evidenceLink) {
        alert('Please upload a document or provide a link.');
        return;
    }
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block2-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exemption_evidence_uploaded: evidenceUploaded,
                exemption_evidence_saved_link: evidenceLink
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block2State.exemptionEvidenceUploaded = evidenceUploaded;
            block2State.exemptionEvidenceSavedLink = evidenceLink;
            if (result.assessment && result.assessment.block2) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(2);
            }
        } else {
            alert('Error saving evidence: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming exemption evidence:', error);
        alert('Error saving evidence. Please try again.');
    }
}

function renderBlock3Content(status, block3Details = null) {
    if (status === 'Not assessed') {
        const reason = block3Details?.reason || 'Please complete Section 7 (Capabilities) in Profile to assess transparency obligations.';
        return `<p class="font-normal text-sm text-[#464E58]">${reason}</p>`;
    }
    
    if (status === 'De-activated') {
        return `
            <div class="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#B5BCC4]">This block is de-activated</p>
                <p class="font-normal text-sm text-[#B5BCC4] mt-2">
                    ${block3Details?.reason || 'Block 1 Prohibited - transparency obligation assessment not applicable.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Not Applicable') {
        return `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Not Applicable</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block3Details?.reason || 'Transparency obligations do not apply (valid exceptions claimed with evidence).'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Needs Review') {
        return `
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#F57C00]">âš ï¸ Needs Review</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block3Details?.reason || 'This assessment requires manual review by the compliance team.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Applies') {
        return `
            <div class="bg-[#FFEBEE] border border-[#EF5350] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#C62828]">ðŸ“‹ Transparency Obligations Apply</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block3Details?.reason || 'This AI system must comply with transparency obligations under EU AI Act Article 50.'}
                </p>
            </div>
        `;
    }
    
    // Status = 'Triggered' - Show confirmation or exception flow
    if (status === 'Triggered') {
        const triggers = block3Details?.triggers || [];
        
        // If not confirmed yet, show confirmation card
        if (!block3State.transparencyConfirmed) {
            const triggerReasons = getTransparencyTriggerReasons(triggers);
            const reasonsList = triggerReasons.map(reason => 
                `<li class="font-medium text-sm text-[#464E58] ml-2">${reason}</li>`
            ).join('');
            
            return `
                <div class="space-y-4">
                    <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                        <p class="font-semibold text-sm text-[#22262A] mb-2">Confirm Profile input:</p>
                        <p class="font-normal text-sm text-[#464E58] mb-2">
                            Based on your Profile inputs, transparency obligations may apply because:
                        </p>
                        <ul class="list-disc list-inside space-y-1 mb-4">
                            ${reasonsList}
                        </ul>
                        <p class="font-semibold text-sm text-[#22262A]">Do you confirm?</p>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="switchTab('profile')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                            Edit Profile Info
                        </button>
                        <button onclick="confirmTransparency()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
        }
        
        // After confirmation - show exception selection flow
        return renderBlock3ExceptionFlow(triggers, block3Details);
    }
    
    return '<p class="text-sm text-[#464E58]">Status: ' + status + '</p>';
}

// Get transparency trigger reasons for display
function getTransparencyTriggerReasons(triggers) {
    const reasons = [];
    const capabilityPractices = Array.from(document.querySelectorAll('input[name="capability_practices"]:checked')).map(cb => cb.value);
    const interactsPersons = document.querySelector('input[name="interacts_persons"]:checked')?.value || '';
    const syntheticContent = Array.from(document.querySelectorAll('input[name="synthetic_content"]:checked')).map(cb => cb.value);
    const deploymentContext = document.querySelector('input[name="deployment_context"]:checked')?.value || '';
    const affectedOutputs = Array.from(document.querySelectorAll('input[name="affected_outputs"]:checked')).map(cb => cb.value);
    
    if (triggers.includes('case1')) {
        reasons.push('Uses biometric identification and categorisation (Section 4, Q2)');
    }
    if (triggers.includes('case2')) {
        reasons.push('Emotion recognition in the workplace or in education settings (Section 7, Q1)');
    }
    if (triggers.includes('case3')) {
        reasons.push('Biometric categorisation that infers or predicts sensitive traits (Section 7, Q1)');
    }
    if (triggers.includes('case4')) {
        reasons.push('Interacts directly with natural persons (Section 7, Q2)');
    }
    if (triggers.includes('case5')) {
        reasons.push('Generates or manipulates synthetic content (Section 7, Q3)');
    }
    if (triggers.includes('case6')) {
        if (affectedOutputs.includes('Citizens / residents') && deploymentContext === 'General public / consumer-facing') {
            reasons.push('Affects citizens / residents and is general public / consumer-facing (Section 5, Q1 & Q3)');
        } else if (affectedOutputs.includes('Citizens / residents')) {
            reasons.push('Affects citizens / residents (Section 5, Q3)');
        } else {
            reasons.push('General public / consumer-facing deployment (Section 5, Q1)');
        }
    }
    
    return reasons;
}

// Render exception selection flow (flowchart: Exception Selection for Each Group)
function renderBlock3ExceptionFlow(triggers, block3Details) {
    const caseGroups = block3Details?.case_groups || [];
    
    // Map triggers to groups
    const groups = [];
    if (triggers.includes('case1') || triggers.includes('case2') || triggers.includes('case3')) {
        groups.push({
            key: 'group1_2_3',
            label: 'For Biometric identification, Emotion recognition, Biometric categorisation:',
            options: [
                'Permitted by law to detect, prevent or investigate criminal offences, as stated in Art. 50(3)',
                'None of the above (no exception for biometric/emotion recognition cases)'
            ]
        });
    }
    if (triggers.includes('case4')) {
        groups.push({
            key: 'group4',
            label: 'For Direct interaction with persons:',
            options: [
                '"Obvious to the user" exception (no notice needed), as stated in Art. 50(1)',
                'Authorised by law to detect, prevent, investigate or prosecute criminal offences, as stated in Art. 50(1)',
                'None of the above (no exception for direct interaction case)'
            ]
        });
    }
    if (triggers.includes('case5')) {
        groups.push({
            key: 'group5',
            label: 'For Synthetic content generation / manipulation:',
            options: [
                'Deepfake labelling exception (e.g., artistic / satire / fiction), as stated in Art. 50(4)',
                'None of the above (no exception for synthetic content case)'
            ]
        });
    }
    if (triggers.includes('case6')) {
        groups.push({
            key: 'group6',
            label: 'For Citizens / residents or General public facing:',
            options: [
                'Authorised by law to detect, prevent, investigate or prosecute criminal offences, as stated in Art. 50(4)',
                'Human review is in place or a natural or legal person holds editorial responsibility for the publication of the content, as stated in Art. 50(4)',
                'None of the above (no exception for citizens/public-facing case)'
            ]
        });
    }
    
    // Check if all groups have exceptions selected
    const allGroupsHaveException = groups.every(group => {
        return block3State.exceptionOptions.some(opt => group.options.includes(opt));
    });
    
    // Check if evidence is needed (all groups have valid exceptions, not "None of above")
    const hasValidExceptionsForAll = groups.every(group => {
        return block3State.exceptionOptions.some(opt => 
            group.options.includes(opt) && !opt.includes('None of the above')
        );
    });
    
    const evidenceProvided = block3State.transparencyEvidenceUploaded || 
                            (block3State.transparencyEvidenceSavedLink && block3State.transparencyEvidenceSavedLink.trim());
    
    // If all groups have valid exceptions and evidence provided, show success
    if (hasValidExceptionsForAll && evidenceProvided) {
        return `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Not Applicable</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    Valid exceptions for all groups with evidence provided - transparency obligations do not apply.
                </p>
            </div>
        `;
    }
    
    // If all groups have valid exceptions but no evidence, show evidence section
    if (hasValidExceptionsForAll && !evidenceProvided) {
        return `
            <div class="space-y-4">
                <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                    <p class="font-semibold text-sm text-[#22262A] mb-2">Evidence Required</p>
                    <p class="font-normal text-sm text-[#464E58] mb-2">
                        To claim exceptions, please provide evidence (upload document or paste link).
                    </p>
                    <div class="mt-4 space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-2">Upload Evidence Document</label>
                            <input type="file" id="transparency-evidence-upload" class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#374151] mb-2">Or Paste Link</label>
                            <input type="text" id="transparency-evidence-link" placeholder="Paste link here" 
                                   value="${block3State.transparencyEvidenceSavedLink || ''}"
                                   class="w-full px-3 py-2 border border-[#D1D5DB] rounded-lg">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="confirmTransparencyEvidence()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                        Confirm Evidence
                    </button>
                </div>
            </div>
        `;
    }
    
    // Show exception selection for each group
    const groupsHTML = groups.map(group => {
        const optionsHTML = group.options.map(option => {
            const checked = block3State.exceptionOptions.includes(option) ? 'checked' : '';
            return `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="exception_${group.key}" value="${option}" ${checked} 
                           onchange="updateExceptionOption('${group.key}', '${option}')" 
                           class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                    <span class="font-normal text-sm text-[#464E58]">${option}</span>
                </label>
            `;
        }).join('');
        
        return `
            <div class="border-b border-[#E5E7EB] pb-4 mb-4">
                <p class="font-semibold text-sm text-[#22262A] mb-3">${group.label}</p>
                <div class="space-y-2">
                    ${optionsHTML}
                </div>
            </div>
        `;
    }).join('');
    
    return `
        <div class="space-y-4">
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#22262A] mb-2">Exception Selection for Each Group</p>
                <p class="font-normal text-sm text-[#464E58] mb-4">
                    Select exception options for each triggered case group:
                </p>
                <div class="space-y-4">
                    ${groupsHTML}
                </div>
            </div>
            <div class="flex justify-end">
                <button onclick="confirmExceptionOptions()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                    Confirm Selections
                </button>
            </div>
        </div>
    `;
}

// Block 3 API functions
async function confirmTransparency() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block3-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transparency_confirmed: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block3State.transparencyConfirmed = true;
            if (result.assessment && result.assessment.block3) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(3);
            }
        } else {
            alert('Error confirming assessment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming transparency:', error);
        alert('Error confirming assessment. Please try again.');
    }
}

function updateExceptionOption(groupKey, option) {
    // Remove any existing option for this group
    const groupOptions = getGroupOptions(groupKey);
    block3State.exceptionOptions = block3State.exceptionOptions.filter(opt => !groupOptions.includes(opt));
    
    // Add new option
    if (!block3State.exceptionOptions.includes(option)) {
        block3State.exceptionOptions.push(option);
    }
    
    // Auto-save to BE when option changes
    confirmExceptionOptions();
}

function getGroupOptions(groupKey) {
    const allOptions = {
        'group1_2_3': [
            'Permitted by law to detect, prevent or investigate criminal offences, as stated in Art. 50(3)',
            'None of the above (no exception for biometric/emotion recognition cases)'
        ],
        'group4': [
            '"Obvious to the user" exception (no notice needed), as stated in Art. 50(1)',
            'Authorised by law to detect, prevent, investigate or prosecute criminal offences, as stated in Art. 50(1)',
            'None of the above (no exception for direct interaction case)'
        ],
        'group5': [
            'Deepfake labelling exception (e.g., artistic / satire / fiction), as stated in Art. 50(4)',
            'None of the above (no exception for synthetic content case)'
        ],
        'group6': [
            'Authorised by law to detect, prevent, investigate or prosecute criminal offences, as stated in Art. 50(4)',
            'Human review is in place or a natural or legal person holds editorial responsibility for the publication of the content, as stated in Art. 50(4)',
            'None of the above (no exception for citizens/public-facing case)'
        ]
    };
    return allOptions[groupKey] || [];
}

async function confirmExceptionOptions() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block3-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                exception_options: block3State.exceptionOptions
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.assessment && result.assessment.block3) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(3);
            }
        }
    } catch (error) {
        console.error('Error confirming exception options:', error);
    }
}

async function confirmTransparencyEvidence() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    const fileInput = document.getElementById('transparency-evidence-upload');
    const linkInput = document.getElementById('transparency-evidence-link');
    
    let evidenceUploaded = false;
    let evidenceLink = '';
    
    // Check file upload
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        try {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('folder', 'governance/uploads');
            
            const uploadResponse = await fetch('/api/upload-file/', {
                method: 'POST',
                body: formData,
            });
            
            const uploadResult = await uploadResponse.json();
            if (uploadResult.success) {
                evidenceUploaded = true;
            }
        } catch (error) {
            console.error('Error uploading evidence file:', error);
        }
    }
    
    // Check link
    if (linkInput && linkInput.value && linkInput.value.trim()) {
        evidenceLink = linkInput.value.trim();
    }
    
    if (!evidenceUploaded && !evidenceLink) {
        alert('Please upload a document or provide a link.');
        return;
    }
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block3-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                transparency_evidence_uploaded: evidenceUploaded,
                transparency_evidence_saved_link: evidenceLink
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block3State.transparencyEvidenceUploaded = evidenceUploaded;
            block3State.transparencyEvidenceSavedLink = evidenceLink;
            if (result.assessment && result.assessment.block3) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(3);
            }
        } else {
            alert('Error saving evidence: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming transparency evidence:', error);
        alert('Error saving evidence. Please try again.');
    }
}

function renderBlock4Content(status, block4Details = null) {
    if (status === 'Not assessed') {
        const reason = block4Details?.reason || 'Please complete Section 8 (Technical Profile) Q2 in Profile to assess GPAI applicability.';
        return `<p class="font-normal text-sm text-[#464E58]">${reason}</p>`;
    }
    
    if (status === 'De-activated') {
        return `
            <div class="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#B5BCC4]">This block is de-activated</p>
                <p class="font-normal text-sm text-[#B5BCC4] mt-2">
                    ${block4Details?.reason || 'Block 1 Prohibited - GPAI obligation assessment not applicable.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Not Applicable') {
        return `
            <div class="bg-[#E8F5E9] border border-[#81C784] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#2E7D32]">âœ“ Not Applicable</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block4Details?.reason || 'GPAI obligations do not apply. You are a GPAI user, not a provider. Chapter V does not apply.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Needs Review') {
        return `
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#F57C00]">âš ï¸ Needs Review</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block4Details?.reason || 'This assessment requires manual review by the compliance team.'}
                </p>
            </div>
        `;
    }
    
    if (status === 'Applies') {
        return `
            <div class="bg-[#FFEBEE] border border-[#EF5350] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#C62828]">ðŸ“‹ GPAI Obligations Apply</p>
                <p class="font-normal text-sm text-[#464E58] mt-2">
                    ${block4Details?.reason || 'GPAI provider - Chapter V obligations apply.'}
                </p>
            </div>
        `;
    }
    
    // Status = 'Triggered' - Show confirmation or provider question
    if (status === 'Triggered') {
        const gpaiIntegration = block4Details?.gpai_integration || 
                               document.querySelector('input[name="gpai_integration"]:checked')?.value || '';
        
        // If not confirmed yet, show confirmation card
        if (!block4State.gpaiConfirmed) {
            let reasonText = '';
            if (gpaiIntegration === 'Yes') {
                reasonText = 'This AI system integrates or uses a General Purpose AI (GPAI) model (Section 8, Q2).';
            } else if (gpaiIntegration === 'Unknown') {
                reasonText = 'GPAI integration status is Unknown - requires confirmation (Section 8, Q2).';
            }
            
            return `
                <div class="space-y-4">
                    <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                        <p class="font-semibold text-sm text-[#22262A] mb-2">Confirm Profile input:</p>
                        <p class="font-normal text-sm text-[#464E58] mb-2">
                            Based on your Profile inputs, GPAI obligations may apply because:
                        </p>
                        <ul class="list-disc list-inside space-y-1 mb-4">
                            <li class="font-medium text-sm text-[#464E58] ml-2">${reasonText}</li>
                        </ul>
                        <p class="font-semibold text-sm text-[#22262A]">Do you confirm?</p>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button onclick="switchTab('profile')" class="px-6 py-2.5 bg-white border border-[#B5BCC4] text-[#464E58] rounded-lg font-semibold text-sm hover:bg-[#F0F1F2] transition-colors">
                            Edit Profile Info
                        </button>
                        <button onclick="confirmGPAI()" class="px-6 py-2.5 bg-[#F13D30] text-white rounded-lg font-semibold text-sm hover:bg-[#DC180A] transition-colors">
                            Confirm
                        </button>
                    </div>
                </div>
            `;
        }
        
        // After confirmation - show provider question (flowchart: Are you the provider of AI model?)
        return renderBlock4ProviderQuestion(block4Details);
    }
    
    return '<p class="text-sm text-[#464E58]">Status: ' + status + '</p>';
}

// Render provider question (flowchart: Are you the provider of AI model?)
function renderBlock4ProviderQuestion(block4Details) {
    const gpaiIntegration = block4Details?.gpai_integration || 'Yes';
    
    return `
        <div class="space-y-4">
            <div class="bg-[#FFF9E6] border border-[#FFE59E] rounded-lg p-4">
                <p class="font-semibold text-sm text-[#22262A] mb-2">Provider Determination</p>
                <p class="font-normal text-sm text-[#464E58] mb-4">
                    Are you the provider of the AI model?
                </p>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="gpai_provider_answer" value="Yes" 
                               ${block4State.gpaiProviderAnswer === 'Yes' ? 'checked' : ''}
                               onchange="setGPAIProviderAnswer('Yes')" 
                               class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                        <span class="font-normal text-sm text-[#464E58]">Yes - We are a GPAI provider</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="gpai_provider_answer" value="No" 
                               ${block4State.gpaiProviderAnswer === 'No' ? 'checked' : ''}
                               onchange="setGPAIProviderAnswer('No')" 
                               class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                        <span class="font-normal text-sm text-[#464E58]">No - We only use/integrate GPAI from third parties</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="gpai_provider_answer" value="Not sure" 
                               ${block4State.gpaiProviderAnswer === 'Not sure' ? 'checked' : ''}
                               onchange="setGPAIProviderAnswer('Not sure')" 
                               class="w-4 h-4 text-[#F13D30] border-[#B5BCC4] focus:ring-[#F13D30]">
                        <span class="font-normal text-sm text-[#464E58]">Not sure - Requires legal review</span>
                    </label>
                </div>
            </div>
        </div>
    `;
}

// Block 4 API functions
async function confirmGPAI() {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block4-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                gpai_confirmed: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block4State.gpaiConfirmed = true;
            if (result.assessment && result.assessment.block4) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(4);
            }
        } else {
            alert('Error confirming assessment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error confirming GPAI:', error);
        alert('Error confirming assessment. Please try again.');
    }
}

async function setGPAIProviderAnswer(value) {
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    try {
        const response = await fetch(`/api/ai-inventory/${agentId}/block4-state/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                gpai_provider_answer: value
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            block4State.gpaiProviderAnswer = value;
            if (result.assessment && result.assessment.block4) {
                updateAssessmentBlocksFromBE(result.assessment);
            } else {
                updateAssessmentBlock(4);
            }
        }
    } catch (error) {
        console.error('Error setting GPAI provider answer:', error);
    }
}



// Update all assessment blocks when switching to Assessment tab
function updateAllAssessmentBlocks() {
    // Try to get assessment results from BE first
    const mainContainer = document.querySelector('[data-agent-id]');
    const agentId = mainContainer ? parseInt(mainContainer.getAttribute('data-agent-id')) : 0;
    
    if (agentId) {
        // Load assessment from BE
        fetch(`/api/ai-inventory/${agentId}/detail/`)
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data && result.data.assessment) {
                    console.log('Loading assessment from BE:', result.data.assessment);
                    updateAssessmentBlocksFromBE(result.data.assessment);
                } else {
                    // Fallback to client-side calculation if no BE data
                    [1, 2, 3, 4].forEach(blockNum => {
                        updateAssessmentBlock(blockNum);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading assessment from BE:', error);
                // Fallback to client-side calculation
                [1, 2, 3, 4].forEach(blockNum => {
                    updateAssessmentBlock(blockNum);
                });
            });
    } else {
        // Fallback to client-side calculation
        [1, 2, 3, 4].forEach(blockNum => {
            updateAssessmentBlock(blockNum);
        });
    }
}

// Update assessment blocks from BE results
function updateAssessmentBlocksFromBE(assessmentResults) {
    // Update Block 1
    if (assessmentResults.block1) {
        const block1Status = assessmentResults.block1.status;
        
        // Check if backend has preserved block1_state (from api_update_block1_state calls)
        // vs. fresh assessment (from profile save which clears state)
        const backendHasState = assessmentResults.block1_state && Object.keys(assessmentResults.block1_state).length > 0;
        
        if (!backendHasState) {
            // Fresh assessment from profile save - RESET all frontend state
            block1State.prohibitedConfirmed = false;
            block1State.claimingException = '';
            block1State.exceptionQualifies = '';
            block1State.exceptionEvidenceUploaded = false;
            block1State.exceptionEvidenceSavedLink = '';
            block1State.exceptionEvidenceFiles = [];
            block1State.noExceptionConfirmed = false;
        } else {
            // SYNC frontend state from backend state
            const beState = assessmentResults.block1_state;
            block1State.prohibitedConfirmed = beState.prohibited_confirmed || false;
            block1State.claimingException = beState.claiming_exception || '';
            block1State.exceptionQualifies = beState.exception_qualifies || '';
            block1State.exceptionEvidenceUploaded = beState.exception_evidence_uploaded || false;
            block1State.exceptionEvidenceSavedLink = beState.exception_evidence_saved_link || '';
            block1State.exceptionEvidenceFiles = beState.exception_evidence_files || [];
            block1State.noExceptionConfirmed = beState.no_exception_confirmed || false;
        }
        
        // Store BE assessment data for reference (needed for renderBlock1Content)
        block1State.be_assessment = assessmentResults.block1;
        
        const block1Content = renderBlock1Content(block1Status);
        updateBlockStatus(1, block1Status, block1Content);
    }
    
    // Update Block 2
    if (assessmentResults.block2) {
        const block2Status = assessmentResults.block2.status;
        const block2Details = assessmentResults.block2.details || {};
        
        // Store BE assessment data for reference
        block2State.be_assessment = assessmentResults.block2;
        
        const block2Content = renderBlock2Content(block2Status, block2Details);
        updateBlockStatus(2, block2Status, block2Content);
    }
    
    // Update Block 3
    if (assessmentResults.block3) {
        const block3Status = assessmentResults.block3.status;
        const block3Details = assessmentResults.block3.details || {};
        
        // Store BE assessment data for reference
        block3State.be_assessment = assessmentResults.block3;
        
        const block3Content = renderBlock3Content(block3Status, block3Details);
        updateBlockStatus(3, block3Status, block3Content);
    }
    
    // Update Block 4
    if (assessmentResults.block4) {
        const block4Status = assessmentResults.block4.status;
        const block4Details = assessmentResults.block4.details || {};
        
        // Store BE assessment data for reference
        block4State.be_assessment = assessmentResults.block4;
        
        const block4Content = renderBlock4Content(block4Status, block4Details);
        updateBlockStatus(4, block4Status, block4Content);
    }
}

// Helper function to update block status and content
function updateBlockStatus(blockNum, status, content) {
    const statusEl = document.getElementById(`block-${blockNum}-status`);
    const contentEl = document.getElementById(`block-${blockNum}-content-inner`);
    
    if (statusEl) {
        statusEl.textContent = status;
        statusEl.className = `px-4 py-1.5 rounded-full font-semibold text-sm ${getStatusColorClass(status)}`;
    }
    
    if (contentEl) {
        contentEl.innerHTML = content;
    }
}

// Wrapper functions for Result screen (based on React code)
function getBlock1ResultStatus() {
    const status = getProhibitedStatus();
    
    // Based on React code getBlock1Status():
    // - If status === 'Triggered' && prohibitedConfirmed && claimingException === 'No' â†’ 'Prohibited'
    // - If status === 'Needs Review' || (status === 'Triggered' && !prohibitedConfirmed) â†’ 'Needs Review'
    // - Otherwise â†’ 'Not Prohibited'
    
    // Note: Since we don't have confirmation states yet, we'll use simplified logic:
    // - If 'Triggered' (prohibited practices detected but not confirmed) â†’ 'Needs Review'
    // - If 'PASS' â†’ 'Not Prohibited'
    // - If 'Needs Review' â†’ 'Needs Review'
    // This will be enhanced when confirmation UI is added
    
    if (status === 'Triggered') {
        // If triggered but not confirmed, needs review (based on React code)
        return 'Needs Review';
    }
    
    if (status === 'Needs Review') {
        return 'Needs Review';
    }
    
    if (status === 'PASS') {
        return 'Not Prohibited';
    }
    
    // Default to 'Needs Review' for 'Not assessed' or other statuses
    return 'Needs Review';
}

function getBlock2ResultStatus() {
    const status = getHighRiskStatus();
    
    if (status === 'De-activated') return 'De-activated';
    if (status === 'High-risk') return 'High-Risk';
    if (status === 'Not high-risk') return 'Not High-Risk';
    return 'Needs Review';
}

function getBlock3ResultStatus() {
    const status = getTransparencyStatus();
    
    if (status === 'De-activated') return 'De-activated';
    if (status === 'Applies') return 'Applies';
    if (status === 'Not Applicable') return 'Not Applicable';
    if (status === 'Needs Review') return 'Needs Review';
    if (status === 'Pending') return 'Needs Review';
    return 'Not assessed';
}

function getBlock4ResultStatus() {
    const status = getGPAIStatus();
    
    if (status === 'De-activated') return 'De-activated';
    if (status === 'Applies') return 'Applies';
    if (status === 'Not Applicable') return 'Not Applicable';
    if (status === 'Needs Review') return 'Needs Review';
    if (status === 'Pending') return 'Needs Review';
    return 'Not assessed';
}

// Update all result blocks when switching to Result tab
function updateAllResultBlocks() {
    // Recheck all assessment blocks first to get latest status from Profile
    updateAllAssessmentBlocks();
    
    // Get result status using wrapper functions (which read from Profile and Assessment)
    const block1Result = getBlock1ResultStatus();
    const block2Result = getBlock2ResultStatus();
    const block3Result = getBlock3ResultStatus();
    const block4Result = getBlock4ResultStatus();
    
    // Map to result display format with descriptions
    const resultStatuses = [
        mapResultStatusToDisplay(block1Result, 1),
        mapResultStatusToDisplay(block2Result, 2),
        mapResultStatusToDisplay(block3Result, 3),
        mapResultStatusToDisplay(block4Result, 4)
    ];
    
    // Update each result block
    resultStatuses.forEach((result, index) => {
        updateResultBlock(index + 1, result.status, result.description, result.statusClass);
    });
}

// Map result status to display format with descriptions (based on React code)
function mapResultStatusToDisplay(resultStatus, blockNum) {
    let description = '';
    let statusClass = '';
    
    switch(blockNum) {
        case 1: // Prohibited Practices
            if (resultStatus === 'Prohibited') {
                description = 'This AI system is classified as prohibited under Article 5 of the EU AI Act. It cannot be deployed or used within the EU.';
                statusClass = 'bg-[#FEEDEC] text-[#DC180A]';
            } else if (resultStatus === 'Not Prohibited') {
                description = 'This AI system does not fall under prohibited practices. It may proceed to further compliance assessment.';
                statusClass = 'bg-[#E8F5E9] text-[#2E7D32]';
            } else {
                description = 'This AI system requires further review to determine if it constitutes a prohibited practice. Consult with your legal team.';
                statusClass = 'bg-[#FFF9E6] text-[#F57C00]';
            }
            break;
            
        case 2: // High-Risk Classification
            if (resultStatus === 'De-activated') {
                description = 'This assessment is de-activated because the AI system is prohibited.';
                statusClass = 'bg-[#F0F1F2] text-[#B5BCC4]';
            } else if (resultStatus === 'High-Risk') {
                description = 'This AI system is classified as high-risk under Annex III of the EU AI Act. It must comply with strict requirements including risk management, data governance, and conformity assessment.';
                statusClass = 'bg-[#FFF3E0] text-[#E65100]';
            } else if (resultStatus === 'Not High-Risk') {
                description = 'This AI system is not classified as high-risk. It may still be subject to other obligations such as transparency requirements.';
                statusClass = 'bg-[#E8F5E9] text-[#2E7D32]';
            } else {
                description = 'This AI system requires further review to determine its high-risk classification. Additional information or clarification is needed.';
                statusClass = 'bg-[#FFF9E6] text-[#F57C00]';
            }
            break;
            
        case 3: // Transparency Obligation
            if (resultStatus === 'De-activated') {
                description = 'This assessment is de-activated because the AI system is prohibited.';
                statusClass = 'bg-[#F0F1F2] text-[#B5BCC4]';
            } else if (resultStatus === 'Applies') {
                description = 'This AI system is subject to transparency obligations under Article 50 of the EU AI Act. Users must be informed that they are interacting with AI.';
                statusClass = 'bg-[#FFF3E0] text-[#E65100]';
            } else if (resultStatus === 'Not Applicable') {
                description = 'This AI system is not subject to transparency obligations under Article 50, either because it does not trigger the requirements or valid exceptions apply.';
                statusClass = 'bg-[#E8F5E9] text-[#2E7D32]';
            } else {
                description = 'The transparency obligation status requires further review. Additional clarification or documentation may be needed.';
                statusClass = 'bg-[#FFF9E6] text-[#F57C00]';
            }
            break;
            
        case 4: // GPAI Applicability
            if (resultStatus === 'De-activated') {
                description = 'This assessment is de-activated because the AI system is prohibited.';
                statusClass = 'bg-[#F0F1F2] text-[#B5BCC4]';
            } else if (resultStatus === 'Applies') {
                description = 'This AI system is subject to General-Purpose AI obligations under Chapter V of the EU AI Act as you are the provider of the AI model.';
                statusClass = 'bg-[#FFF3E0] text-[#E65100]';
            } else if (resultStatus === 'Not Applicable') {
                description = 'This AI system is not subject to GPAI obligations, either because it does not integrate a GPAI model or you are not the provider.';
                statusClass = 'bg-[#E8F5E9] text-[#2E7D32]';
            } else {
                description = 'Your provider status needs to be clarified to determine GPAI applicability. Consult with your legal team.';
                statusClass = 'bg-[#FFF9E6] text-[#F57C00]';
            }
            break;
    }
    
    return {
        status: resultStatus,
        description: description,
        statusClass: statusClass
    };
}

// Update a single result block
function updateResultBlock(blockNum, status, description, statusClass) {
    const blockElement = document.querySelector(`.result-block[data-block-id="${blockNum}"]`);
    if (!blockElement) return;
    
    const statusElement = blockElement.querySelector('.result-block-status');
    const descriptionElement = blockElement.querySelector('.result-block-description');
    
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = `result-block-status px-3 py-1 text-sm font-medium rounded-full ${statusClass}`;
    }
    
    if (descriptionElement) {
        descriptionElement.textContent = description;
    }
}


// Update assessment when Profile inputs change
// Load detail data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load AI System detail data from API
    loadAISystemDetailData();
    
    // Monitor Profile form changes
    const profileInputs = document.querySelectorAll('input[name="capability_practices"], input[name="sector_domain"], input[name="safety_component"], input[name="third_party_conformity"], input[name="interacts_persons"], input[name="synthetic_content"], input[name="affected_outputs"], input[name="deployment_context"], input[name="gpai_integration"]');
    profileInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (document.getElementById('content-assessment') && !document.getElementById('content-assessment').classList.contains('hidden')) {
                updateAllAssessmentBlocks();
            }
        });
    });
    
    // Handle "Same as compliance owner" checkbox
    document.getElementById('same-as-compliance-owner')?.addEventListener('change', function(e) {
        const ownerFields = document.querySelectorAll('input[name="owner_name"], input[name="owner_email"], input[name="owner_department"]');
        ownerFields.forEach(field => {
            field.disabled = e.target.checked;
            if (e.target.checked) {
                field.value = '';
            }
        });
    });
    
    // Handle "Part of broader product" radio
    document.querySelectorAll('input[name="part_of_product"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const productNameField = document.getElementById('product-service-name-field');
            if (this.value === 'yes') {
                productNameField?.classList.remove('hidden');
            } else {
                productNameField?.classList.add('hidden');
            }
        });
    });
    
    // Q1: Default Role Applies Logic
    initDefaultRoleLogic();
    
    // Q3: System Source Logic
    initSystemSourceLogic();
    
    // Q4: Modify/Customize Logic
    initModifyCustomizeLogic();
    
    // Q5 & Q6: EU/EEA Logic
    initEuEeaLogic();
    
    // Q3: Safety Component Logic (Section 8)
    initSafetyComponentLogic();
    
    // Other options with conditional text inputs
    initOtherOptionsLogic();
    
    // Q2: GPAI Integration Logic (Section 9)
    initGPAIIntegrationLogic();
    
    // Date Picker Implementation
    initDatePicker();
});

// Default Role Logic Functions
function initDefaultRoleLogic() {
    const defaultRoleYes = document.getElementById('default-role-yes');
    const defaultRoleNo = document.getElementById('default-role-no');
    const roleCheckboxes = document.querySelectorAll('.role-checkbox');
    const orgDefaultRoles = {{ org_default_roles_json|safe }}; // From Organization module Section 3 Q2 (e.g. ["Provider", "Deployer"])
    
    // Map role names to checkbox IDs
    const roleIdMap = {
        'Provider': 'role-provider',
        'Deployer': 'role-deployer',
        'Importer': 'role-importer',
        'Distributor': 'role-distributor'
    };
    
    function handleDefaultRoleChange(value) {
        if (value === 'Yes') {
            // Disable all role checkboxes
            roleCheckboxes.forEach(checkbox => {
                checkbox.disabled = true;
                const label = checkbox.closest('label');
                if (label) {
                    label.classList.remove('hover:bg-[#F9FAFB]', 'cursor-pointer');
                    label.classList.add('opacity-60', 'cursor-not-allowed');
                }
            });
            
            // Auto-check all default roles from Organization (multiple roles)
            const rolesToCheck = Array.isArray(orgDefaultRoles) && orgDefaultRoles.length ? orgDefaultRoles : ['Deployer'];
            rolesToCheck.forEach(function(roleName) {
                const defaultRoleId = roleIdMap[roleName];
                if (defaultRoleId) {
                    const defaultRoleCheckbox = document.getElementById(defaultRoleId);
                    if (defaultRoleCheckbox) {
                        defaultRoleCheckbox.checked = true;
                        const label = defaultRoleCheckbox.closest('label');
                        if (label) {
                            label.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                        }
                    }
                }
            });
        } else {
            // Enable all role checkboxes
            roleCheckboxes.forEach(checkbox => {
                checkbox.disabled = false;
                const label = checkbox.closest('label');
                if (label) {
                    label.classList.add('hover:bg-[#F9FAFB]', 'cursor-pointer');
                    label.classList.remove('opacity-60', 'cursor-not-allowed');
                }
            });
            
            // Clear all role selections
            roleCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
                const label = checkbox.closest('label');
                if (label) {
                    label.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                }
            });
        }
    }
    
    // Add event listeners
    if (defaultRoleYes) {
        defaultRoleYes.addEventListener('change', function() {
            if (this.checked) {
                handleDefaultRoleChange('Yes');
            }
        });
    }
    
    if (defaultRoleNo) {
        defaultRoleNo.addEventListener('change', function() {
            if (this.checked) {
                handleDefaultRoleChange('No');
            }
        });
    }
    
    // Handle role checkbox changes (only when enabled)
    roleCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.disabled) return;
            
            const label = this.closest('label');
            if (this.checked) {
                if (label) {
                    label.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                }
            } else {
                if (label) {
                    label.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                }
            }
        });
    });
    
    // Initialize state based on default selection
    if (defaultRoleNo && defaultRoleNo.checked) {
        handleDefaultRoleChange('No');
    }
}

// Date Picker Functions
let currentDate = new Date();
let selectedDate = null;

function initDatePicker() {
    const dateInput = document.getElementById('go-live-date-input');
    const dateHidden = document.getElementById('go-live-date-hidden');
    const datePicker = document.getElementById('date-picker-dropdown');
    
    if (!dateInput || !datePicker) return;
    
    // Format date as DD/MM/YYYY
    function formatDate(date) {
        if (!date) return '';
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    // Parse DD/MM/YYYY to Date
    function parseDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('/');
        if (parts.length !== 3) return null;
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        return new Date(year, month, day);
    }
    
    // Update display input with formatted date and highlight day
    function updateDisplayInput(date) {
        const dayEl = document.getElementById('date-day');
        const monthEl = document.getElementById('date-month');
        const yearEl = document.getElementById('date-year');
        const wrapper = document.getElementById('go-live-date-wrapper');
        
        if (!date) {
            dateInput.value = '';
            if (dayEl) dayEl.textContent = 'DD';
            if (monthEl) monthEl.textContent = 'MM';
            if (yearEl) yearEl.textContent = 'YYYY';
            if (wrapper) wrapper.classList.remove('date-input-has-value');
            return;
        }
        
        const formatted = formatDate(date);
        dateInput.value = formatted;
        
        // Update display elements
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        if (dayEl) {
            dayEl.textContent = day;
            dayEl.classList.add('px-1.5', 'py-0.5', 'rounded', 'bg-[#3B82F6]/20', 'text-[#3B82F6]', 'font-medium');
        }
        if (monthEl) monthEl.textContent = month;
        if (yearEl) yearEl.textContent = year;
        if (wrapper) wrapper.classList.add('date-input-has-value');
        
        // Update hidden input for form submission
        if (dateHidden) {
            const isoDate = date.toISOString().split('T')[0];
            dateHidden.value = isoDate;
        }
    }
    
    // Render calendar
    function renderCalendar() {
        const calendarEl = document.getElementById('date-picker-calendar');
        const monthYearEl = document.getElementById('date-picker-month-year');
        if (!calendarEl || !monthYearEl) return;
        
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        // Update month/year display
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        monthYearEl.textContent = `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // Monday = 0
        
        // Get today's date
        const today = new Date();
        const isToday = (date) => {
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        };
        
        // Get previous month's last days
        const prevMonth = new Date(year, month, 0);
        const prevMonthDays = prevMonth.getDate();
        
        calendarEl.innerHTML = '';
        
        // Previous month days
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
            const day = prevMonthDays - i;
            const date = new Date(year, month - 1, day);
            const dayEl = document.createElement('button');
            dayEl.type = 'button';
            dayEl.className = 'w-8 h-8 text-xs text-[#6B7280] hover:bg-white/10 rounded transition-colors';
            dayEl.textContent = day;
            dayEl.onclick = () => {
                currentDate = new Date(year, month - 1, day);
                renderCalendar();
            };
            calendarEl.appendChild(dayEl);
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayEl = document.createElement('button');
            dayEl.type = 'button';
            dayEl.className = 'w-8 h-8 text-xs text-white hover:bg-white/20 rounded transition-colors';
            
            // Check if selected
            const isSelected = selectedDate && 
                date.getDate() === selectedDate.getDate() &&
                date.getMonth() === selectedDate.getMonth() &&
                date.getFullYear() === selectedDate.getFullYear();
            
            // Check if today
            const isTodayDate = isToday(date);
            
            if (isSelected) {
                dayEl.className += ' bg-white/30 border border-[#F13D30]';
            } else if (isTodayDate) {
                dayEl.className += ' text-[#3B82F6] font-semibold';
            }
            
            dayEl.textContent = day;
            dayEl.onclick = () => {
                selectedDate = date;
                updateDisplayInput(date);
                datePicker.classList.add('hidden');
                const wrapper = document.getElementById('go-live-date-wrapper');
                if (wrapper) wrapper.classList.remove('border-[#F13D30]', 'ring-2', 'ring-[#FEEDEC]');
            };
            calendarEl.appendChild(dayEl);
        }
        
        // Next month days
        const totalCells = calendarEl.children.length;
        const remainingCells = 42 - totalCells; // 6 rows * 7 days
        for (let day = 1; day <= remainingCells; day++) {
            const date = new Date(year, month + 1, day);
            const dayEl = document.createElement('button');
            dayEl.type = 'button';
            dayEl.className = 'w-8 h-8 text-xs text-[#6B7280] hover:bg-white/10 rounded transition-colors';
            dayEl.textContent = day;
            dayEl.onclick = () => {
                currentDate = new Date(year, month + 1, day);
                renderCalendar();
            };
            calendarEl.appendChild(dayEl);
        }
    }
    
    // Toggle date picker - Click handler
    const dateWrapper = document.getElementById('go-live-date-wrapper');
    const dateDisplay = document.getElementById('go-live-date-display');
    
    function toggleDatePicker(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        const isHidden = datePicker.classList.contains('hidden');
        
        if (isHidden) {
            // Show calendar
            datePicker.classList.remove('hidden');
            if (dateWrapper) {
                dateWrapper.classList.add('border-[#F13D30]');
                dateWrapper.classList.add('ring-2', 'ring-[#FEEDEC]');
            }
            // Ensure calendar is rendered
            renderCalendar();
        } else {
            // Hide calendar
            datePicker.classList.add('hidden');
            if (dateWrapper) {
                dateWrapper.classList.remove('border-[#F13D30]', 'ring-2', 'ring-[#FEEDEC]');
            }
        }
    }
    
    // Add click listeners to wrapper and input
    if (dateWrapper) {
        dateWrapper.addEventListener('click', toggleDatePicker);
    }
    
    if (dateInput) {
        dateInput.addEventListener('click', toggleDatePicker);
        dateInput.addEventListener('focus', toggleDatePicker);
    }
    
    if (dateDisplay) {
        dateDisplay.addEventListener('click', toggleDatePicker);
    }
    
    // Close date picker when clicking outside
    document.addEventListener('click', function(e) {
        if (dateWrapper && !dateWrapper.contains(e.target) && !datePicker.contains(e.target)) {
            datePicker.classList.add('hidden');
            dateWrapper.classList.remove('border-[#F13D30]', 'ring-2', 'ring-[#FEEDEC]');
        }
    });
    
    // Navigation buttons
    document.getElementById('date-picker-prev-month')?.addEventListener('click', function(e) {
        e.stopPropagation();
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('date-picker-next-month')?.addEventListener('click', function(e) {
        e.stopPropagation();
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    document.getElementById('date-picker-today')?.addEventListener('click', function(e) {
        e.stopPropagation();
        const today = new Date();
        currentDate = new Date(today);
        selectedDate = new Date(today);
        updateDisplayInput(today);
        renderCalendar();
    });
    
    // Initialize with today's date if no value
    if (!dateInput.value) {
        const today = new Date();
        selectedDate = new Date(today);
        currentDate = new Date(today);
        updateDisplayInput(today);
    } else {
        // Parse existing value
        const parsed = parseDate(dateInput.value);
        if (parsed) {
            selectedDate = parsed;
            currentDate = new Date(parsed);
        }
    }
    
    renderCalendar();
}

// System Source Logic Functions
function initSystemSourceLogic() {
    const systemSourceRadios = document.querySelectorAll('input[name="system_source"]');
    const vendorFields = document.getElementById('vendor-fields');
    const saveVendorLinkBtn = document.getElementById('save-vendor-link-btn');
    const vendorEvidenceLink = document.getElementById('vendor-evidence-link');
    const vendorLinkSaved = document.getElementById('vendor-link-saved');
    const vendorLinkText = document.getElementById('vendor-link-text');
    
    function handleSystemSourceChange() {
        const selectedValue = document.querySelector('input[name="system_source"]:checked')?.value;
        
        // Update styling for selected option
        document.querySelectorAll('.system-source-option').forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.remove('border-[#F0F1F2]', 'bg-white');
            } else {
                label.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.add('border-[#F0F1F2]', 'bg-white');
            }
        });
        
        // Show/hide vendor fields
        if (selectedValue === 'Vendor / Third-party' || selectedValue === 'Mixed') {
            vendorFields?.classList.remove('hidden');
        } else {
            vendorFields?.classList.add('hidden');
        }
    }
    
    systemSourceRadios.forEach(radio => {
        radio.addEventListener('change', handleSystemSourceChange);
    });
    
    // Save vendor link handler
    if (saveVendorLinkBtn && vendorEvidenceLink) {
        saveVendorLinkBtn.addEventListener('click', function() {
            const link = vendorEvidenceLink.value.trim();
            if (link) {
                // Create clickable link element
                vendorLinkText.innerHTML = `<a href="${link}" target="_blank" class="text-[#F13D30] hover:underline">${link}</a>`;
                vendorLinkSaved.classList.remove('hidden');
                // Note: Link will be saved when user clicks "Confirm and Save" or "Save all"
            }
        });
    }
    
    // Trigger initial change to show/hide vendor fields based on saved data
    handleSystemSourceChange();
    
    // Initialize
    handleSystemSourceChange();
}

// Modify/Customize Logic Functions
function initModifyCustomizeLogic() {
    const modifyRadios = document.querySelectorAll('input[name="modify_customize"]');
    const modifyWarning = document.getElementById('modify-warning');
    
    function handleModifyChange() {
        const selectedValue = document.querySelector('input[name="modify_customize"]:checked')?.value;
        
        if (selectedValue === 'Yes') {
            modifyWarning?.classList.remove('hidden');
        } else {
            modifyWarning?.classList.add('hidden');
        }
    }
    
    modifyRadios.forEach(radio => {
        radio.addEventListener('change', handleModifyChange);
    });
    
    // Initialize
    handleModifyChange();
}

// EU/EEA Logic Functions
function initEuEeaLogic() {
    const euUsageRadios = document.querySelectorAll('input[name="eu_usage"]');
    const euEffectRadios = document.querySelectorAll('input[name="eu_effect"]');
    const euActNotice = document.getElementById('eu-act-notice');
    
    function updateEuUsageStyling() {
        document.querySelectorAll('.eu-usage-option').forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.remove('border-[#F0F1F2]', 'bg-white');
            } else {
                label.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.add('border-[#F0F1F2]', 'bg-white');
            }
        });
    }
    
    function updateEuEffectStyling() {
        document.querySelectorAll('.eu-effect-option').forEach(label => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                label.classList.add('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.remove('border-[#F0F1F2]', 'bg-white');
            } else {
                label.classList.remove('border-[#F13D30]', 'bg-[#FEEDEC]');
                label.classList.add('border-[#F0F1F2]', 'bg-white');
            }
        });
    }
    
    function checkEuActNotice() {
        const euUsage = document.querySelector('input[name="eu_usage"]:checked')?.value;
        const euEffect = document.querySelector('input[name="eu_effect"]:checked')?.value;
        
        if (euUsage === 'No' && euEffect === 'No') {
            euActNotice?.classList.remove('hidden');
        } else {
            euActNotice?.classList.add('hidden');
        }
    }
    
    euUsageRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateEuUsageStyling();
            checkEuActNotice();
        });
    });
    
    euEffectRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateEuEffectStyling();
            checkEuActNotice();
        });
    });
    
    // Initialize
    updateEuUsageStyling();
    updateEuEffectStyling();
    checkEuActNotice();
    // Expose so notice updates after loadProfileData sets eu_usage / eu_effect
    window.refreshEuActNotice = function() {
        updateEuUsageStyling();
        updateEuEffectStyling();
        checkEuActNotice();
    };
}

// Safety Component Logic Functions (Section 8, Q3)
function initSafetyComponentLogic() {
    const safetyComponentYes = document.getElementById('safety-component-yes');
    const safetyComponentNo = document.getElementById('safety-component-no');
    const thirdPartyConformityField = document.getElementById('third-party-conformity-field');
    const thirdPartyConformityRadios = document.querySelectorAll('input[name="third_party_conformity"]');
    
    function handleSafetyComponentChange() {
        const selectedValue = document.querySelector('input[name="safety_component"]:checked')?.value;
        
        if (selectedValue === 'Yes') {
            // Show follow-up question
            thirdPartyConformityField?.classList.remove('hidden');
        } else {
            // Hide follow-up question and clear selection
            thirdPartyConformityField?.classList.add('hidden');
            thirdPartyConformityRadios.forEach(radio => {
                radio.checked = false;
            });
        }
    }
    
    if (safetyComponentYes) {
        safetyComponentYes.addEventListener('change', handleSafetyComponentChange);
    }
    
    if (safetyComponentNo) {
        safetyComponentNo.addEventListener('change', handleSafetyComponentChange);
    }
    
    // Initialize state
    handleSafetyComponentChange();
}

// Other Options Logic Functions
function initOtherOptionsLogic() {
    // Section 4, Q2: Sector domains - Other / not listed
    const sectorOtherCheckbox = document.getElementById('sector-other-checkbox');
    const sectorOtherInput = document.getElementById('sector-other-input');
    
    if (sectorOtherCheckbox && sectorOtherInput) {
        sectorOtherCheckbox.addEventListener('change', function() {
            if (this.checked) {
                sectorOtherInput.classList.remove('hidden');
            } else {
                sectorOtherInput.classList.add('hidden');
                sectorOtherInput.value = '';
            }
        });
    }
    
    // Section 5, Q1: Deployment Context - Other
    const deploymentOtherRadio = document.getElementById('deployment-other-radio');
    const deploymentOtherInput = document.getElementById('deployment-other-input');
    const deploymentContextRadios = document.querySelectorAll('.deployment-context-radio');
    
    function handleDeploymentContextChange() {
        const selectedValue = document.querySelector('input[name="deployment_context"]:checked')?.value;
        if (selectedValue === 'Other') {
            deploymentOtherInput?.classList.remove('hidden');
        } else {
            deploymentOtherInput?.classList.add('hidden');
            if (deploymentOtherInput) deploymentOtherInput.value = '';
        }
    }
    
    deploymentContextRadios.forEach(radio => {
        radio.addEventListener('change', handleDeploymentContextChange);
    });
    
    // Section 5, Q2: System Users - Other
    const systemUsersOtherCheckbox = document.getElementById('system-users-other-checkbox');
    const systemUsersOtherInput = document.getElementById('system-users-other-input');
    
    if (systemUsersOtherCheckbox && systemUsersOtherInput) {
        systemUsersOtherCheckbox.addEventListener('change', function() {
            if (this.checked) {
                systemUsersOtherInput.classList.remove('hidden');
            } else {
                systemUsersOtherInput.classList.add('hidden');
                systemUsersOtherInput.value = '';
            }
        });
    }
    
    // Section 5, Q3: Affected Outputs - Other
    const affectedOutputsOtherCheckbox = document.getElementById('affected-outputs-other-checkbox');
    const affectedOutputsOtherInput = document.getElementById('affected-outputs-other-input');
    
    if (affectedOutputsOtherCheckbox && affectedOutputsOtherInput) {
        affectedOutputsOtherCheckbox.addEventListener('change', function() {
            if (this.checked) {
                affectedOutputsOtherInput.classList.remove('hidden');
            } else {
                affectedOutputsOtherInput.classList.add('hidden');
                affectedOutputsOtherInput.value = '';
            }
        });
    }
    
    // Section 6, Q2: Output Types - Other
    const outputTypesOtherCheckbox = document.getElementById('output-types-other-checkbox');
    const outputTypesOtherInput = document.getElementById('output-types-other-input');
    
    if (outputTypesOtherCheckbox && outputTypesOtherInput) {
        outputTypesOtherCheckbox.addEventListener('change', function() {
            if (this.checked) {
                outputTypesOtherInput.classList.remove('hidden');
            } else {
                outputTypesOtherInput.classList.add('hidden');
                outputTypesOtherInput.value = '';
            }
        });
    }
}

// GPAI Integration Logic Functions (Section 9, Q2)
function initGPAIIntegrationLogic() {
    const gpaiIntegrationRadios = document.querySelectorAll('.gpai-integration-radio');
    const gpaiProviderField = document.getElementById('gpai-provider-field');
    const gpaiProviderInput = document.getElementById('gpai-provider-input');
    
    function handleGPAIIntegrationChange() {
        const selectedValue = document.querySelector('input[name="gpai_integration"]:checked')?.value;
        
        if (selectedValue === 'Yes') {
            // Show GPAI provider input field
            gpaiProviderField?.classList.remove('hidden');
        } else {
            // Hide GPAI provider input field and clear value
            gpaiProviderField?.classList.add('hidden');
            if (gpaiProviderInput) gpaiProviderInput.value = '';
        }
    }
    
    gpaiIntegrationRadios.forEach(radio => {
        radio.addEventListener('change', handleGPAIIntegrationChange);
    });
    
    // Initialize state
    handleGPAIIntegrationChange();
}
</script>

<style>
/* Date picker calendar styling */
#date-picker-dropdown {
    font-family: 'Montserrat', sans-serif;
}

#date-picker-calendar button {
    font-family: 'Montserrat', sans-serif;
}

#go-live-date-wrapper:focus-within {
    border-color: #F13D30;
    box-shadow: 0 0 0 2px rgba(241, 61, 48, 0.1);
}

#go-live-date-display {
    pointer-events: auto;
    cursor: pointer;
}
</style>
{% endblock %}
