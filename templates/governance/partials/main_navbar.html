
{% load static %}
<!-- main_navbar.html - Navigation Sidebar based on design image -->
<nav class="main-sidebar w-60 h-screen bg-[#FEF5F4] border-r border-[#E5E7EB] flex flex-col p-4 gap-1 fixed left-0 top-0 font-['Montserrat',sans-serif] z-[100] overflow-y-auto transition-all duration-300">
    <!-- Logo -->
    <div class="flex items-center justify-between px-1 pb-4 mb-2 border-b border-[#E5E7EB]">
        <a href="{% url 'dashboard' %}" class="flex items-center gap-2 no-underline">
            <img src="{% static 'governance/img/logored.svg' %}" alt="Logo" class="logo-icon w-6 h-6 flex-shrink-0">
            <div class="flex flex-col">
                <span class="logo-text text-sm font-bold text-[#DC6B64] tracking-tight">DT MASTER</span>
                <span class="logo-subtext text-xs font-normal text-[#DC6B64]">Carbon</span>
            </div>
        </a>
    </div>

    <!-- Main Navigation -->
    <div class="flex flex-col gap-0.5">
        <a href="{% url 'dashboard' %}" class="nav-link active flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="dashboard">
            <img src="{% static 'governance/img/nav-1-chart-square.svg' %}" alt="Dashboard" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Dashboard</span>
        </a>
        <a href="{% url 'ai_assistant' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="ai-assistant">
            <img src="{% static 'governance/img/nav-3-stars.svg' %}" alt="AI Assistant" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">AI Assistant</span>
        </a>
        <a href="{% url 'organization' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="organization">
            <img src="{% static 'governance/img/icon-organization.svg' %}" alt="Organization" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Organization</span>
        </a>
        <a href="{% url 'ai_inventory' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="ai-inventory">
            <img src="{% static 'governance/img/icon-database.svg' %}" alt="AI Inventory" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">AI Inventory</span>
        </a>
    </div>

    <!-- AI Systems Sub Menu Section (Only show when on a specific AI system page) -->
    <!-- <div class="nav-section my-1 collapsed" id="ai-systems-submenu-section">
        <div class="nav-section-header flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]">
            <a href="{% url 'ai_systems' %}" class="flex items-center gap-3 flex-1 no-underline text-[#4B5563] hover:text-[#4B5563]">
                <img src="{% static 'governance/img/selected_ai_systems.svg' %}" alt="AI Systems" class="nav-icon w-5 h-5">
                <span class="nav-label text-sm font-medium">AI Systems</span>
            </a>
            <button type="button" onclick="toggleRiskAssessmentSection(this.closest('.nav-section-header'))" class="flex items-center justify-center w-6 h-6 border-none bg-transparent cursor-pointer hover:bg-[rgba(220,107,100,0.15)] rounded transition-colors duration-200 p-0">
                <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 flex-shrink-0 transition-transform duration-200">
            </button>
        </div>
        <div class="nav-section-items flex flex-col gap-0.5 pl-8">
            <a href="{% url 'multi_agent_use_cases' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="overview">Overview</a>
            <a href="{% url 'assessment' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="questionnaires">Questionnaires</a>
            <a href="{% url 'risk_overview' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="risks">Risks</a>
            <a href="{% url 'digital_regulations' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="compliance">Compliance</a>
            <div class="secondary-nav-section expanded">
                <div class="secondary-nav-section-header flex items-center justify-between cursor-pointer" onclick="toggleSecondaryNavSection(this)">
                    <span class="text-sm font-medium text-[#4B5563]">Artifacts</span>
                    <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 transition-transform">
                </div>
                <div class="secondary-nav-subitems">
                    <a href="{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% else %}#{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563] no-underline">Review history</a>
                    <a href="{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% else %}#{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563] no-underline">Reports</a>
                    <a href="{% url 'assessment_library' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563]">Data Sets</a>
                </div>
            </div>
        </div>
    </div> -->

    <div class="flex flex-col gap-0.5">
        <a href="{% url 'questionnaire_library' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="data-collection">
            <img src="{% static 'governance/img/nav-5-data.svg' %}" alt="Data Collection" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Data Collection</span>
        </a>
    </div>

    <!-- Data Hub Section -->
    <div class="nav-section my-1">
        <div class="nav-section-header flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#4B5563] text-sm font-medium leading-5 cursor-pointer transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" onclick="toggleNavSection(this)">
            <img src="{% static 'governance/img/nav-6-horizontal-chart.svg' %}" alt="Data Hub" class="nav-icon w-5 h-5">
            <span class="nav-label text-sm font-medium">Data Hub</span>
            <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 ml-auto flex-shrink-0 transition-transform duration-200">
        </div>
        <div class="nav-section-items flex flex-col gap-0.5 pl-8">
            <a href="{% url 'ai_models' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="models">Models</a>
            <a href="{% url 'datasets' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="datasets">Datasets</a>
            <a href="{% url 'vendors' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="vendors">Vendors</a>
            <a href="{% url 'investment' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="investments">Investments</a>
        </div>
    </div>

    <!-- Reporting -->
    <div class="flex flex-col gap-0.5">
        <a href="{% url 'framework' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="reporting">
            <img src="{% static 'governance/img/compliance.svg' %}" alt="Reporting" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Reporting</span>
        </a>
    </div>

    <!-- Spacer -->
    <div class="flex-1"></div>

    <!-- Footer Links -->
    <div class="sidebar-footer pt-3 border-t border-[#E5E7EB] flex flex-col gap-0.5">
        <!-- <a href="/account/" class="nav-link footer-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="account-center">
            <img src="{% static 'governance/img/user-01.svg' %}" alt="Account" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Account Center</span>
        </a> -->
        <!-- Platform switcher - not implemented in hackathon demo -->
        <div class="flex flex-col gap-4 text-base font-semibold text-text-tertiary">
            <div class="mt-1">
                <div class="w-full flex items-center justify-between gap-3 px-3 py-2 rounded-md border border-gray-300 bg-white text-left">
                    <div class="flex items-center gap-3 flex-1">
                        <img src="{% static 'governance/img/nav-1-chart-square.svg' %}" class="size-5 w-5 flex-shrink-0" />
                        <span class="text-sm text-gray-700">
                            <span class="text-gray-500">Platform:</span> Governance
                        </span>
                    </div>
                </div>
            </div>
        </div>
</nav>

<style>
    /* Collapsed sidebar state */
    .main-sidebar.collapsed {
        width: 72px;
        padding: 16px 8px;
    }
    
    .main-sidebar.collapsed .logo-text,
    .main-sidebar.collapsed .nav-label {
        display: none !important;
    }
    
    .main-sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
    }
    
    .main-sidebar.collapsed .nav-link .nav-icon {
        display: block !important;
        width: 20px !important;
        height: 20px !important;
    }
    
    .main-sidebar.collapsed .nav-section-header {
        justify-content: center;
        padding: 10px;
    }
    
    .main-sidebar.collapsed .nav-section-header .nav-icon {
        display: block !important;
    }
    
    .main-sidebar.collapsed .nav-section-header .chevron {
        display: none;
    }
    
    .main-sidebar.collapsed .nav-section-items {
        padding-left: 0;
    }
    
    .main-sidebar.collapsed .nav-link.sub-item {
        justify-content: center;
        padding: 8px;
    }
    
    .main-sidebar.collapsed .footer-link .nav-icon {
        display: block !important;
        width: 20px !important;
        height: 20px !important;
    }
    
    .main-sidebar.collapsed .logo-icon {
        display: block !important;
    }

    /* Custom styles for complex interactions */
    .nav-link:hover .nav-icon {
        filter: none;
    }

    .nav-link.active {
        background: #F3F4F6;
        color: #DC6B64;
    }

    .nav-link.active .nav-icon {
        filter: none;
    }

    .nav-link.active .nav-label {
        color: #DC6B64;
        text-decoration: none;
    }

    .nav-section.collapsed .chevron {
        transform: rotate(180deg);
    }

    .nav-section.collapsed .nav-section-items {
        display: none;
    }

    .nav-link.sub-item.active {
        background: #F3F4F6 !important;
        color: #DC6B64 !important;
        border-radius: 6px;
    }

    .nav-link.sub-item.active,
    .nav-link.sub-item.active:hover {
        background: #F3F4F6 !important;
        background-color: #F3F4F6 !important;
        color: #DC6B64 !important;
    }

    .nav-link.sub-item.active .nav-label,
    .nav-link.sub-item.active span.nav-label {
        color: #DC6B64 !important;
        text-decoration: none;
    }
    
    .nav-link.sub-item.active:hover .nav-label,
    .nav-link.sub-item.active:hover span.nav-label {
        color: #DC6B64 !important;
    }
    
    /* Override Tailwind inline classes - use attribute selector for better specificity */
    a.nav-link.sub-item.active[data-nav="risks"],
    a.nav-link.sub-item.active[data-nav="questionnaires"],
    a.nav-link.sub-item.active[data-nav="overview"],
    a.nav-link.sub-item.active[data-nav="compliance"] {
        background: #F3F4F6 !important;
        background-color: #F3F4F6 !important;
        color: #DC6B64 !important;
    }
    
    a.nav-link.sub-item.active[data-nav="risks"] .nav-label,
    a.nav-link.sub-item.active[data-nav="questionnaires"] .nav-label,
    a.nav-link.sub-item.active[data-nav="overview"] .nav-label,
    a.nav-link.sub-item.active[data-nav="compliance"] .nav-label {
        color: #DC6B64 !important;
    }
    
    /* Override Tailwind inline classes */
    .nav-link.sub-item.active.text-\[#4B5563\] {
        color: #DC6B64 !important;
    }
    
    .nav-link.sub-item.active .text-\[#4B5563\] {
        color: #DC6B64 !important;
    }

    /* Secondary Nav Section (Artifacts) */
    .secondary-nav-section {
        margin-top: 4px;
    }

    .secondary-nav-section-header {
        padding: 8px 12px;
        color: #4B5563;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .secondary-nav-section-header:hover {
        background: rgba(220, 107, 100, 0.08);
        border-radius: 6px;
    }

    .secondary-nav-section-header .chevron {
        transition: transform 0.2s;
    }

    .secondary-nav-section:not(.expanded) .chevron {
        transform: rotate(180deg);
    }

    .secondary-nav-section:not(.expanded) .secondary-nav-subitems {
        display: none;
    }

    .secondary-nav-subitems {
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding-left: 16px;
        margin-top: 4px;
    }

    .secondary-nav-subitem {
        padding: 8px 12px;
        color: #4B5563;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .secondary-nav-subitem:hover {
        background: rgba(220, 107, 100, 0.08);
        color: #4B5563;
    }

    .secondary-nav-subitem:has-text("Data Hub") {
        text-decoration: none;
    }

    /* Ensure Data Hub link is not underlined */
    .secondary-nav-subitems a.secondary-nav-subitem.underline {
        text-decoration: underline;
    }
    
    .secondary-nav-subitems a.secondary-nav-subitem:not(.underline) {
        text-decoration: none;
    }
</style>

<script>
    // Wrap in IIFE to avoid conflicts with other scripts
    (function() {
        'use strict';
        
        // Constants
        const ACTIVE_STYLES = {
            bg: '#F3F4F6',
            color: '#DC6B64',
            textClass: 'text-[#4B5563]'
        };

        // Utility functions
        const toggleNavSection = (header) => {
            if (!header || typeof header.closest !== 'function') return;
            header.closest('.nav-section')?.classList.toggle('collapsed');
        };
        
        // Expose to window for inline onclick handlers
        window.toggleNavSection = toggleNavSection;

    const toggleSecondaryNavSection = (element) => {
        element.closest('.secondary-nav-section')?.classList.toggle('expanded');
    };

    const removeActiveStyles = (link) => {
        link.classList.remove('active');
        link.style.backgroundColor = '';
        link.style.color = '';
        const label = link.querySelector('.nav-label');
        if (label) {
            label.style.color = '';
            label.classList.remove(ACTIVE_STYLES.textClass);
        }
        link.classList.remove(ACTIVE_STYLES.textClass);
    };

    const applyActiveStyles = (link) => {
        link.classList.add('active');
        link.classList.remove(ACTIVE_STYLES.textClass);
        
        const label = link.querySelector('.nav-label');
        if (label) {
            label.classList.remove(ACTIVE_STYLES.textClass);
        }

        if (link.classList.contains('sub-item')) {
            link.style.backgroundColor = ACTIVE_STYLES.bg;
            link.style.color = ACTIVE_STYLES.color;
            if (label) {
                label.style.color = ACTIVE_STYLES.color;
            }
        }
    };

    // Navigation mapping
    const getActiveNav = (path, url) => {
        const navMap = [
            { paths: ['/ai-assistant', '/ai_assistant'], nav: 'ai-assistant' },
            { paths: ['/organization'], nav: 'organization' },
            { paths: ['/ai-inventory'], nav: 'ai-inventory' },
            { paths: ['/questionnaire', '/data-collection'], nav: 'data-collection' },
            { paths: ['/models', '/ai-models'], nav: 'models' },
            { paths: ['/datasets'], nav: 'datasets' },
            { paths: ['/vendors'], nav: 'vendors' },
            { paths: ['/investment'], nav: 'investments' },
            { paths: ['/framework', '/reporting'], nav: 'reporting' },
        ];

        for (const { paths, nav } of navMap) {
            if (paths.some(p => path.includes(p))) {
                return nav;
            }
        }

        // AI Systems detail pages
        if (path.includes('/ai-systems') && !path.match(/\/ai-systems\/[^\/]+/)) {
            return 'ai-systems';
        }

        if (path.includes('/assessment') || path.includes('/risk-overview') || 
            path.includes('/risks') || path.includes('/multi-agent-use-cases') || 
            path.includes('/digital-regulations') || path.includes('/eu-act/') || 
            url.includes('agent=')) {
            return 'ai-systems';
        }

        return 'dashboard';
    };

    const getActiveSubNav = (path, url) => {
        const subNavMap = [
            { paths: ['/risk-overview', '/risks'], nav: 'risks' },
            { paths: ['/digital-regulations', '/eu-act/', '/digital-regulations/eu-act/'], nav: 'compliance' },
            { paths: ['/review-history'], nav: 'review-history' },
            { paths: ['/reports'], nav: 'reports' },
            { paths: ['/assessment-library'], nav: 'data-sets' },
        ];

        for (const { paths, nav } of subNavMap) {
            if (paths.some(p => path.includes(p))) {
                return nav;
            }
        }

        if (path.includes('/questionnaires/') || 
            (path.includes('/assessment/') && !path.includes('/assessment-library') && 
             !path.match(/\/assessment\/\d+\//))) {
            return 'questionnaires';
        }

        if (path.includes('/assessment') && !path.includes('/assessment-library')) {
            return 'all-use-cases';
        }

        if (path.includes('/multi-agent-use-cases') || url.includes('agent=')) {
            return 'overview';
        }

        return '';
    };

    // Set active navigation
    const setActiveNavItem = () => {
        const navLinks = document.querySelectorAll('.nav-link');
        const path = window.location.pathname;
        const url = window.location.href;

        // Handle account pages
        if (path.includes('/accounts/')) {
            const accountLink = document.querySelector('[data-nav="account-center"]');
            if (accountLink) {
                navLinks.forEach(removeActiveStyles);
                applyActiveStyles(accountLink);
                return;
            }
        }

        const activeNav = getActiveNav(path, url);
        const activeSubNav = getActiveSubNav(path, url);

        // Reset all links
        navLinks.forEach(removeActiveStyles);

        // Apply active to matching links
        navLinks.forEach(link => {
            const navKey = link.getAttribute('data-nav');
            if (navKey === activeNav || navKey === activeSubNav) {
                applyActiveStyles(link);
            }
        });

        // Expand parent section for active sub-item
        const activeSubLink = document.querySelector('.nav-link.sub-item.active');
        if (activeSubLink) {
            activeSubLink.closest('.nav-section')?.classList.remove('collapsed');
        }
    };

    // Handle nav link clicks
    const handleNavClick = (e) => {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(removeActiveStyles);
        applyActiveStyles(e.currentTarget);

        // Expand parent section for sub-items
        if (e.currentTarget.classList.contains('sub-item')) {
            e.currentTarget.closest('.nav-section')?.classList.remove('collapsed');
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.querySelector('.main-sidebar');
        const mainContent = document.getElementById('main-content');
        const path = window.location.pathname;
        const url = window.location.href;

        // Initialize sidebar state
        if (sidebar && mainContent) {
            setTimeout(() => {
                if (window.getComputedStyle(mainContent).marginLeft === '72px') {
                    sidebar.classList.add('collapsed');
                }
            }, 100);
        }

        // Handle AI Systems submenu visibility
        const aiSystemsSubMenu = document.getElementById('ai-systems-submenu-section');
        if (aiSystemsSubMenu) {
            const isListPage = path.match(/\/ai-systems\/?$/) || 
                              (path.includes('/ai-systems') && !path.match(/\/ai-systems\/[^\/]+/));
            const isDetailPage = path.includes('/multi-agent-use-cases') ||
                                (path.includes('/assessment') && !path.includes('/assessment-library') && !isListPage) ||
                                (path.includes('/digital-regulations') && !isListPage) ||
                                (path.includes('/eu-act/') && !isListPage) ||
                                (path.includes('/risk-overview') && !isListPage) ||
                                (url.includes('agent='));

            if (isListPage) {
                aiSystemsSubMenu.classList.add('collapsed');
            } else if (isDetailPage) {
                aiSystemsSubMenu.classList.remove('collapsed');
                sidebar?.classList.remove('collapsed');
                if (mainContent) mainContent.style.marginLeft = '240px';
            } else {
                aiSystemsSubMenu.classList.add('collapsed');
            }
        }

        // Set active nav
        setActiveNavItem();

        // Attach click handlers
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', handleNavClick);
        });

        // Handle section toggles
        document.querySelectorAll('.nav-section-header button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNavSection(btn.closest('.nav-section-header'));
            });
        });
    });
    })(); // End IIFE
</script>
