
{% load static %}
<!-- main_navbar.html - Navigation Sidebar based on design image -->
<nav class="main-sidebar w-60 h-screen bg-[#FEF5F4] border-r border-[#E5E7EB] flex flex-col p-4 gap-1 fixed left-0 top-0 font-['Montserrat',sans-serif] z-[100] overflow-y-auto transition-all duration-300">
    <!-- Logo -->
    <div class="flex items-center justify-between px-1 pb-4 mb-2 border-b border-[#E5E7EB]">
        <a href="{% url 'dashboard' %}" class="flex items-center gap-2 no-underline">
            <img src="{% static 'governance/img/logored.svg' %}" alt="Logo" class="logo-icon w-6 h-6 flex-shrink-0">
            <div class="flex flex-col">
                <span class="logo-text text-sm font-bold text-[#DC6B64] tracking-tight">DT MASTER</span>
                <span class="logo-subtext text-xs font-normal text-[#DC6B64]">Carbon</span>
            </div>
        </a>
    </div>

    <!-- Main Navigation -->
    <div class="flex flex-col gap-0.5">
        <a href="{% url 'dashboard' %}" class="nav-link active flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="dashboard">
            <img src="{% static 'governance/img/nav-1-chart-square.svg' %}" alt="Dashboard" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Dashboard</span>
        </a>
        <a href="{% url 'ai_assistant' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="ai-assistant">
            <img src="{% static 'governance/img/nav-3-stars.svg' %}" alt="AI Assistant" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">AI Assistant</span>
        </a>
        <a href="{% url 'organization' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="organization">
            <img src="{% static 'governance/img/icon-organization.svg' %}" alt="Organization" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Organization</span>
        </a>
        <a href="{% url 'ai_inventory' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="ai-inventory">
            <img src="{% static 'governance/img/icon-database.svg' %}" alt="AI Inventory" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">AI Inventory</span>
        </a>
    </div>

    <!-- AI Systems Sub Menu Section (Only show when on a specific AI system page) -->
    <div class="nav-section my-1 collapsed" id="ai-systems-submenu-section">
        <div class="nav-section-header flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]">
            <a href="{% url 'ai_systems' %}" class="flex items-center gap-3 flex-1 no-underline text-[#4B5563] hover:text-[#4B5563]">
                <img src="{% static 'governance/img/selected_ai_systems.svg' %}" alt="AI Systems" class="nav-icon w-5 h-5">
                <span class="nav-label text-sm font-medium">AI Systems</span>
            </a>
            <button type="button" onclick="toggleRiskAssessmentSection(this.closest('.nav-section-header'))" class="flex items-center justify-center w-6 h-6 border-none bg-transparent cursor-pointer hover:bg-[rgba(220,107,100,0.15)] rounded transition-colors duration-200 p-0">
                <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 flex-shrink-0 transition-transform duration-200">
            </button>
        </div>
        <div class="nav-section-items flex flex-col gap-0.5 pl-8">
            <a href="{% url 'multi_agent_use_cases' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="overview">Overview</a>
            <a href="{% url 'assessment' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="questionnaires">Questionnaires</a>
            <a href="{% url 'risk_overview' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="risks">Risks</a>
            <a href="{% url 'digital_regulations' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="compliance">Compliance</a>
             <!-- Artifacts Section (Expandable) -->
            <div class="secondary-nav-section expanded">
                <div class="secondary-nav-section-header flex items-center justify-between cursor-pointer" onclick="toggleSecondaryNavSection(this)">
                    <span class="text-sm font-medium text-[#4B5563]">Artifacts</span>
                    <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 transition-transform">
                </div>
                <div class="secondary-nav-subitems">
                    <a href="{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% else %}#{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563] no-underline">Review history</a>
                    <a href="{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% else %}#{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563] no-underline">Reports</a>
                    <a href="{% url 'assessment_library' %}{% if request.GET.agent %}?agent={{ request.GET.agent|urlencode }}{% endif %}" class="secondary-nav-subitem text-sm font-medium text-[#4B5563]">Data Sets</a>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-col gap-0.5">
        <a href="{% url 'questionnaire_library' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="data-collection">
            <img src="{% static 'governance/img/nav-5-data.svg' %}" alt="Data Collection" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Data Collection</span>
        </a>
    </div>

    <!-- Data Hub Section -->
    <div class="nav-section my-1">
        <div class="nav-section-header flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#4B5563] text-sm font-medium leading-5 cursor-pointer transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" onclick="toggleSection(this)">
            <img src="{% static 'governance/img/nav-6-horizontal-chart.svg' %}" alt="Data Hub" class="nav-icon w-5 h-5">
            <span class="nav-label text-sm font-medium">Data Hub</span>
            <img src="{% static 'governance/img/chevron-up.svg' %}" alt="Toggle" class="chevron w-4 h-4 ml-auto flex-shrink-0 transition-transform duration-200">
        </div>
        <div class="nav-section-items flex flex-col gap-0.5 pl-8">
            <a href="{% url 'ai_models' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="models">Models</a>
            <a href="{% url 'datasets' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="datasets">Datasets</a>
            <a href="{% url 'vendors' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="vendors">Vendors</a>
            <a href="{% url 'investment' %}" class="nav-link sub-item flex items-center gap-3 px-3 py-2 rounded-lg text-[#4B5563] text-sm font-medium transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="investments">Investments</a>
        </div>
    </div>

    <!-- Reporting -->
    <div class="flex flex-col gap-0.5">
        <a href="{% url 'framework' %}" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="reporting">
            <img src="{% static 'governance/img/compliance.svg' %}" alt="Reporting" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Reporting</span>
        </a>
    </div>

    <!-- Spacer -->
    <div class="flex-1"></div>

    <!-- Footer Links -->
    <div class="sidebar-footer pt-3 border-t border-[#E5E7EB] flex flex-col gap-0.5">
        <!-- <a href="/account/" class="nav-link footer-link flex items-center gap-3 px-3 py-2.5 rounded-lg no-underline text-[#4B5563] text-sm font-medium leading-5 transition-all duration-200 hover:bg-[rgba(220,107,100,0.08)] hover:text-[#4B5563]" data-nav="account-center">
            <img src="{% static 'governance/img/user-01.svg' %}" alt="Account" class="nav-icon w-5 h-5 flex-shrink-0 transition-all duration-200 object-contain">
            <span class="nav-label flex-1 whitespace-nowrap overflow-hidden text-ellipsis text-sm font-medium leading-5">Account Center</span>
        </a> -->
        <!-- Platform switcher - not implemented in hackathon demo -->
        <div class="flex flex-col gap-4 text-base font-semibold text-text-tertiary">
            <div class="mt-1">
                <div class="w-full flex items-center justify-between gap-3 px-3 py-2 rounded-md border border-gray-300 bg-white text-left">
                    <div class="flex items-center gap-3 flex-1">
                        <img src="{% static 'governance/img/nav-1-chart-square.svg' %}" class="size-5 w-5 flex-shrink-0" />
                        <span class="text-sm text-gray-700">
                            <span class="text-gray-500">Platform:</span> Governance
                        </span>
                    </div>
                </div>
            </div>
        </div>
</nav>

<style>
    /* Collapsed sidebar state */
    .main-sidebar.collapsed {
        width: 72px;
        padding: 16px 8px;
    }
    
    .main-sidebar.collapsed .logo-text,
    .main-sidebar.collapsed .nav-label {
        display: none !important;
    }
    
    .main-sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
    }
    
    .main-sidebar.collapsed .nav-link .nav-icon {
        display: block !important;
        width: 20px !important;
        height: 20px !important;
    }
    
    .main-sidebar.collapsed .nav-section-header {
        justify-content: center;
        padding: 10px;
    }
    
    .main-sidebar.collapsed .nav-section-header .nav-icon {
        display: block !important;
    }
    
    .main-sidebar.collapsed .nav-section-header .chevron {
        display: none;
    }
    
    .main-sidebar.collapsed .nav-section-items {
        padding-left: 0;
    }
    
    .main-sidebar.collapsed .nav-link.sub-item {
        justify-content: center;
        padding: 8px;
    }
    
    .main-sidebar.collapsed .footer-link .nav-icon {
        display: block !important;
        width: 20px !important;
        height: 20px !important;
    }
    
    .main-sidebar.collapsed .logo-icon {
        display: block !important;
    }

    /* Custom styles for complex interactions */
    .nav-link:hover .nav-icon {
        filter: none;
    }

    .nav-link.active {
        background: #F3F4F6;
        color: #DC6B64;
    }

    .nav-link.active .nav-icon {
        filter: none;
    }

    .nav-link.active .nav-label {
        color: #DC6B64;
        text-decoration: none;
    }

    .nav-section.collapsed .chevron {
        transform: rotate(180deg);
    }

    .nav-section.collapsed .nav-section-items {
        display: none;
    }

    .nav-link.sub-item.active {
        background: #F3F4F6 !important;
        color: #DC6B64 !important;
        border-radius: 6px;
    }

    .nav-link.sub-item.active,
    .nav-link.sub-item.active:hover {
        background: #F3F4F6 !important;
        background-color: #F3F4F6 !important;
        color: #DC6B64 !important;
    }

    .nav-link.sub-item.active .nav-label,
    .nav-link.sub-item.active span.nav-label {
        color: #DC6B64 !important;
        text-decoration: none;
    }
    
    .nav-link.sub-item.active:hover .nav-label,
    .nav-link.sub-item.active:hover span.nav-label {
        color: #DC6B64 !important;
    }
    
    /* Override Tailwind inline classes - use attribute selector for better specificity */
    a.nav-link.sub-item.active[data-nav="risks"],
    a.nav-link.sub-item.active[data-nav="questionnaires"],
    a.nav-link.sub-item.active[data-nav="overview"],
    a.nav-link.sub-item.active[data-nav="compliance"] {
        background: #F3F4F6 !important;
        background-color: #F3F4F6 !important;
        color: #DC6B64 !important;
    }
    
    a.nav-link.sub-item.active[data-nav="risks"] .nav-label,
    a.nav-link.sub-item.active[data-nav="questionnaires"] .nav-label,
    a.nav-link.sub-item.active[data-nav="overview"] .nav-label,
    a.nav-link.sub-item.active[data-nav="compliance"] .nav-label {
        color: #DC6B64 !important;
    }
    
    /* Override Tailwind inline classes */
    .nav-link.sub-item.active.text-\[#4B5563\] {
        color: #DC6B64 !important;
    }
    
    .nav-link.sub-item.active .text-\[#4B5563\] {
        color: #DC6B64 !important;
    }

    /* Secondary Nav Section (Artifacts) */
    .secondary-nav-section {
        margin-top: 4px;
    }

    .secondary-nav-section-header {
        padding: 8px 12px;
        color: #4B5563;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .secondary-nav-section-header:hover {
        background: rgba(220, 107, 100, 0.08);
        border-radius: 6px;
    }

    .secondary-nav-section-header .chevron {
        transition: transform 0.2s;
    }

    .secondary-nav-section:not(.expanded) .chevron {
        transform: rotate(180deg);
    }

    .secondary-nav-section:not(.expanded) .secondary-nav-subitems {
        display: none;
    }

    .secondary-nav-subitems {
        display: flex;
        flex-direction: column;
        gap: 2px;
        padding-left: 16px;
        margin-top: 4px;
    }

    .secondary-nav-subitem {
        padding: 8px 12px;
        color: #4B5563;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .secondary-nav-subitem:hover {
        background: rgba(220, 107, 100, 0.08);
        color: #4B5563;
    }

    .secondary-nav-subitem:has-text("Data Hub") {
        text-decoration: none;
    }

    /* Ensure Data Hub link is not underlined */
    .secondary-nav-subitems a.secondary-nav-subitem.underline {
        text-decoration: underline;
    }
    
    .secondary-nav-subitems a.secondary-nav-subitem:not(.underline) {
        text-decoration: none;
    }
</style>

<script>
    function toggleSection(header) {
        const section = header.closest('.nav-section');
        section.classList.toggle('collapsed');
    }

    function toggleSecondaryNavSection(element) {
        const section = element.closest('.secondary-nav-section');
        if (section) {
            section.classList.toggle('expanded');
        }
    }
    
    function toggleRiskAssessmentSection(header) {
        const section = header.closest('.nav-section');
        section.classList.toggle('collapsed');
        
        // Prevent sidebar from collapsing when Risk Assessment section is expanded
        const sidebar = document.querySelector('.main-sidebar');
        const mainContent = document.getElementById('main-content');
        if (sidebar && mainContent) {
            if (section.classList.contains('collapsed')) {
                // Section is collapsed, check if we should collapse sidebar
                // Only collapse if no other sections are expanded
                const allSections = document.querySelectorAll('.nav-section');
                let hasExpandedSection = false;
                allSections.forEach(sec => {
                    if (!sec.classList.contains('collapsed')) {
                        hasExpandedSection = true;
                    }
                });
                // Don't auto-collapse sidebar, keep it expanded
            } else {
                // Section is expanded, ensure sidebar is full width
                sidebar.classList.remove('collapsed');
                if (mainContent) {
                    mainContent.style.marginLeft = '240px';
                }
            }
        }
    }
    
    // Set active nav item based on current page
    function setActiveNavItem() {
        const navLinks = document.querySelectorAll('.nav-link');
        const currentPath = window.location.pathname;
        const currentUrl = window.location.href;
        
        // Check if we're on account pages
        if (currentPath.includes('/accounts/')) {
            const accountCenterLink = document.querySelector('[data-nav="account-center"]');
            if (accountCenterLink) {
                navLinks.forEach(link => link.classList.remove('active'));
                accountCenterLink.classList.add('active');
                return;
            }
        }
        
        // Default to dashboard
        let activeNav = 'dashboard';
        
        // Determine active nav based on URL
        let activeSubNav = '';
        
        if (currentPath.includes('/ai-assistant') || currentPath.includes('/ai_assistant')) {
            activeNav = 'ai-assistant';
        } else if (currentPath.includes('/ai-systems') && !currentPath.match(/\/ai-systems\/[^\/]+/)) {
            // Only /ai-systems/ (list page), not a detail page
            activeNav = 'ai-systems';
        } else if (currentPath.includes('/assessment') || currentPath.includes('/risk-overview') || currentPath.includes('/risks') || currentPath.includes('/multi-agent-use-cases') || currentPath.includes('/digital-regulations') || currentPath.includes('/eu-act/') || currentPath.includes('/digital-regulations/eu-act/') || currentUrl.includes('agent=')) {
            // On a specific AI system detail page - show sub menu
            activeNav = 'ai-systems';
            
            // Check specific pages first (order matters!)
            // Check risk-overview FIRST before other checks (most specific first)
            if (currentPath.includes('/risk-overview') || currentPath.includes('/risks')) {
                activeSubNav = 'risks';
                console.log('[Nav] Matched risk-overview, setting activeSubNav to risks');
            } else if (currentPath.includes('/digital-regulations') || currentPath.includes('/eu-act/') || currentPath.includes('/digital-regulations/eu-act/')) {
                activeSubNav = 'compliance';
            } else if (currentPath.includes('/review-history')) {
                activeSubNav = 'review-history';
            } else if (currentPath.includes('/reports')) {
                activeSubNav = 'reports';
            } else if (currentPath.includes('/assessment-library')) {
                activeSubNav = 'data-sets';
            } else if (currentPath.includes('/questionnaires/') || 
                      (currentPath.includes('/assessment/') && 
                       !currentPath.includes('/assessment-library') && 
                       !currentPath.match(/\/assessment\/\d+\//))) {
                // Questionnaires page: /assessment/ (exact, no ID) or /questionnaires/
                activeSubNav = 'questionnaires';
            } else if (currentPath.includes('/assessment') && !currentPath.includes('/assessment-library')) {
                // Other assessment pages (not questionnaires) - like /assessment/123/
                activeSubNav = 'all-use-cases';
            } else if (currentPath.includes('/multi-agent-use-cases')) {
                // Overview page - must check this after other specific pages
                activeSubNav = 'overview';
            } else if (currentUrl.includes('agent=')) {
                // Default to overview for any detail page with agent parameter but no specific path
                activeSubNav = 'overview';
            } else {
                // Final fallback to overview
                activeSubNav = 'overview';
            }
        } else if (currentPath.includes('/questionnaire') || currentPath.includes('/data-collection')) {
            activeNav = 'data-collection';
        } else if (currentPath.includes('/models') || currentPath.includes('/ai-models')) {
            activeNav = 'models';
        } else if (currentPath.includes('/datasets')) {
            activeNav = 'datasets';
        } else if (currentPath.includes('/vendors')) {
            activeNav = 'vendors';
        } else if (currentPath.includes('/investment')) {
            activeNav = 'investments';
        } else if (currentPath.includes('/framework') || currentPath.includes('/reporting')) {
            activeNav = 'reporting';
        }
        
        // Remove active class from all nav links
        navLinks.forEach(link => {
            link.classList.remove('active');
        });
        
        // Add active class to current nav item (main nav or sub-nav)
        console.log('[Nav] Setting active nav', { activeNav, activeSubNav, currentPath: window.location.pathname });
        navLinks.forEach(link => {
            const navKey = link.getAttribute('data-nav');
            if (navKey === activeNav || navKey === activeSubNav) {
                link.classList.add('active');
                // Remove Tailwind text color class to allow active color to show
                if (link.classList.contains('text-[#4B5563]')) {
                    link.classList.remove('text-[#4B5563]');
                }
                // Also remove from nav-label span if exists
                const navLabel = link.querySelector('.nav-label');
                if (navLabel && navLabel.classList.contains('text-[#4B5563]')) {
                    navLabel.classList.remove('text-[#4B5563]');
                }
                // Force apply active styles with inline styles for sub-items
                if (link.classList.contains('sub-item')) {
                    link.style.backgroundColor = '#F3F4F6';
                    link.style.color = '#DC6B64';
                    if (navLabel) {
                        navLabel.style.color = '#DC6B64';
                    }
                }
                console.log('[Nav] Set active:', navKey, link);
            } else {
                // Remove active class and inline styles from other links
                link.classList.remove('active');
                if (link.classList.contains('sub-item')) {
                    link.style.backgroundColor = '';
                    link.style.color = '';
                    const navLabel = link.querySelector('.nav-label');
                    if (navLabel) {
                        navLabel.style.color = '';
                    }
                }
            }
        });
        
        // Expand parent section if a sub-item is active
        const activeSubLink = document.querySelector('.nav-link.sub-item.active');
        if (activeSubLink) {
            const parentSection = activeSubLink.closest('.nav-section');
            if (parentSection) {
                parentSection.classList.remove('collapsed');
            }
        }
    }
    
    // Handle click on nav links
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize sidebar state
        const sidebar = document.querySelector('.main-sidebar');
        const mainContent = document.getElementById('main-content');
        if (sidebar && mainContent) {
            setTimeout(function() {
                const marginLeft = window.getComputedStyle(mainContent).marginLeft;
                if (marginLeft === '72px') {
                    sidebar.classList.add('collapsed');
                }
            }, 100);
        }
        
        // Show/hide AI Systems sub menu based on page
        const currentPath = window.location.pathname;
        const currentUrl = window.location.href;
        const aiSystemsSubMenu = document.getElementById('ai-systems-submenu-section');
        
        // Check if we're on the AI systems list page (exact match /ai-systems/)
        const isAISystemsListPage = currentPath.match(/\/ai-systems\/?$/) || 
                                     (currentPath.includes('/ai-systems') && !currentPath.match(/\/ai-systems\/[^\/]+/));
        
        // Check if we're on a specific AI system detail page
        // Detail pages include: multi-agent-use-cases (with or without agent param), assessment, digital-regulations, eu-act pages, risk-overview
        const isAISystemDetailPage = currentPath.includes('/multi-agent-use-cases') ||
                                     ((currentPath.includes('/assessment') && !currentPath.includes('/assessment-library')) && !isAISystemsListPage) ||
                                     (currentPath.includes('/digital-regulations') && !isAISystemsListPage) ||
                                     (currentPath.includes('/eu-act/') && !isAISystemsListPage) ||
                                     (currentPath.includes('/digital-regulations/eu-act/') && !isAISystemsListPage) ||
                                     (currentPath.includes('/risk-overview') && !isAISystemsListPage) ||
                                     (currentUrl.includes('agent=') && (currentPath.includes('/multi-agent-use-cases') || currentPath.includes('/digital-regulations') || currentPath.includes('/eu-act/') || currentPath.includes('/digital-regulations/eu-act/') || currentPath.includes('/risk-overview')));
        
        if (isAISystemsListPage && aiSystemsSubMenu) {
            // Hide sub menu for list page
            aiSystemsSubMenu.classList.add('collapsed');
        } else if (isAISystemDetailPage && aiSystemsSubMenu) {
            // Show sub menu for detail pages
            aiSystemsSubMenu.classList.remove('collapsed');
            // Ensure sidebar is full width
            if (sidebar) {
                sidebar.classList.remove('collapsed');
                if (mainContent) {
                    mainContent.style.marginLeft = '240px';
                }
            }
        } else if (aiSystemsSubMenu) {
            // Default: hide sub menu if not on detail page
            aiSystemsSubMenu.classList.add('collapsed');
        }
        
        // Set active nav item AFTER determining sub menu visibility
        // This will set "Overview" as active when on /multi-agent-use-cases/ page
        setActiveNavItem();
        
        // Verify Overview is active for multi-agent-use-cases page
        const currentPathCheck = window.location.pathname;
        const currentUrlCheck = window.location.href;
        if (currentPathCheck.includes('/multi-agent-use-cases') && currentUrlCheck.includes('agent=')) {
            setTimeout(() => {
                const overviewLink = document.querySelector('[data-nav="overview"]');
                if (overviewLink && !overviewLink.classList.contains('active')) {
                    // Force set active if not already set
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    overviewLink.classList.add('active');
                    console.log('[Nav] Force set Overview as active');
                }
            }, 100);
        }
        
        // Add click handlers to update active state
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // Remove active from all
                navLinks.forEach(l => l.classList.remove('active'));
                // Add active to clicked item
                this.classList.add('active');
            });
        });
        
        // Handle section toggling
        const sectionHeaders = document.querySelectorAll('.nav-section-header');
        sectionHeaders.forEach(header => {
            const toggleButton = header.querySelector('button');
            if (toggleButton) {
                toggleButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const section = header.closest('.nav-section');
                    section.classList.toggle('collapsed');
                });
            }
        });
    });
</script>
